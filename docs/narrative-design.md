# 叙事设计与情感系统

本文档记录 AgentHome 的叙事方向、情感钩子设计思路，以及 NPC 人格系统的规划。

---

## 核心设计哲学

**目标：不做线性剧情，做涌现式叙事。**

传统游戏的情感依附来自手写剧情（星露谷的村民故事）或随机危机中的玩家投入（环世界的殖民者）。AgentHome 的独特优势是**两者融合**：NPC 有连贯的人格记忆，而危机/事件由 God Agent 动态生成——每次重开都有新故事，但每个 NPC 都像真实的人。

---

## 故事开篇设定

### 核心故事前提

> 你受不了大城市的压力，回到乡下农村接手了爷爷留下的小屋和园子，成为了这个与世隔绝的小村子的一部分。你不断经营自己的生活，但随着时间推进，你发现这个村子并不简单——有更大的秘密在等着你。

**为什么这个前提有效：**
- 玩家有明确的空间归属感（爷爷的小屋 = 家）
- "与世隔绝"设定让村子内部关系更紧密，NPC 间的互动更有分量
- 秘密与爷爷相关，玩家天然有挖掘动机（不是局外人，是当事人）
- 表面温馨 vs 底层秘密的张力，让日常经营有了更深的意义层

### 分层揭示节奏（建议）

```
第 1–5 天   →  正常村居生活，NPC 们热情但偶尔回避某些话题
第 6–15 天  →  小异常浮现：某块地从不让人靠近，村民做噩梦，
                老井夜里传来声音，老照片里有陌生人
第 16–30 天 →  随信任度提升，NPC 开始主动透露碎片信息
第 30 天+   →  "真相"揭开，玩家可介入或旁观，结局不固定
```

**"秘密"本体建议**：爷爷当年与村子签了某个协议（保护了村子，但付出了代价），代价的到期日正在临近。这使玩家从旁观者变为当事人。

---

## 情感钩子设计

情感依附的本质：玩家对一个存在**产生了投入**，然后这个存在**需要玩家**。

### 钩子一：NPC 与玩家的关系演变

情感依附不来自第一次见面，来自**关系的变化轨迹**。

设计要求：
- NPC 对玩家有"关系分数"（初始中立，行为改变分数）
- RAG 记忆里记录**对玩家的态度演变**，而不只是事件
- NPC 主动**差异化对待**高好感玩家：主动分享市场信息、赠送物品、说出更深的心里话

示例演变链：
```
Day1: Alice 普通打招呼
Day3: 玩家帮 Alice 买了草药 → Alice 记录"玩家对我友善"
Day8: Alice 主动跑来告诉玩家今天矿石价格很高
Day15: Alice 喝醉后说"其实我一直想离开这里…"（触发秘密碎片）
```

### 钩子二：NPC 有超越"生存"的个人愿望

Stardew Valley 的核心设计：每个村民都有一个与生存无关的小梦想，让他们感觉是"人"而不是功能体。

每个 NPC 在 system prompt 里注入：
- **公开性格**：玩家能直接观察到的行为模式
- **隐藏愿望**：与日常采集/交易无关，偶尔在对话中流露
- **话题禁区**：某些话题会让 NPC 回避或不安（与村子秘密关联）

### 钩子三：危机时刻 NPC 向玩家求助

人只对**需要自己**的存在产生深度依附。

触发条件（由 God Agent 监控世界状态）：
- NPC 能量极低且无食物 → 主动找玩家借粮
- NPC 背包满但无法到交易所 → 请玩家帮忙代售
- NPC 受到其他 NPC 的不公正对待 → 向玩家倾诉
- 天灾导致资源枯竭 → NPC 组织集体向玩家求援

这些事件通过对话弹窗系统触发，玩家的选择会影响关系分数。

### 钩子四：NPC 记得玩家做过的事

最廉价但最有效的情感锚点：NPC 在几天后主动提起玩家之前的帮助。

```
"上次你帮我的忙我一直记着，今天我多采了些草药，你拿着吧。"
```

实现方式：RAG 检索"与玩家的互动记录" → 注入 NPC 执行层 context → NPC 自然流露。

---

## NPC 人格设计模板（4 NPC 示例）

每个 NPC 的 system prompt 应包含以下人格卡：

```
【Alice — 草药师】
公开性格: 热心、好奇、话多，喜欢研究植物
隐藏愿望: 想攒够钱离开村子去大城市学医，但又舍不得老朋友
话题禁区: 村子西边的废弃农庄（表情会变得不自然）
与村子秘密的关系: 知道爷爷留下的那本草药手册里夹着奇怪的地图

【Bob — 矿工】
公开性格: 沉默寡言、可靠，只和熟悉的人多说话
隐藏愿望: 想恢复被废弃的西边矿山，父亲曾在那里工作后失踪
话题禁区: 对爷爷的名字反应奇特，会沉默很久
与村子秘密的关系: 目击过某件事但一直不敢说出来

【Carol — 厨师/商人】
公开性格: 精明、实际，以利益驱动但内心善良
隐藏愿望: 希望村子有更多年轻人留下来，不要继续老去凋零
话题禁区: 村子每隔十年会"消失"一批年轻人（她认为是正常迁移）
与村子秘密的关系: 无意识地维护着某个仪式（认为只是传统）

【Dave — 老人/守夜人】
公开性格: 讲古，神神叨叨，说的话经常听不懂
隐藏愿望: 在有生之年看到秘密被解开，他等了很久了
话题禁区: 实际上没有禁区，但他说的话需要慢慢品
与村子秘密的关系: 知道全部，但只会对真正信任的人透露
```

---

## God Agent 的导演职责

God Agent 不只是控制天气，而是整个叙事的**幕后导演**。

### 叙事进度追踪

God Agent 维护一个内部状态：
```python
narrative_state = {
    "player_trust_level": 0,       # 0-100，基于玩家与NPC的互动深度
    "clues_revealed": [],           # 已揭示的线索碎片列表
    "next_trigger_condition": ...,  # 下一个叙事触发条件
    "secret_stage": 0,              # 0=正常, 1=异常浮现, 2=碎片期, 3=真相
}
```

### 叙事触发事件

当条件成熟时，God Agent 主动触发：

| 条件 | 触发事件 |
|------|---------|
| 玩家与任意NPC好感度 > 30 | NPC 偶然提起爷爷，说了一句奇怪的话 |
| 玩家在村子待满10天 | 夜里地图某处出现短暂的光源 |
| 玩家帮助过 3 个不同 NPC | Dave 开始主动找玩家讲"古老的故事" |
| 玩家探索过废弃农庄 | Bob 当晚找玩家说"你不应该去那里" |
| 玩家信任度 > 60 | Alice 拿出草药手册里的地图碎片 |

### 动态叙事生成

上述表格可以演变为 God Agent 的 LLM 调用：根据当前世界状态，生成"下一个最合适的叙事事件"，而不是硬编码触发条件。这是 P2 阶段的目标。

---

## 与现有架构的对接

### 对话弹窗系统（已规划，P1）
情感钩子三和四需要 NPC→玩家的主动对话，正好对应计划中的对话弹窗系统：
- NPC `talk` 动作 + `target_id = "player"`
- God Agent 生成快速回复选项
- 玩家回复后 NPC inbox 收到消息

### RAG 记忆（已实现基础）
情感钩子四需要 NPC 能检索"与玩家的互动"，需要在 RAG 存储时标注 `is_player_interaction: bool`，检索时优先返回这类记录。

### NPC 人格注入（待实现）
最低成本的改动：在 `build_npc_system_prompt` 里为每个 NPC 加载独立的人格卡 YAML，注入系统提示词。

---

## 对标分析

| 维度 | 星露谷 | 环世界 | AgentHome 目标 |
|------|--------|--------|--------------|
| 情感来源 | 手写剧情 + 礼物系统 | 随机危机 + 玩家投入 | 手写人格 + AI 生成危机 |
| 重玩性 | 内容固定，新鲜感有限 | 高，但无深度叙事 | 每次不同，但有叙事弧 |
| NPC 感觉 | 有独特性，但像程序 | 名字+特质，感觉随机 | 有人格记忆，行为可预测但有深度 |
| 主线 | 社区中心 + 矿山 | 无（涌现） | 爷爷的秘密（分层揭示） |
| 独特优势 | — | — | NPC 真正"记得"玩家 |

---

## 近期可实施的最小改动（高收益）

优先级从高到低：

1. **给每个 NPC 加 3 行人格背景**到 system prompt（隐藏愿望 + 话题禁区）
   - 改动范围：`agents/prompts.py` 或独立人格配置文件
   - 预期效果：NPC 对话立刻有"人味"

2. **NPC 偶尔打破"采集/交易"主题**，聊村子历史或别的 NPC
   - 改动范围：system prompt 行为准则 + 降低 talk 的触发门槛
   - 预期效果：玩家感受到村子有"生活气息"

3. **玩家帮助后 NPC 主动提及**（RAG + 话术模板）
   - 改动范围：RAG 记录标注 + 执行层 context 注入
   - 预期效果：第一次让玩家感受到"NPC 记得我"

4. **God Agent 叙事进度追踪**（简单版：计数器 + 硬编码触发）
   - 改动范围：`agents/god_agent.py` + `game/loop.py`
   - 预期效果：游戏有了"第一条主线的骨架"
