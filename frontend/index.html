<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentHome - LLM æ²™ç›’ä¸–ç•Œ</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #1a1a2e;
    color: #e0e0e0;
    font-family: 'Segoe UI', system-ui, sans-serif;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* â”€â”€ Top bar â”€â”€ */
  #topbar {
    background: #16213e;
    border-bottom: 1px solid #0f3460;
    padding: 6px 12px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }
  #topbar h1 { font-size: 15px; color: #e94560; font-weight: 700; letter-spacing: 1px; }
  .stat-chip {
    background: #0f3460;
    border-radius: 12px;
    padding: 3px 10px;
    font-size: 12px;
    color: #a0c4ff;
  }
  .stat-chip span { color: #fff; font-weight: 600; }
  #ws-status {
    margin-left: auto;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #f44;
    box-shadow: 0 0 6px #f44;
  }
  #ws-status.connected { background: #4f4; box-shadow: 0 0 6px #4f4; }

  /* Token bar */
  #token-bar-wrap {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: #aaa;
  }
  #token-bar {
    width: 100px; height: 8px;
    background: #0f3460;
    border-radius: 4px;
    overflow: hidden;
  }
  #token-fill {
    height: 100%;
    background: linear-gradient(90deg, #4caf50, #ff9800);
    border-radius: 4px;
    transition: width 0.4s;
  }
  #token-fill.danger { background: linear-gradient(90deg, #ff9800, #f44336); }

  /* â”€â”€ Main content â”€â”€ */
  #main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* â”€â”€ Left: Canvas â”€â”€ */
  #canvas-wrap {
    position: relative;
    flex-shrink: 0;
    background: #0d1b2a;
    padding: 8px;
  }
  #world-canvas {
    display: block;
    cursor: crosshair;
    image-rendering: pixelated;
  }
  #canvas-overlay {
    position: absolute;
    top: 8px; left: 8px;
    pointer-events: none;
    font-size: 11px;
    color: rgba(255,255,255,0.7);
    background: rgba(0,0,0,0.4);
    padding: 2px 6px;
    border-radius: 4px;
  }
  #paused-overlay {
    display: none;
    position: absolute;
    top: 8px; left: 8px; right: 8px; bottom: 8px;
    background: rgba(0,0,0,0.75);
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 12px;
    pointer-events: all;
  }
  #paused-overlay.show { display: flex; }
  #paused-overlay h2 { color: #ff9800; font-size: 20px; }
  #paused-overlay p { color: #aaa; font-size: 12px; }

  /* â”€â”€ Right panel â”€â”€ */
  #right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #16213e;
    border-left: 1px solid #0f3460;
    overflow: hidden;
    min-width: 280px;
    max-width: 360px;
  }

  /* Tabs */
  #tabs {
    display: flex;
    background: #0f3460;
    border-bottom: 1px solid #1a4080;
  }
  .tab-btn {
    flex: 1;
    padding: 8px 4px;
    border: none;
    background: transparent;
    color: #aaa;
    font-size: 12px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
  .tab-btn.active { color: #e94560; border-bottom-color: #e94560; }

  .tab-content { display: none; flex: 1; overflow-y: auto; padding: 10px; }
  .tab-content.active { display: flex; flex-direction: column; gap: 8px; }

  /* Panel sections */
  .panel-section {
    background: #0f2540;
    border: 1px solid #1a4080;
    border-radius: 8px;
    padding: 10px;
  }
  .panel-section h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #5c8adf;
    margin-bottom: 8px;
    border-bottom: 1px solid #1a4080;
    padding-bottom: 4px;
  }

  /* Buttons */
  .btn-group { display: flex; gap: 6px; flex-wrap: wrap; }
  .btn {
    padding: 5px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    background: #1a4080;
    color: #c0d8ff;
    border: 1px solid #2a5099;
    transition: all 0.15s;
  }
  .btn:hover { background: #2a5099; color: #fff; }
  .btn.active { background: #e94560; color: #fff; border-color: #e94560; }
  .btn.sunny { border-color: #ffcc02; color: #ffcc02; }
  .btn.sunny:hover { background: #ffcc02; color: #000; }
  .btn.rainy { border-color: #5b9bd5; color: #5b9bd5; }
  .btn.rainy:hover { background: #5b9bd5; color: #fff; }
  .btn.storm { border-color: #9c27b0; color: #9c27b0; }
  .btn.storm:hover { background: #9c27b0; color: #fff; }

  /* God commentary */
  #god-commentary {
    background: #0a1e3a;
    border: 1px solid #2a5099;
    border-radius: 6px;
    padding: 8px 10px;
    font-style: italic;
    color: #a0bfe0;
    font-size: 12px;
    min-height: 36px;
  }

  /* Spawn controls */
  #spawn-info {
    font-size: 11px;
    color: #888;
    margin-top: 6px;
    line-height: 1.6;
  }
  #spawn-pos { color: #a0c4ff; font-weight: 600; }

  /* NPC list */
  .npc-card {
    background: #0a1e3a;
    border: 1px solid #1a4080;
    border-radius: 8px;
    padding: 8px 10px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .npc-card:hover { border-color: #5c8adf; background: #0f2540; }
  .npc-card.selected { border-color: #e94560; }
  .npc-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .npc-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .npc-name { font-weight: 600; font-size: 13px; flex: 1; }
  .npc-pos { font-size: 11px; color: #888; }
  .npc-action-badge {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 8px;
    background: #1a4080;
    color: #a0c4ff;
  }
  .npc-action-badge.talk { background: #1a6040; color: #80ffb0; }
  .npc-action-badge.gather { background: #3a4010; color: #d0f080; }
  .npc-action-badge.trade { background: #402010; color: #ffb060; }
  .npc-action-badge.exchange { background: #403010; color: #ffd060; }
  .npc-action-badge.buy_food { background: #403010; color: #ffd060; }
  .npc-action-badge.sleep { background: #201040; color: #c080ff; }
  .npc-action-badge.eat { background: #3a1010; color: #ff8080; }

  /* Energy bar */
  .energy-bar { height: 4px; background: #1a4080; border-radius: 2px; overflow: hidden; margin: 4px 0; }
  .energy-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

  /* Inventory chips */
  .inv-chips { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
  .inv-chip {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 8px;
    background: #1a3060;
    color: #80a0e0;
  }
  .inv-chip.gold { background: #3a2a00; color: #ffd700; }
  .inv-chip.food { background: #1a3a1a; color: #80ff80; }

  /* NPC message */
  .npc-message {
    font-size: 11px;
    color: #a0bfe0;
    font-style: italic;
    margin-top: 4px;
    padding: 4px 8px;
    background: rgba(255,255,255,0.04);
    border-left: 2px solid #5c8adf;
    border-radius: 0 4px 4px 0;
  }

  /* Settings */
  .setting-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
  .setting-row label { font-size: 11px; color: #aaa; }
  .setting-input {
    background: #0a1e3a;
    border: 1px solid #1a4080;
    border-radius: 6px;
    color: #e0e0e0;
    padding: 6px 10px;
    font-size: 12px;
    width: 100%;
    outline: none;
  }
  .setting-input:focus { border-color: #5c8adf; }
  .api-key-wrap { display: flex; gap: 6px; }
  .api-key-wrap .setting-input { flex: 1; }
  .api-key-status {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 6px;
    margin-top: 4px;
  }
  .api-key-status.set { background: #1a3a1a; color: #80ff80; }
  .api-key-status.unset { background: #3a1a1a; color: #ff8080; }
  select.setting-input { cursor: pointer; }

  /* Slider */
  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    background: #1a4080;
    border-radius: 2px;
    outline: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: #5c8adf;
    cursor: pointer;
  }
  .slider-value { font-size: 11px; color: #a0c4ff; text-align: right; }

  /* â”€â”€ Chat log â”€â”€ */
  #chat-wrap {
    background: #0d1b2a;
    border-top: 1px solid #0f3460;
    display: flex;
    flex-direction: column;
    height: 155px;
    flex-shrink: 0;
  }
  #chat-header {
    display: flex;
    align-items: center;
    padding: 4px 10px;
    background: #16213e;
    border-bottom: 1px solid #0f3460;
    font-size: 11px;
    color: #5c8adf;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  #chat-clear {
    margin-left: auto;
    background: transparent;
    border: none;
    color: #555;
    cursor: pointer;
    font-size: 11px;
  }
  #chat-clear:hover { color: #e94560; }
  #chat-log {
    flex: 1;
    overflow-y: auto;
    padding: 5px 10px;
    font-size: 11px;
    line-height: 1.5;
  }
  .chat-line { padding: 1px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
  .chat-time { color: #555; }
  .chat-talk { color: #a0d0ff; }
  .chat-gather { color: #a0d080; }
  .chat-trade { color: #ffa060; }
  .chat-exchange { color: #ffd060; }
  .chat-sleep { color: #c080ff; }
  .chat-eat { color: #ff8080; }
  .chat-weather { color: #80d0ff; }
  .chat-god { color: #c0a0ff; font-style: italic; }
  .chat-system { color: #555; }
</style>
</head>
<body>

<!-- Top bar -->
<div id="topbar">
  <h1>âš¡ AgentHome</h1>
  <div class="stat-chip">Tick <span id="tick-val">0</span></div>
  <div class="stat-chip"><span id="time-val">Day 1 06:00</span></div>
  <div class="stat-chip"><span id="weather-val">â˜€ æ™´å¤©</span></div>
  <div id="token-bar-wrap">
    <div id="token-bar"><div id="token-fill" style="width:0%"></div></div>
    <span id="token-text">0/200k</span>
  </div>
  <div id="ws-status" title="WebSocket è¿æ¥çŠ¶æ€"></div>
</div>

<!-- Main -->
<div id="main">

  <!-- Canvas area -->
  <div id="canvas-wrap">
    <canvas id="world-canvas" width="600" height="600"></canvas>
    <div id="canvas-overlay"></div>
    <div id="paused-overlay">
      <h2>â¸ å·²æš‚åœï¼ˆToken è¶…é™ï¼‰</h2>
      <p>è¯·å¢åŠ  Token é™é¢åæ¢å¤</p>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="new-limit-input" type="number" class="setting-input" style="width:120px"
               placeholder="æ–°é™é¢" min="10000" step="10000">
        <button class="btn active" onclick="applyNewLimit()">æ¢å¤</button>
      </div>
    </div>
  </div>

  <!-- Right panel -->
  <div id="right-panel">
    <div id="tabs">
      <button class="tab-btn active" onclick="showTab('god')">âš¡ ä¸Šå¸</button>
      <button class="tab-btn" onclick="showTab('npcs')">ğŸ‘¥ NPC</button>
      <button class="tab-btn" onclick="showTab('settings')">âš™ è®¾ç½®</button>
    </div>

    <!-- God Tab -->
    <div id="tab-god" class="tab-content active">
      <div class="panel-section">
        <h3>ğŸŒ¤ å¤©æ°”æ§åˆ¶</h3>
        <div class="btn-group">
          <button class="btn sunny" onclick="setWeather('sunny')">â˜€ æ™´å¤©</button>
          <button class="btn rainy" onclick="setWeather('rainy')">ğŸŒ§ é›¨å¤©</button>
          <button class="btn storm" onclick="setWeather('storm')">â›ˆ æš´é£</button>
        </div>
      </div>

      <div class="panel-section">
        <h3>ğŸ“¦ åˆ·æ–°èµ„æº</h3>
        <div class="btn-group" id="spawn-btns">
          <button class="btn" id="spawn-btn-wood" onclick="selectSpawn('wood',this)">ğŸŒ² æœ¨å¤´</button>
          <button class="btn" id="spawn-btn-stone" onclick="selectSpawn('stone',this)">ğŸª¨ çŸ³å¤´</button>
          <button class="btn" id="spawn-btn-ore" onclick="selectSpawn('ore',this)">ğŸ’ çŸ¿çŸ³</button>
          <button class="btn" id="spawn-btn-food" onclick="selectSpawn('food',this)">ğŸŒ¾ é£Ÿç‰©</button>
        </div>
        <div id="spawn-info">
          é€‰ä¸­èµ„æºç±»å‹åï¼Œ<b>ç‚¹å‡»åœ°å›¾</b>é€‰æ‹©ä½ç½®<br>
          ä½ç½®: <span id="spawn-pos">æœªé€‰æ‹©</span>
          <span id="spawn-confirm-wrap" style="display:none">
            &nbsp;<button class="btn active" onclick="confirmSpawn()" style="padding:2px 10px;font-size:11px">ç¡®è®¤åˆ·æ–°</button>
          </span>
        </div>
      </div>

      <div class="panel-section">
        <h3>ğŸŒ ä¸Šå¸æ—ç™½</h3>
        <div id="god-commentary">ä¸–ç•Œåœ¨æˆ‘çš„æ³¨è§†ä¸‹ç¼“ç¼“è¿è½¬...</div>
      </div>

      <div class="panel-section">
        <h3>ğŸ® æ¸¸æˆæ§åˆ¶</h3>
        <div class="btn-group">
          <button class="btn" onclick="sendControl('pause')">â¸ æš‚åœAI</button>
          <button class="btn" onclick="sendControl('resume')">â–¶ æ¢å¤AI</button>
        </div>
      </div>
    </div>

    <!-- NPC Tab -->
    <div id="tab-npcs" class="tab-content">
      <div id="npc-list"></div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="tab-content">
      <div class="panel-section">
        <h3>ğŸ”‘ Gemini API Key</h3>
        <div class="setting-row">
          <label>API Keyï¼ˆè®¾ç½®åè¦†ç›– .env æ–‡ä»¶ï¼‰</label>
          <div class="api-key-wrap">
            <input type="password" id="api-key-input" class="setting-input" placeholder="AIzaSy...">
            <button class="btn" onclick="toggleApiKeyVisibility()" title="æ˜¾ç¤º/éšè—">ğŸ‘</button>
          </div>
          <div id="api-key-status" class="api-key-status unset">æœªæ£€æµ‹åˆ°ï¼ˆä½¿ç”¨ .env ä¸­çš„å€¼ï¼‰</div>
        </div>
      </div>

      <div class="panel-section">
        <h3>ğŸ¤– æ¨¡å‹</h3>
        <div class="setting-row">
          <label>Gemini æ¨¡å‹åç§°</label>
          <select id="model-select" class="setting-input">
            <option value="gemini-2.5-flash">gemini-2.5-flashï¼ˆæ¨èï¼‰</option>
            <option value="gemini-2.0-flash">gemini-2.0-flash</option>
            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
            <option value="gemini-1.5-pro">gemini-1.5-pro</option>
          </select>
        </div>
      </div>

      <div class="panel-section">
        <h3>ğŸ“Š Token é™é¢</h3>
        <div class="setting-row">
          <label>ä¼šè¯ Token ä¸Šé™</label>
          <input type="range" id="token-limit-slider" min="10000" max="1000000" step="10000" value="200000"
                 oninput="document.getElementById('token-limit-display').textContent=formatNum(this.value)">
          <div class="slider-value"><span id="token-limit-display">200,000</span></div>
        </div>
      </div>

      <button class="btn active" style="width:100%;padding:8px;margin-top:4px" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
      <div id="settings-msg" style="font-size:11px;color:#80ff80;text-align:center;margin-top:6px;display:none"></div>
    </div>
  </div>
</div>

<!-- Chat log -->
<div id="chat-wrap">
  <div id="chat-header">
    ğŸ’¬ ä¸–ç•Œæ—¥å¿—
    <button id="chat-clear" onclick="clearChat()">æ¸…ç©º</button>
  </div>
  <div id="chat-log"></div>
</div>

<script>
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TILE_SIZE = 30;
const COLS = 20, ROWS = 20;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let worldState = null;
let ws = null;
let wsConnected = false;
let spawnType = null;
let spawnPos = null;
let rainDrops = [];

// â”€â”€ Canvas setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('world-canvas');
const ctx = canvas.getContext('2d');

const TILE_COLORS = { g:'#4a8e2a', w:'#3060a0', r:'#6a6a6a', f:'#235a28', o:'#8a6830' };
const RESOURCE_ICONS = { w:'ğŸŒ²', s:'ğŸª¨', o:'ğŸ’', f:'ğŸŒ¾' };
const WEATHER_LABELS = { sunny:'â˜€ æ™´å¤©', rainy:'ğŸŒ§ é›¨å¤©', storm:'â›ˆ æš´é£' };

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    wsConnected = true;
    document.getElementById('ws-status').classList.add('connected');
    addChat('system', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨');
  };
  ws.onmessage = e => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'world_state') onWorldState(msg);
    } catch {}
  };
  ws.onclose = () => {
    wsConnected = false;
    document.getElementById('ws-status').classList.remove('connected');
    addChat('system', 'è¿æ¥æ–­å¼€ï¼Œ3ç§’åé‡è¿...');
    setTimeout(connectWS, 3000);
  };
  ws.onerror = () => ws.close();
}

function sendMsg(data) {
  if (ws && wsConnected) ws.send(JSON.stringify(data));
}

// â”€â”€ World state handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onWorldState(msg) {
  worldState = msg;

  // Topbar
  document.getElementById('tick-val').textContent = msg.tick;
  document.getElementById('time-val').textContent = msg.time.time_str;
  document.getElementById('weather-val').textContent = WEATHER_LABELS[msg.weather] || msg.weather;

  // Token bar
  const u = msg.token_usage;
  if (u) {
    const pct = Math.min(100, u.usage_pct || 0);
    const fill = document.getElementById('token-fill');
    fill.style.width = pct + '%';
    fill.className = pct > 80 ? 'danger' : '';
    document.getElementById('token-text').textContent =
      `${fmtK(u.total_tokens_used)}/${fmtK(u.limit)}`;
    const ov = document.getElementById('paused-overlay');
    if (u.paused) ov.classList.add('show'); else ov.classList.remove('show');
  }

  // God commentary
  if (msg.god && msg.god.commentary) {
    document.getElementById('god-commentary').textContent = msg.god.commentary;
  }

  // Events â†’ chat
  for (const evt of (msg.events || [])) handleEvent(evt, msg.time);

  // NPC list
  renderNPCList(msg.npcs, msg.tick);
}

function handleEvent(evt, time) {
  const t = `[${time.time_str}]`;
  switch (evt.type) {
    case 'npc_spoke':
      addChat('talk', `${t} ${evt.actor}: "${evt.message}"`); break;
    case 'npc_gathered':
      addChat('gather', `${t} ${evt.actor} é‡‡é›†äº† ${evt.amount} ${evt.resource}`); break;
    case 'npc_traded':
      addChat('trade', `${t} ${evt.actor} ä¸ ${evt.with || '?'} äº¤æ˜“`); break;
    case 'npc_exchanged':
      addChat('exchange', `${t} ${evt.actor} åœ¨äº¤æ˜“æ‰€æ¢å¾— ${evt.gold}é‡‘ï¼ˆ${evt.qty}x${evt.item}ï¼‰`); break;
    case 'npc_bought_food':
      addChat('exchange', `${t} ${evt.actor} è´­ä¹°äº† ${evt.qty} é£Ÿç‰©ï¼ŒèŠ±è´¹ ${evt.gold_spent} é‡‘`); break;
    case 'npc_ate':
      addChat('eat', `${t} ${evt.actor} åƒäº†é£Ÿç‰©ï¼Œå›å¤ ${evt.amount} ä½“åŠ›`); break;
    case 'npc_slept':
      addChat('sleep', `${t} ${evt.actor} ç¡è§‰ï¼Œå›å¤ ${evt.amount} ä½“åŠ›`); break;
    case 'weather_changed':
      addChat('weather', `${t} å¤©æ°”å˜ä¸º ${WEATHER_LABELS[evt.weather] || evt.weather}`);
      if (evt.commentary) addChat('god', `ç¥æ˜: "${evt.commentary}"`);
      break;
    case 'resource_spawned':
      addChat('weather', `${t} ä¸Šå¸åœ¨(${evt.x},${evt.y})åˆ·æ–°äº† ${evt.resource_type}`);
      if (evt.commentary) addChat('god', `ç¥æ˜: "${evt.commentary}"`);
      break;
  }
}

// â”€â”€ Chat log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addChat(cls, text) {
  const log = document.getElementById('chat-log');
  const d = document.createElement('div');
  d.className = `chat-line chat-${cls}`;
  d.textContent = text;
  log.appendChild(d);
  while (log.children.length > 200) log.removeChild(log.firstChild);
  log.scrollTop = log.scrollHeight;
}
function clearChat() { document.getElementById('chat-log').innerHTML = ''; }

// â”€â”€ NPC list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNPCList(npcs, tick) {
  if (!npcs) return;
  const c = document.getElementById('npc-list');
  c.innerHTML = '';
  for (const npc of npcs) {
    const energyColor = npc.energy > 60 ? '#4caf50' : npc.energy > 30 ? '#ff9800' : '#f44336';
    const inv = npc.inventory;
    const items = [];
    if (inv.wood)  items.push(`<span class="inv-chip">ğŸŒ²${inv.wood}</span>`);
    if (inv.stone) items.push(`<span class="inv-chip">ğŸª¨${inv.stone}</span>`);
    if (inv.ore)   items.push(`<span class="inv-chip">ğŸ’${inv.ore}</span>`);
    if (inv.food)  items.push(`<span class="inv-chip food">ğŸŒ¾${inv.food}</span>`);
    if (inv.gold)  items.push(`<span class="inv-chip gold">ğŸª™${inv.gold}</span>`);
    const msgAge = tick - npc.last_message_tick;
    const msgHtml = (npc.last_message && msgAge < 10)
      ? `<div class="npc-message">"${npc.last_message.substring(0,80)}"</div>` : '';
    const card = document.createElement('div');
    card.className = 'npc-card';
    card.innerHTML = `
      <div class="npc-header">
        <div class="npc-dot" style="background:${npc.color};box-shadow:0 0 4px ${npc.color}40"></div>
        <div class="npc-name">${npc.name}</div>
        <div class="npc-pos">(${npc.x},${npc.y})</div>
        <div class="npc-action-badge ${npc.last_action}">${npc.is_processing ? 'ğŸ”„' : npc.last_action}</div>
      </div>
      <div class="energy-bar"><div class="energy-fill" style="width:${npc.energy}%;background:${energyColor}"></div></div>
      <div style="font-size:10px;color:#666;margin-bottom:4px">âš¡ ${npc.energy}/100</div>
      <div class="inv-chips">${items.join('')}</div>
      ${msgHtml}
    `;
    c.appendChild(card);
  }
}

// â”€â”€ Canvas rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(state) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (const t of state.tiles) drawTile(t);
  for (const npc of state.npcs) drawNPC(npc, state.tick);
  drawWeather(state.weather);
}

function drawTile(t) {
  const x = t.x * TILE_SIZE, y = t.y * TILE_SIZE;
  const baseColor = TILE_COLORS[t.t] || '#4a8e2a';

  // Spawn selection highlight
  if (spawnPos && spawnPos.x === t.x && spawnPos.y === t.y) {
    ctx.fillStyle = '#ffffffaa';
    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
  }

  ctx.fillStyle = baseColor;
  ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);

  // Subtle grid
  ctx.strokeStyle = 'rgba(0,0,0,0.12)';
  ctx.lineWidth = 0.5;
  ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);

  // Exchange tile: golden icon
  if (t.e) {
    ctx.fillStyle = '#b8960a';
    ctx.fillRect(x+3, y+3, TILE_SIZE-6, TILE_SIZE-6);
    ctx.font = '14px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ğŸ›', x + TILE_SIZE/2, y + TILE_SIZE/2);
    return;
  }

  // Town cobblestone texture (simple grid dots)
  if (t.t === 'o') {
    ctx.fillStyle = 'rgba(255,220,100,0.08)';
    ctx.fillRect(x+1, y+1, TILE_SIZE/2-2, TILE_SIZE/2-2);
    ctx.fillRect(x+TILE_SIZE/2+1, y+TILE_SIZE/2+1, TILE_SIZE/2-2, TILE_SIZE/2-2);
    return;
  }

  // Resource icon
  if (t.r && t.q > 0) {
    const icon = RESOURCE_ICONS[t.r] || '';
    if (icon) {
      ctx.font = '14px serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(icon, x + TILE_SIZE/2, y + TILE_SIZE/2);
      // Quantity dots
      const frac = t.q / (t.mq || 5);
      const dots = Math.ceil(frac * 3);
      ctx.fillStyle = `rgba(255,255,255,${0.3 + frac*0.4})`;
      for (let i = 0; i < dots; i++) ctx.fillRect(x+4+i*5, y+TILE_SIZE-5, 3, 3);
    }
  }
}

function drawNPC(npc, tick) {
  const cx = npc.x * TILE_SIZE + TILE_SIZE/2;
  const cy = npc.y * TILE_SIZE + TILE_SIZE/2;
  const r = 9;

  // Processing animated ring
  if (npc.is_processing) {
    const angle = (Date.now() / 400) % (Math.PI * 2);
    ctx.save();
    ctx.strokeStyle = npc.color;
    ctx.lineWidth = 1.5;
    ctx.setLineDash([4, 3]);
    ctx.lineDashOffset = -(angle * 8);
    ctx.beginPath();
    ctx.arc(cx, cy, r + 5, 0, Math.PI * 2);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.restore();
  }

  // Energy arc
  const ef = npc.energy / 100;
  ctx.beginPath();
  ctx.arc(cx, cy, r + 2, -Math.PI/2, -Math.PI/2 + ef * Math.PI * 2);
  ctx.strokeStyle = ef > 0.6 ? '#4caf50' : ef > 0.3 ? '#ff9800' : '#f44336';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Body
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.fillStyle = npc.color;
  ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.25)';
  ctx.lineWidth = 1;
  ctx.stroke();

  // Letter
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 10px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(npc.name[0], cx, cy);

  // Name label
  ctx.font = '9px sans-serif';
  const nw = ctx.measureText(npc.name).width + 6;
  ctx.fillStyle = 'rgba(0,0,0,0.65)';
  ctx.fillRect(cx - nw/2, cy + r + 1, nw, 11);
  ctx.fillStyle = '#ddd';
  ctx.textAlign = 'center';
  ctx.fillText(npc.name, cx, cy + r + 7);

  // Speech bubble
  const age = tick - npc.last_message_tick;
  if (npc.last_message && age < 8) {
    const alpha = Math.max(0, 1 - age / 8);
    const msg = npc.last_message.substring(0, 22) + (npc.last_message.length > 22 ? 'â€¦' : '');
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.font = '8px sans-serif';
    const mw = Math.min(ctx.measureText(msg).width + 10, 130);
    let bx = cx - mw/2, by = cy - r - 24;
    bx = Math.max(2, Math.min(bx, canvas.width - mw - 2));
    by = Math.max(2, by);
    ctx.fillStyle = 'rgba(15,25,50,0.92)';
    rrect(ctx, bx, by, mw, 14, 3);
    ctx.fill();
    ctx.strokeStyle = npc.color;
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.fillStyle = '#cce8ff';
    ctx.textAlign = 'left';
    ctx.fillText(msg, bx + 5, by + 9);
    ctx.restore();
  }
}

function rrect(c, x, y, w, h, r) {
  c.beginPath();
  c.moveTo(x+r,y); c.lineTo(x+w-r,y); c.arcTo(x+w,y,x+w,y+r,r);
  c.lineTo(x+w,y+h-r); c.arcTo(x+w,y+h,x+w-r,y+h,r);
  c.lineTo(x+r,y+h); c.arcTo(x,y+h,x,y+h-r,r);
  c.lineTo(x,y+r); c.arcTo(x,y,x+r,y,r);
  c.closePath();
}

function initRain(count) {
  rainDrops = Array.from({length: count}, () => ({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    speed: 2 + Math.random() * 3,
    len: 6 + Math.random() * 8,
  }));
}

function drawWeather(weather) {
  if (weather === 'rainy' || weather === 'storm') {
    const cnt = weather === 'storm' ? 120 : 60;
    if (rainDrops.length !== cnt) initRain(cnt);
    ctx.strokeStyle = weather === 'storm'
      ? 'rgba(150,200,255,0.55)' : 'rgba(150,200,255,0.3)';
    ctx.lineWidth = 1;
    for (const d of rainDrops) {
      ctx.beginPath();
      ctx.moveTo(d.x, d.y);
      ctx.lineTo(d.x - d.len*0.3, d.y + d.len);
      ctx.stroke();
      d.x -= d.speed * 0.3; d.y += d.speed;
      if (d.y > canvas.height) { d.y = -10; d.x = Math.random() * canvas.width; }
      if (d.x < 0) d.x = canvas.width;
    }
    if (weather === 'storm') {
      ctx.fillStyle = 'rgba(20,0,50,0.12)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      if (Math.random() < 0.008) {
        ctx.fillStyle = 'rgba(200,220,255,0.25)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }
  } else {
    rainDrops = [];
  }
}

// Animation loop
(function loop() {
  if (worldState) render(worldState);
  requestAnimationFrame(loop);
})();

// â”€â”€ Canvas interaction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
canvas.addEventListener('click', e => {
  if (!spawnType) return;
  const rect = canvas.getBoundingClientRect();
  const sx = canvas.width / rect.width, sy = canvas.height / rect.height;
  const tx = Math.floor((e.clientX - rect.left) * sx / TILE_SIZE);
  const ty = Math.floor((e.clientY - rect.top)  * sy / TILE_SIZE);
  spawnPos = { x: tx, y: ty };
  document.getElementById('spawn-pos').textContent = `(${tx}, ${ty})`;
  document.getElementById('spawn-confirm-wrap').style.display = 'inline';
});

canvas.addEventListener('mousemove', e => {
  if (!worldState) return;
  const rect = canvas.getBoundingClientRect();
  const sx = canvas.width / rect.width, sy = canvas.height / rect.height;
  const tx = Math.floor((e.clientX - rect.left) * sx / TILE_SIZE);
  const ty = Math.floor((e.clientY - rect.top)  * sy / TILE_SIZE);
  const tile = worldState.tiles.find(t => t.x === tx && t.y === ty);
  if (tile) {
    let info = `(${tx},${ty}) ${tile.t}`;
    if (tile.r) info += ` ${RESOURCE_ICONS[tile.r]}Ã—${tile.q}`;
    if (tile.e) info += ' ğŸ›äº¤æ˜“æ‰€';
    document.getElementById('canvas-overlay').textContent = info;
  }
});

// â”€â”€ God controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setWeather(w) {
  sendMsg({ type:'god_command', command:'set_weather', value:w });
}

function selectSpawn(type, btn) {
  spawnType = type; spawnPos = null;
  document.getElementById('spawn-pos').textContent = 'ç‚¹å‡»åœ°å›¾é€‰æ‹©';
  document.getElementById('spawn-confirm-wrap').style.display = 'none';
  document.querySelectorAll('#spawn-btns .btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function confirmSpawn() {
  if (!spawnType || !spawnPos) return;
  sendMsg({ type:'god_command', command:'spawn_resource',
            resource_type:spawnType, x:spawnPos.x, y:spawnPos.y, quantity:5 });
  spawnType = null; spawnPos = null;
  document.getElementById('spawn-pos').textContent = 'æœªé€‰æ‹©';
  document.getElementById('spawn-confirm-wrap').style.display = 'none';
  document.querySelectorAll('#spawn-btns .btn').forEach(b => b.classList.remove('active'));
}

function sendControl(cmd) { sendMsg({ type:'control', command:cmd }); }

function applyNewLimit() {
  const v = parseInt(document.getElementById('new-limit-input').value);
  if (v > 0) {
    sendMsg({ type:'control', command:'set_limit', value:v });
    sendMsg({ type:'control', command:'resume' });
  }
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TAB_NAMES = ['god','npcs','settings'];
function showTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b,i) =>
    b.classList.toggle('active', TAB_NAMES[i] === name));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  if (name === 'settings') loadSettings();
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSettings() {
  try {
    const r = await fetch('/api/settings');
    const d = await r.json();
    const st = document.getElementById('api-key-status');
    st.textContent = d.api_key_set ? 'âœ“ å·²è®¾ç½®' : 'æœªè®¾ç½®ï¼ˆä½¿ç”¨ .env ä¸­çš„å€¼ï¼‰';
    st.className = 'api-key-status ' + (d.api_key_set ? 'set' : 'unset');
    if (d.model_name) {
      const sel = document.getElementById('model-select');
      const opt = [...sel.options].find(o => o.value === d.model_name);
      if (opt) sel.value = d.model_name;
    }
    if (d.token_limit) {
      document.getElementById('token-limit-slider').value = d.token_limit;
      document.getElementById('token-limit-display').textContent = formatNum(d.token_limit);
    }
  } catch {}
}

async function saveSettings() {
  const apiKey = document.getElementById('api-key-input').value.trim();
  const modelName = document.getElementById('model-select').value;
  const tokenLimit = parseInt(document.getElementById('token-limit-slider').value);
  const body = { model_name:modelName, token_limit:tokenLimit };
  if (apiKey) body.api_key = apiKey;
  try {
    const r = await fetch('/api/settings', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body),
    });
    const d = await r.json();
    if (d.ok) {
      const m = document.getElementById('settings-msg');
      m.style.display = 'block';
      m.textContent = 'âœ“ è®¾ç½®å·²ä¿å­˜';
      setTimeout(() => m.style.display='none', 2500);
      if (apiKey) { document.getElementById('api-key-input').value=''; loadSettings(); }
    }
  } catch {}
}

function toggleApiKeyVisibility() {
  const inp = document.getElementById('api-key-input');
  inp.type = inp.type==='password' ? 'text' : 'password';
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatNum(n) { return Number(n).toLocaleString(); }
function fmtK(n) {
  if (n>=1e6) return (n/1e6).toFixed(1)+'M';
  if (n>=1000) return (n/1000).toFixed(0)+'k';
  return String(n);
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connectWS();
</script>
</body>
</html>
