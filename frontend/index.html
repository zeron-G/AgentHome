<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentHome â€” LLMæ²™ç›’ä¸–ç•Œ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f0f1a;--panel:#1a1a2e;--card:#16213e;--border:#2a2a4a;
  --red:#e94560;--gold:#f5a623;--teal:#4ecca3;--text:#e0e0f0;--muted:#8888aa;
  --green:#4caf50;--blue:#2196f3;--purple:#9c27b0;
}
body{background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;font-size:14px;overflow:hidden;height:100vh}
button{cursor:pointer;border:none;border-radius:6px;padding:6px 14px;font-size:13px;transition:all .15s}
input,textarea,select{background:#222240;border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:13px;width:100%}
input[type=color]{padding:2px 4px;height:36px}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--teal)}
textarea{resize:vertical;min-height:60px}
.btn-primary{background:var(--teal);color:#000;font-weight:600}
.btn-primary:hover{background:#3db892}
.btn-red{background:var(--red);color:#fff}
.btn-red:hover{background:#c73a52}
.btn-gold{background:var(--gold);color:#000;font-weight:600}
.btn-gold:hover{background:#d4901f}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover{border-color:var(--teal);color:var(--teal)}

/* â”€â”€â”€ COVER â”€â”€â”€ */
#cover-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
#cover-canvas{position:absolute;inset:0;pointer-events:none}
.cover-content{position:relative;text-align:center}
.cover-logo{font-size:64px;font-weight:900;background:linear-gradient(135deg,var(--teal),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-2px;line-height:1}
.cover-sub{color:var(--muted);font-size:18px;margin:12px 0 48px}
.cover-btns{display:flex;gap:16px;justify-content:center;flex-wrap:wrap}
.cover-btn{padding:14px 36px;font-size:16px;font-weight:600;border-radius:10px}

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:200}
.modal-overlay.open{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:24px;max-width:760px;width:90vw;max-height:88vh;overflow-y:auto}
.modal-title{font-size:20px;font-weight:700;margin-bottom:18px;color:var(--teal)}
.modal-tabs{display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:0}
.modal-tab{background:transparent;border:none;color:var(--muted);padding:8px 18px;font-size:14px;cursor:pointer;border-bottom:2px solid transparent}
.modal-tab.active{color:var(--teal);background:rgba(78,204,163,.1);border-bottom-color:var(--teal)}
.modal-body{display:none}.modal-body.active{display:block}

/* Map editor */
#map-editor-canvas{border:2px solid var(--border);border-radius:8px;cursor:crosshair;display:block;margin:10px auto}
.tile-palette{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.palette-btn{padding:6px 14px;border-radius:6px;border:2px solid transparent;font-size:12px;cursor:pointer;color:#fff}
.palette-btn.active{border-color:#fff !important}

/* NPC cards in modal */
.npc-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px}
.npc-card-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.npc-dot{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#fff}
.npc-card-name{font-size:15px;font-weight:700}
.npc-card-title{color:var(--muted);font-size:12px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.form-group{margin-bottom:10px}
.form-group label{display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
.goals-row{display:flex;flex-direction:column;gap:5px}

/* â”€â”€â”€ GAME SCREEN â”€â”€â”€ */
#game-screen{display:none;flex-direction:column;height:100vh}
#game-screen.visible{display:flex}

/* Header */
#game-header{background:var(--panel);border-bottom:1px solid var(--border);padding:8px 16px;display:flex;align-items:center;gap:14px;flex-shrink:0;min-width:0}
.header-logo{font-weight:800;font-size:15px;background:linear-gradient(90deg,var(--teal),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap}
.header-time{color:var(--gold);font-size:12px;min-width:150px;white-space:nowrap}
.header-weather{font-size:18px}
#token-bar-wrap{flex:1;max-width:260px;min-width:100px}
.token-label{font-size:10px;color:var(--muted);margin-bottom:2px}
.progress-track{height:5px;background:#333355;border-radius:3px;overflow:hidden}
.progress-fill{height:100%;background:var(--teal);border-radius:3px;transition:width .4s}
.progress-fill.warn{background:var(--gold)}.progress-fill.danger{background:var(--red)}
#btn-sim{padding:6px 16px;font-size:12px;font-weight:600;white-space:nowrap}
.btn-home{background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px 6px}
.btn-home:hover{color:var(--text)}

/* Main area */
#main-area{display:flex;flex:1;overflow:hidden;min-height:0}
#canvas-wrap{position:relative;background:#0a0a15;overflow:hidden;flex-shrink:0}
#world-canvas{display:block}
#canvas-status{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.6);color:var(--muted);font-size:11px;padding:3px 8px;pointer-events:none}

/* Side panel */
#side-panel{width:340px;flex-shrink:0;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.side-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.side-tab{flex:1;background:transparent;border:none;color:var(--muted);padding:9px 2px;font-size:11px;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.side-tab:hover{color:var(--text);background:rgba(255,255,255,.03)}
.side-tab.active{color:var(--teal);border-bottom-color:var(--teal)}
.side-content{flex:1;overflow-y:auto;padding:12px}
.side-content::-webkit-scrollbar{width:4px}
.side-content::-webkit-scrollbar-thumb{background:#333355;border-radius:2px}

/* NPC panel cards */
.npc-panel-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px}
.npc-panel-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.npc-mini-dot{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:#fff;flex-shrink:0}
.npc-panel-name{font-size:14px;font-weight:700;flex:1}
.npc-title-badge{font-size:10px;background:rgba(78,204,163,.15);color:var(--teal);padding:2px 6px;border-radius:4px}
.energy-bar-wrap{margin:4px 0 6px}
.energy-label{font-size:11px;color:var(--muted);margin-bottom:2px}
.energy-track{height:5px;background:#333355;border-radius:3px;overflow:hidden}
.energy-fill{height:100%;border-radius:3px;transition:width .3s}
.last-msg{font-style:italic;color:var(--text);font-size:12px;margin-top:4px;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.npc-expand-btn{background:transparent;border:none;color:var(--muted);font-size:11px;cursor:pointer;padding:2px 0;margin-top:4px}
.npc-expand-btn:hover{color:var(--teal)}
.npc-details{display:none;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.npc-details.open{display:block}
.inv-chips{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px}
.inv-chip{background:#222240;padding:2px 5px;border-radius:4px;font-size:10px}
.inv-chip.nz{color:var(--gold)}
.proposal-badge{background:rgba(233,69,96,.2);color:var(--red);font-size:10px;padding:2px 6px;border-radius:4px}

/* Economy */
.section-title{font-size:12px;font-weight:700;color:var(--teal);margin:10px 0 8px;text-transform:uppercase;letter-spacing:.3px}
.market-table{width:100%;border-collapse:collapse;font-size:12px}
.market-table th{text-align:left;padding:4px 5px;color:var(--muted);border-bottom:1px solid var(--border)}
.market-table td{padding:4px 5px;border-bottom:1px solid rgba(42,42,74,.4)}
.market-table tr.up td{color:#ffaaaa}.market-table tr.down td{color:#aaccff}
.trend-up{color:#ff6666}.trend-down{color:#66aaff}.trend-flat{color:var(--muted)}
#price-chart-canvas{width:100%;border-radius:6px;background:#111128;display:block;margin-top:6px}
.trade-log{max-height:140px;overflow-y:auto;font-size:11px}
.trade-log-item{padding:3px 0;border-bottom:1px solid rgba(42,42,74,.4);color:var(--muted)}
.tli-sell{color:#aaffaa}.tli-buy{color:#aaccff}.tli-craft{color:#ffdd99}.tli-accept{color:var(--teal)}

/* Controls */
.weather-btns{display:flex;gap:8px;margin-bottom:14px}
.weather-btn{flex:1;padding:8px;font-size:14px;border-radius:8px;background:var(--card);border:1px solid var(--border);cursor:pointer;transition:all .15s}
.weather-btn:hover,.weather-btn.active-weather{border-color:var(--teal);background:rgba(78,204,163,.1)}
.spawn-row{display:flex;gap:8px;align-items:flex-end;margin-bottom:8px}
.spawn-row select{flex:2}.spawn-row input[type=number]{flex:1}
#god-commentary{background:var(--card);border-left:3px solid var(--purple);padding:10px;font-style:italic;color:var(--muted);border-radius:0 6px 6px 0;font-size:12px;min-height:38px;margin-bottom:14px}
.coord-display{font-size:11px;color:var(--muted);margin-bottom:10px}

/* Settings */
.settings-group{background:var(--card);border-radius:8px;padding:12px;margin-bottom:12px}
.settings-group-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.setting-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.setting-row label{flex:1;font-size:12px;color:var(--muted)}
.setting-row input[type=range]{flex:1;accent-color:var(--teal)}
.setting-val{min-width:36px;text-align:right;font-size:12px}
.toggle-wrap{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.toggle{width:38px;height:20px;background:#333355;border-radius:10px;position:relative;cursor:pointer;border:none;transition:background .2s;flex-shrink:0}
.toggle.on{background:var(--teal)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .2s}
.toggle.on::after{left:20px}
.provider-tabs{display:flex;gap:6px;margin-bottom:10px}
.provider-tab{flex:1;padding:6px;text-align:center;border-radius:6px;border:1px solid var(--border);cursor:pointer;font-size:12px;background:transparent;color:var(--muted);transition:all .15s}
.provider-tab.active{background:rgba(78,204,163,.12);border-color:var(--teal);color:var(--teal)}
.api-key-wrap{display:flex;gap:6px}
.api-key-wrap input{flex:1}
.danger-zone{background:rgba(233,69,96,.08);border:1px solid rgba(233,69,96,.3);border-radius:8px;padding:12px;margin-bottom:12px}

/* Player bar */
#player-bar{background:var(--panel);border-top:1px solid var(--border);padding:8px 14px;display:none;flex-shrink:0;align-items:center;gap:10px;flex-wrap:wrap}
#player-bar.visible{display:flex}
.player-stat{font-size:12px;color:var(--muted);white-space:nowrap}
.player-stat b{color:var(--gold)}
.dpad{display:grid;grid-template-columns:repeat(3,26px);grid-template-rows:repeat(3,26px);gap:2px}
.dpad button{width:26px;height:26px;background:var(--card);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px;padding:0}
.dpad button:hover{border-color:var(--teal)}
.dpad .blank{background:transparent;border:none;pointer-events:none}
.talk-wrap{display:flex;gap:5px;align-items:center}
.talk-wrap input{width:120px}

/* Event log */
#event-log-wrap{background:var(--panel);border-top:1px solid var(--border);flex-shrink:0}
.event-log-header{display:flex;align-items:center;justify-content:space-between;padding:3px 12px;border-bottom:1px solid var(--border);cursor:pointer;-webkit-user-select:none;user-select:none}
.event-log-header span{font-size:11px;color:var(--muted)}
#event-log{height:72px;overflow-y:auto;padding:3px 12px}
#event-log.collapsed{display:none}
#event-log::-webkit-scrollbar{width:4px}
#event-log::-webkit-scrollbar-thumb{background:#333355;border-radius:2px}
.log-entry{font-size:11px;padding:1px 0;border-bottom:1px solid rgba(42,42,74,.25);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.log-talk{color:var(--teal)}.log-trade{color:var(--gold)}.log-gather{color:#8bc34a}
.log-weather{color:#aa88ff}.log-market{color:#6699ff}.log-craft{color:#ffbb66}.log-default{color:var(--muted)}

/* Scrollbars */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#333355;border-radius:3px}

/* â”€â”€â”€ DIALOGUE MODAL â”€â”€â”€ */
#dialogue-modal{position:fixed;right:16px;bottom:80px;width:320px;background:var(--panel);border:1px solid var(--teal);border-radius:12px;padding:14px;z-index:150;display:none;box-shadow:0 4px 24px rgba(0,0,0,.6)}
#dialogue-modal.open{display:block}
.dialogue-from{font-size:12px;color:var(--teal);font-weight:700;margin-bottom:4px}
.dialogue-msg{font-size:13px;color:var(--text);background:var(--card);border-radius:8px;padding:8px;margin-bottom:10px;line-height:1.5}
.dialogue-options{display:flex;flex-direction:column;gap:5px;margin-bottom:8px}
.dialogue-opt{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:12px;text-align:left;cursor:pointer;transition:all .15s}
.dialogue-opt:hover{border-color:var(--teal);color:var(--teal)}
.dialogue-custom{display:flex;gap:6px;margin-top:4px}
.dialogue-custom input{flex:1;font-size:12px}
.dialogue-loading{color:var(--muted);font-size:12px;font-style:italic;padding:4px 0}

/* â”€â”€â”€ PLAYER EQUIPMENT â”€â”€â”€ */
.eq-badge{display:inline-flex;align-items:center;gap:3px;background:rgba(78,204,163,.15);border:1px solid rgba(78,204,163,.3);border-radius:5px;padding:2px 7px;font-size:11px;color:var(--teal);white-space:nowrap}
.inv-badge{display:inline-flex;align-items:center;gap:3px;background:rgba(245,166,35,.12);border:1px solid rgba(245,166,35,.25);border-radius:5px;padding:2px 7px;font-size:11px;color:var(--gold);white-space:nowrap}
.action-btns{display:flex;gap:4px;flex-wrap:wrap}
.action-btns button{font-size:11px;padding:4px 9px;border-radius:5px;background:var(--card);border:1px solid var(--border);color:var(--text);cursor:pointer;white-space:nowrap}
.action-btns button:hover{border-color:var(--teal);color:var(--teal)}

/* â”€â”€â”€ FURNITURE ICONS on NPC card â”€â”€â”€ */
.furniture-icon{font-size:10px;color:#aaffaa}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• COVER SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="cover-screen">
  <canvas id="cover-canvas"></canvas>
  <div class="cover-content">
    <div class="cover-logo">AgentHome</div>
    <div class="cover-sub">LLMé©±åŠ¨çš„AIæ²™ç›’ä¸–ç•Œ</div>
    <div class="cover-btns">
      <button class="cover-btn btn-primary" onclick="openNewGameModal()">ğŸ® æ–°æ¸¸æˆ</button>
      <button class="cover-btn btn-gold" onclick="openLoadModal()">ğŸ“ è¯»å–å­˜æ¡£</button>
      <button class="cover-btn btn-ghost" onclick="quickStart()">âš¡ å¿«é€Ÿå¼€å§‹</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• NEW GAME MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="new-game-modal">
  <div class="modal">
    <div class="modal-title">ğŸ® æ–°æ¸¸æˆè®¾ç½®</div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchNewTab('map',0)">ğŸ—ºï¸ åœ°å›¾è®¾ç½®</button>
      <button class="modal-tab" onclick="switchNewTab('npc',1)">ğŸ‘¥ NPCæ¡£æ¡ˆ</button>
    </div>
    <!-- Map tab -->
    <div class="modal-body active" id="new-tab-map">
      <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:12px">
        <div class="form-group" style="margin:0;flex:1"><label>ä¸–ç•Œç§å­</label><input type="number" id="seed-input" value="42"></div>
        <button class="btn-ghost" onclick="randomSeed()">ğŸ² éšæœº</button>
      </div>
      <div class="tile-palette">
        <button class="palette-btn active" style="background:#3d7a24" data-tile="grass" onclick="selectPalette(this,'grass')">è‰åœ°</button>
        <button class="palette-btn" style="background:#555" data-tile="rock" onclick="selectPalette(this,'rock')">å²©çŸ³</button>
        <button class="palette-btn" style="background:#1e5c2c" data-tile="forest" onclick="selectPalette(this,'forest')">æ£®æ—</button>
        <button class="palette-btn" style="background:#8b6914" data-tile="town" onclick="selectPalette(this,'town')">åŸé•‡</button>
        <button class="palette-btn" style="background:#1565c0" data-tile="water" onclick="selectPalette(this,'water')">æ°´åŸŸ</button>
      </div>
      <canvas id="map-editor-canvas" width="400" height="400"></canvas>
      <div style="text-align:center;margin-top:12px">
        <button class="btn-primary" style="padding:10px 40px;font-size:15px" onclick="startGame()">â–¶ å¼€å§‹æ¸¸æˆ</button>
        <button class="btn-ghost" style="margin-left:10px" onclick="closeModal('new-game-modal')">å–æ¶ˆ</button>
      </div>
    </div>
    <!-- NPC tab -->
    <div class="modal-body" id="new-tab-npc">
      <div style="display:flex;gap:8px;margin-bottom:14px">
        <button class="btn-ghost" style="font-size:12px" onclick="exportProfiles()">ğŸ“¤ å¯¼å‡ºå…¨éƒ¨</button>
        <label class="btn-ghost" style="display:inline-flex;align-items:center;padding:6px 14px;font-size:12px;cursor:pointer">
          ğŸ“¥ å¯¼å…¥JSON <input type="file" accept=".json" style="display:none" onchange="importProfiles(this)">
        </label>
      </div>
      <div id="npc-profile-cards">
        <div style="color:var(--muted);text-align:center;padding:20px">åŠ è½½ä¸­â€¦</div>
      </div>
      <div style="text-align:center;margin-top:12px">
        <button class="btn-primary" style="padding:10px 40px;font-size:15px" onclick="startGame()">â–¶ å¼€å§‹æ¸¸æˆ</button>
        <button class="btn-ghost" style="margin-left:10px" onclick="closeModal('new-game-modal')">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• LOAD MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="load-modal">
  <div class="modal" style="max-width:480px">
    <div class="modal-title">ğŸ“ è¯»å–å­˜æ¡£</div>
    <div id="save-list"><div style="color:var(--muted);text-align:center;padding:20px">åŠ è½½ä¸­â€¦</div></div>
    <div style="margin-top:14px;display:flex;justify-content:space-between;gap:10px">
      <button class="btn-red" onclick="deleteAllSaves()">ğŸ—‘ åˆ é™¤æ‰€æœ‰å­˜æ¡£</button>
      <button class="btn-ghost" onclick="closeModal('load-modal')">å…³é—­</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• NPC EDIT MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="npc-edit-modal">
  <div class="modal" style="max-width:500px">
    <div class="modal-title">âœï¸ ç¼–è¾‘NPCæ¡£æ¡ˆ</div>
    <input type="hidden" id="edit-npc-id">
    <div class="form-row">
      <div class="form-group"><label>åå­—</label><input id="edit-name"></div>
      <div class="form-group"><label>é¢œè‰²</label><input type="color" id="edit-color"></div>
    </div>
    <div class="form-group"><label>ç§°å·</label><input id="edit-title"></div>
    <div class="form-group"><label>èƒŒæ™¯æ•…äº‹</label><textarea id="edit-backstory" rows="3"></textarea></div>
    <div class="form-group"><label>æ€§æ ¼</label><textarea id="edit-personality" rows="2"></textarea></div>
    <div class="form-group"><label>ç›®æ ‡ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label><textarea id="edit-goals" rows="3" placeholder="ç›®æ ‡1&#10;ç›®æ ‡2&#10;ç›®æ ‡3"></textarea></div>
    <div class="form-group"><label>è¯´è¯é£æ ¼</label><input id="edit-speech-style"></div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn-primary" style="flex:1" onclick="saveNPCEdit()">ğŸ’¾ ä¿å­˜</button>
      <button class="btn-ghost" onclick="closeModal('npc-edit-modal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game-screen">

  <!-- HEADER -->
  <div id="game-header">
    <div class="header-logo">AgentHome</div>
    <div class="header-time" id="header-time">Day 1 06:00 Â· æ™¨</div>
    <div class="header-weather" id="header-weather">â˜€ï¸</div>
    <div id="token-bar-wrap">
      <div class="token-label" id="token-label">0 / 0 tokens</div>
      <div class="progress-track"><div class="progress-fill" id="token-fill" style="width:0%"></div></div>
    </div>
    <button id="btn-sim" class="btn-primary" onclick="toggleSim()">â–¶ å¼€å§‹</button>
    <button class="btn-home" title="è¿”å›å°é¢" onclick="backToCover()">âŒ‚</button>
  </div>

  <!-- MAIN AREA -->
  <div id="main-area">
    <!-- Canvas -->
    <div id="canvas-wrap">
      <canvas id="world-canvas"></canvas>
      <div id="canvas-status">åŒå‡»åœ°å›¾è®¾ç½®èµ„æºç”Ÿæˆåæ ‡</div>
    </div>
    <!-- Side panel -->
    <div id="side-panel">
      <div class="side-tabs">
        <button class="side-tab active" data-tab="npc" onclick="switchTab('npc',this)">ğŸ‘¥ NPC</button>
        <button class="side-tab" data-tab="eco" onclick="switchTab('eco',this)">ğŸ“Š ç»æµ</button>
        <button class="side-tab" data-tab="ctrl" onclick="switchTab('ctrl',this)">ğŸ® æ§åˆ¶</button>
        <button class="side-tab" data-tab="settings" onclick="switchTab('settings',this)">âš™ï¸ è®¾ç½®</button>
      </div>

      <!-- NPC TAB -->
      <div class="side-content" id="tab-npc"></div>

      <!-- ECONOMY TAB -->
      <div class="side-content" id="tab-eco" style="display:none">
        <div class="section-title">ğŸ’° å¸‚åœºä»·æ ¼</div>
        <table class="market-table">
          <thead><tr><th>ç‰©å“</th><th>å½“å‰ä»·</th><th>åŸºå‡†</th><th>è¶‹åŠ¿</th><th>å˜åŒ–%</th></tr></thead>
          <tbody id="market-tbody"></tbody>
        </table>
        <div class="section-title" style="margin-top:12px">ğŸ“ˆ ä»·æ ¼å†å²</div>
        <select id="chart-item-sel" style="width:100%;margin-bottom:8px" onchange="drawPriceChart()">
          <option value="wood">æœ¨å¤´</option><option value="stone">çŸ³å¤´</option>
          <option value="ore">çŸ¿çŸ³</option><option value="food">é£Ÿç‰©</option>
          <option value="herb">è‰è¯</option><option value="rope">ç»³ç´¢</option>
          <option value="potion">è¯æ°´</option><option value="tool">å·¥å…·</option>
          <option value="bread">é¢åŒ…</option>
        </select>
        <canvas id="price-chart-canvas" width="300" height="140"></canvas>
        <div class="section-title" style="margin-top:12px">ğŸ“‹ æœ€è¿‘äº¤æ˜“</div>
        <div class="trade-log" id="trade-log"></div>
      </div>

      <!-- CONTROLS TAB -->
      <div class="side-content" id="tab-ctrl" style="display:none">
        <div class="section-title">ğŸŒ¤ï¸ å¤©æ°”æ§åˆ¶</div>
        <div class="weather-btns">
          <button class="weather-btn" data-w="sunny" onclick="setWeather('sunny')">â˜€ï¸ æ™´å¤©</button>
          <button class="weather-btn" data-w="rainy" onclick="setWeather('rainy')">ğŸŒ§ï¸ é›¨å¤©</button>
          <button class="weather-btn" data-w="storm" onclick="setWeather('storm')">â›ˆï¸ æš´é£</button>
        </div>
        <div class="section-title">âœ¨ èµ„æºç”Ÿæˆ</div>
        <div class="spawn-row">
          <select id="spawn-res-type">
            <option value="wood">æœ¨å¤´</option><option value="stone">çŸ³å¤´</option>
            <option value="ore">çŸ¿çŸ³</option><option value="food">é£Ÿç‰©</option>
            <option value="herb">è‰è¯</option>
          </select>
          <input type="number" id="spawn-qty" value="5" min="1" max="10" style="width:56px">
          <button class="btn-primary" onclick="spawnResource()">âœ¨ ç”Ÿæˆ</button>
        </div>
        <div class="coord-display" id="spawn-coord">åŒå‡»åœ°å›¾é€‰æ‹©ç›®æ ‡åæ ‡</div>
        <div class="section-title">ğŸ’¬ ç¥æ˜æ—ç™½</div>
        <div id="god-commentary">ä¸–ç•Œåœ¨æˆ‘çš„æ³¨è§†ä¸‹ç¼“ç¼“è¿è½¬...</div>
        <div class="section-title" style="margin-top:14px">â±ï¸ ä»¿çœŸæ§åˆ¶</div>
        <button id="btn-sim2" class="btn-primary" style="width:100%;padding:10px;margin-bottom:8px" onclick="toggleSim()">â–¶ å¼€å§‹ä»¿çœŸ</button>
      </div>

      <!-- SETTINGS TAB -->
      <div class="side-content" id="tab-settings" style="display:none">
        <div class="settings-group">
          <div class="settings-group-title">LLM é…ç½®</div>
          <div class="provider-tabs">
            <button class="provider-tab active" id="prov-gemini" onclick="setProvider('gemini')">â˜ï¸ Gemini</button>
            <button class="provider-tab" id="prov-local" onclick="setProvider('local')">ğŸ–¥ï¸ æœ¬åœ°LLM</button>
          </div>
          <div id="gemini-fields">
            <div class="form-group"><label>API Key</label>
              <div class="api-key-wrap">
                <input type="password" id="api-key-input" placeholder="AIza...">
                <button class="btn-ghost" style="padding:6px 10px;flex-shrink:0" onclick="toggleApiVis()">ğŸ‘</button>
              </div>
            </div>
            <div class="form-group"><label>æ¨¡å‹åç§°</label><input id="model-name-input" placeholder="gemini-1.5-flash"></div>
          </div>
          <div id="local-fields" style="display:none">
            <div class="form-group"><label>Base URL</label><input id="local-url-input" placeholder="http://localhost:11434/v1"></div>
            <div class="form-group"><label>æ¨¡å‹åç§°</label><input id="local-model-input" placeholder="qwen2.5:7b"></div>
          </div>
          <button class="btn-primary" style="width:100%;margin-top:6px" onclick="saveLLMSettings()">ğŸ’¾ ä¿å­˜LLMè®¾ç½®</button>
        </div>

        <div class="settings-group">
          <div class="settings-group-title">Token é™åˆ¶</div>
          <div class="setting-row">
            <label>Sessionä¸Šé™</label>
            <input type="range" id="sl-token" min="10000" max="1000000" step="10000" oninput="slVal('sv-token',this.value/1000,'k')">
            <span class="setting-val" id="sv-token">100k</span>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-group-title">æ¸¸æˆé€Ÿåº¦</div>
          <div class="setting-row">
            <label>ä¸–ç•ŒTické—´éš”(s)</label>
            <input type="range" id="sl-world-tick" min="1" max="10" step="0.5" oninput="slVal('sv-world-tick',this.value,'s')">
            <span class="setting-val" id="sv-world-tick">3s</span>
          </div>
          <div class="setting-row">
            <label>NPCæœ€çŸ­æ€è€ƒ(s)</label>
            <input type="range" id="sl-npc-min" min="1" max="20" step="1" oninput="slVal('sv-npc-min',this.value,'s')">
            <span class="setting-val" id="sv-npc-min">3s</span>
          </div>
          <div class="setting-row">
            <label>NPCæœ€é•¿æ€è€ƒ(s)</label>
            <input type="range" id="sl-npc-max" min="5" max="60" step="1" oninput="slVal('sv-npc-max',this.value,'s')">
            <span class="setting-val" id="sv-npc-max">8s</span>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-group-title">NPC å‚æ•°</div>
          <div class="setting-row">
            <label>è§†é‡åŠå¾„</label>
            <input type="range" id="sl-vision" min="1" max="5" step="1" oninput="slVal('sv-vision',this.value,'')">
            <span class="setting-val" id="sv-vision">2</span>
          </div>
          <div class="setting-row">
            <label>ç¤¾äº¤åŠå¾„</label>
            <input type="range" id="sl-hearing" min="3" max="12" step="1" oninput="slVal('sv-hearing',this.value,'')">
            <span class="setting-val" id="sv-hearing">6</span>
          </div>
          <div class="toggle-wrap">
            <label style="font-size:12px;color:var(--muted);flex:1">æ˜¾ç¤ºNPCå†…å¿ƒæƒ³æ³•</label>
            <button class="toggle" id="toggle-thoughts" onclick="this.classList.toggle('on')"></button>
          </div>
          <button class="btn-primary" style="width:100%;margin-top:6px" onclick="saveGameSettings()">ğŸ’¾ ä¿å­˜æ¸¸æˆè®¾ç½®</button>
        </div>

        <div class="danger-zone">
          <div class="settings-group-title" style="color:var(--red);margin-bottom:8px">å±é™©æ“ä½œ</div>
          <button class="btn-red" style="width:100%;margin-bottom:8px" onclick="deleteAllSaves()">ğŸ—‘ åˆ é™¤æ‰€æœ‰å­˜æ¡£</button>
          <button class="btn-ghost" style="width:100%" onclick="backToCover()">âŒ‚ è¿”å›å°é¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PLAYER BAR -->
  <div id="player-bar">
    <div class="player-stat">ğŸ‘¤ <b id="pname">Player</b></div>
    <div class="player-stat">â¤ï¸ <b id="penergy">100</b></div>
    <div class="player-stat">ğŸ“ <b id="ppos">(9,9)</b></div>
    <span class="eq-badge" id="p-equipped-badge" title="è£…å¤‡æ§½">âš” ç©º</span>
    <span class="inv-badge" id="p-inv-badge" title="èƒŒåŒ…">ğŸ’ 0/20</span>
    <div class="dpad">
      <div class="blank"></div>
      <button onclick="playerMove(0,-1)" title="ä¸Š (W/â†‘)">â–²</button>
      <div class="blank"></div>
      <button onclick="playerMove(-1,0)" title="å·¦ (A/â†)">â—€</button>
      <div class="blank"></div>
      <button onclick="playerMove(1,0)" title="å³ (D/â†’)">â–¶</button>
      <div class="blank"></div>
      <button onclick="playerMove(0,1)" title="ä¸‹ (S/â†“)">â–¼</button>
      <div class="blank"></div>
    </div>
    <div class="action-btns">
      <button onclick="sendWS({type:'player_action',action:'gather'})" title="(G)">â› é‡‡é›†</button>
      <button onclick="sendWS({type:'player_action',action:'eat'})" title="(F)">ğŸ åƒ</button>
      <button onclick="sendWS({type:'player_action',action:'rest'})" title="ä¼‘æ¯">ğŸ’¤ ä¼‘æ¯</button>
      <button onclick="showCraftPanel()" title="åˆ¶é€ ">ğŸ”¨ åˆ¶é€ </button>
      <button onclick="showEquipPanel()" title="è£…å¤‡">âš” è£…å¤‡</button>
      <button onclick="showBuildPanel()" title="å»ºé€ ">ğŸ— å»ºé€ </button>
    </div>
    <div class="talk-wrap">
      <select id="player-talk-target" style="width:90px;font-size:12px">
        <option value="">å¹¿æ’­</option>
      </select>
      <input id="player-talk-input" placeholder="è¯´è¯â€¦" onkeydown="if(event.key==='Enter')playerTalk()">
      <button class="btn-ghost" style="font-size:12px" onclick="playerTalk()">å‘é€</button>
    </div>
  </div>

  <!-- EVENT LOG -->
  <div id="event-log-wrap">
    <div class="event-log-header" onclick="toggleLog()">
      <span>ğŸ“œ äº‹ä»¶æ—¥å¿—</span>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="log-toggle-lbl" style="font-size:11px;color:var(--muted)">â–² æŠ˜å </span>
        <button class="btn-ghost" style="font-size:10px;padding:2px 8px" onclick="event.stopPropagation();clearLog()">æ¸…ç©º</button>
      </div>
    </div>
    <div id="event-log"></div>
  </div>

  <!-- DIALOGUE MODAL -->
  <div id="dialogue-modal">
    <div class="dialogue-from" id="dlg-from">ğŸ’¬ NPC</div>
    <div class="dialogue-msg" id="dlg-msg"></div>
    <div class="dialogue-options" id="dlg-options">
      <div class="dialogue-loading">â³ ç”Ÿæˆå›å¤é€‰é¡¹ä¸­â€¦</div>
    </div>
    <div class="dialogue-custom">
      <input id="dlg-custom-input" placeholder="è‡ªå®šä¹‰å›å¤â€¦" onkeydown="if(event.key==='Enter')sendDialogueCustom()">
      <button class="btn-primary" style="font-size:12px;padding:4px 10px" onclick="sendDialogueCustom()">å‘é€</button>
      <button class="btn-ghost" style="font-size:11px;padding:4px 8px" onclick="dismissDialogue()">âœ•</button>
    </div>
  </div>

</div><!-- /game-screen -->

<script>
// â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•
const S = {
  world: null,
  simRunning: false,
  activeTab: 'npc',
  spawnTarget: null,
  tradeLog: [],
  logOpen: true,
  provider: 'gemini',
  activePalette: 'grass',
  profileCache: {},
};

// â•â•â•â•â•â•â•â• COVER PARTICLES â•â•â•â•â•â•â•â•
(function(){
  const canvas = document.getElementById('cover-canvas');
  const ctx = canvas.getContext('2d');
  let pts = [];
  function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
  resize(); window.addEventListener('resize',resize);
  for(let i=0;i<90;i++) pts.push({x:Math.random(),y:Math.random(),vx:(Math.random()-.5)*.00015,vy:(Math.random()-.5)*.00015,r:Math.random()*2+.5,a:Math.random()*.7+.1});
  function tick(){
    const coverVisible = document.getElementById('cover-screen').style.display !== 'none'
      && !document.getElementById('cover-screen').classList.contains('hidden');
    if(coverVisible || document.getElementById('cover-screen').offsetParent !== null){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      pts.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<0)p.x=1; if(p.x>1)p.x=0;
        if(p.y<0)p.y=1; if(p.y>1)p.y=0;
        ctx.beginPath();
        ctx.arc(p.x*canvas.width,p.y*canvas.height,p.r,0,Math.PI*2);
        ctx.fillStyle=`rgba(78,204,163,${p.a*.5})`;
        ctx.fill();
      });
      // Draw lines between close pts
      for(let i=0;i<pts.length;i++) for(let j=i+1;j<pts.length;j++){
        const dx=(pts[i].x-pts[j].x)*canvas.width, dy=(pts[i].y-pts[j].y)*canvas.height;
        const d=Math.sqrt(dx*dx+dy*dy);
        if(d<80){
          ctx.beginPath();
          ctx.moveTo(pts[i].x*canvas.width,pts[i].y*canvas.height);
          ctx.lineTo(pts[j].x*canvas.width,pts[j].y*canvas.height);
          ctx.strokeStyle=`rgba(78,204,163,${(.8-d/80)*.15})`;
          ctx.lineWidth=.5; ctx.stroke();
        }
      }
    }
    requestAnimationFrame(tick);
  }
  tick();
})();

// â•â•â•â•â•â•â•â• MAP EDITOR â•â•â•â•â•â•â•â•
const ED = 20, TSIZE = 20;
const TILE_COLORS = {grass:'#3d7a24',rock:'#555',forest:'#1e5c2c',town:'#8b6914',water:'#1565c0'};
const edTiles = Array.from({length:ED},(_,y)=>Array.from({length:ED},(_,x)=>{
  if(y>=9&&y<12&&x>=9&&x<12) return 'town';
  return 'grass';
}));
// Add some default forest
[[2,8],[5,3],[12,2],[17,8],[3,12],[15,15]].forEach(([cx,cy])=>{
  for(let dy=-2;dy<=2;dy++) for(let dx=-2;dx<=2;dx++){
    if(dx*dx+dy*dy<=4){ const nx=cx+dx,ny=cy+dy; if(nx>=0&&nx<ED&&ny>=0&&ny<ED&&edTiles[ny][nx]==='grass') edTiles[ny][nx]='forest'; }
  }
});
// Add rock clusters
[[3,3],[16,3],[3,16],[16,16]].forEach(([cx,cy])=>{
  for(let dy=-2;dy<=2;dy++) for(let dx=-2;dx<=2;dx++){
    if(dx*dx+dy*dy<=3){ const nx=cx+dx,ny=cy+dy; if(nx>=0&&nx<ED&&ny>=0&&ny<ED&&edTiles[ny][nx]==='grass') edTiles[ny][nx]='rock'; }
  }
});

let edCtx, edDrag=false;
function initEditor(){
  const canvas = document.getElementById('map-editor-canvas');
  if(!canvas||canvas._init) return;
  canvas._init=true;
  edCtx=canvas.getContext('2d');
  drawEditor();
  function paint(e){
    const r=canvas.getBoundingClientRect();
    const cs=400/ED;
    const tx=Math.floor((e.clientX-r.left)/cs);
    const ty=Math.floor((e.clientY-r.top)/cs);
    if(tx>=0&&tx<ED&&ty>=0&&ty<ED){ edTiles[ty][tx]=S.activePalette; drawEditor(); }
  }
  canvas.addEventListener('mousedown',e=>{edDrag=true;paint(e);});
  canvas.addEventListener('mousemove',e=>{if(edDrag)paint(e);});
  window.addEventListener('mouseup',()=>edDrag=false);
}
function drawEditor(){
  if(!edCtx) return;
  const cs=400/ED;
  for(let y=0;y<ED;y++) for(let x=0;x<ED;x++){
    edCtx.fillStyle=TILE_COLORS[edTiles[y][x]]||'#3d7a24';
    edCtx.fillRect(x*cs,y*cs,cs-1,cs-1);
  }
  // Exchange marker at 10,10
  const ex=10*cs,ey=10*cs;
  edCtx.fillStyle='rgba(245,166,35,.8)';
  edCtx.fillRect(ex+1,ey+1,cs-3,cs-3);
  edCtx.fillStyle='#000';
  edCtx.font=`bold ${cs*0.5}px sans-serif`;
  edCtx.textAlign='center'; edCtx.textBaseline='middle';
  edCtx.fillText('E',ex+cs/2,ey+cs/2);
}
function selectPalette(btn,tile){
  document.querySelectorAll('.palette-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  S.activePalette=tile;
}
function randomSeed(){ document.getElementById('seed-input').value=Math.floor(Math.random()*99999); }

// â•â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â•â•
function showCover(){ document.getElementById('cover-screen').style.cssText=''; document.getElementById('game-screen').classList.remove('visible'); }
function hideCover(){ document.getElementById('cover-screen').style.display='none'; document.getElementById('game-screen').classList.add('visible'); }
function quickStart(){ hideCover(); if(!S.simRunning) sendWS({type:'control',command:'start_simulation'}); }
function openNewGameModal(){
  document.getElementById('new-game-modal').classList.add('open');
  setTimeout(initEditor,80);
  fetchProfiles();
}
function openLoadModal(){ document.getElementById('load-modal').classList.add('open'); fetchSaves(); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function backToCover(){ if(S.simRunning) sendWS({type:'control',command:'stop_simulation'}); showCover(); }
function startGame(){ closeModal('new-game-modal'); hideCover(); if(!S.simRunning) sendWS({type:'control',command:'start_simulation'}); }
function switchNewTab(tab,idx){
  document.querySelectorAll('#new-game-modal .modal-tab').forEach((t,i)=>t.classList.toggle('active',i===idx));
  document.querySelectorAll('#new-game-modal .modal-body').forEach((b,i)=>b.classList.toggle('active',i===idx));
}

// â•â•â•â•â•â•â•â• WEBSOCKET â•â•â•â•â•â•â•â•
let ws, wsRetry=0;
function connectWS(){
  const proto=location.protocol==='https:'?'wss':'ws';
  ws=new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen=()=>{ wsRetry=0; };
  ws.onmessage=e=>{ try{ handleMsg(JSON.parse(e.data)); }catch(err){} };
  ws.onclose=()=>{ wsRetry++; setTimeout(connectWS,Math.min(wsRetry*1500,10000)); };
}
function sendWS(obj){ if(ws&&ws.readyState===1) ws.send(JSON.stringify(obj)); }

// â•â•â•â•â•â•â•â• MESSAGE HANDLER â•â•â•â•â•â•â•â•
function handleMsg(msg){
  if(msg.type!=='world_state') return;
  S.world=msg; S.simRunning=msg.simulation_running;
  updateHeader(msg);
  renderCanvas();
  if(S.activeTab==='npc') renderNPCs(msg.npcs);
  if(S.activeTab==='eco') updateEconomy(msg.market);
  if(S.activeTab==='ctrl') updateControls(msg);
  updatePlayerBar(msg.player);
  processEvents(msg.events||[]);
  syncSettings(msg.settings);
  updateSimBtns();
}

// â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•
const WICONS={sunny:'â˜€ï¸',rainy:'ğŸŒ§ï¸',storm:'â›ˆï¸'};
const PHASE={dawn:'æ™¨',day:'æ—¥',dusk:'æ˜',night:'å¤œ'};
function updateHeader(msg){
  const t=msg.time;
  document.getElementById('header-time').textContent=`${t.time_str} Â· ${PHASE[t.phase]||t.phase}`;
  document.getElementById('header-weather').textContent=WICONS[msg.weather]||'â˜ï¸';
  const tu=msg.token_usage;
  if(tu){
    const used=tu.total_used||0,limit=tu.session_limit||100000;
    document.getElementById('token-label').textContent=`${fmtN(used)} / ${fmtN(limit)} tokens`;
    const pct=Math.min(100,used/limit*100);
    const f=document.getElementById('token-fill');
    f.style.width=pct+'%';
    f.className='progress-fill'+(pct>80?' danger':pct>60?' warn':'');
  }
}
function updateSimBtns(){
  const lbl=S.simRunning?'â¸ æš‚åœ':'â–¶ å¼€å§‹';
  document.getElementById('btn-sim').textContent=lbl;
  const b2=document.getElementById('btn-sim2');
  if(b2) b2.textContent=S.simRunning?'â¸ æš‚åœä»¿çœŸ':'â–¶ å¼€å§‹ä»¿çœŸ';
}
function toggleSim(){ sendWS({type:'control',command:S.simRunning?'stop_simulation':'start_simulation'}); }
function fmtN(n){ if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1000) return Math.round(n/1000)+'k'; return String(n); }

// â•â•â•â•â•â•â•â• CANVAS â•â•â•â•â•â•â•â•
const WORLD_W=20,WORLD_H=20,TS=30;
let rainDrops=[],lightningA=0,_rAnimRunning=false;
function initCanvas(){
  const c=document.getElementById('world-canvas');
  c.width=WORLD_W*TS; c.height=WORLD_H*TS;
  document.getElementById('canvas-wrap').style.width=c.width+'px';
  for(let i=0;i<90;i++) rainDrops.push({x:Math.random()*600,y:Math.random()*600,s:3+Math.random()*5,l:6+Math.random()*8});
  c.addEventListener('click',e=>{
    if(S.spawnMode){ const {tx,ty}=getTileXY(c,e); S.spawnTarget={x:tx,y:ty}; S.spawnMode=false; c.style.cursor='default'; document.getElementById('spawn-coord').textContent=`ç›®æ ‡åæ ‡: (${tx},${ty})`; return; }
    const {tx,ty}=getTileXY(c,e);
    document.getElementById('canvas-status').textContent=`é€‰ä¸­: (${tx},${ty})`;
  });
  c.addEventListener('dblclick',e=>{
    const {tx,ty}=getTileXY(c,e);
    S.spawnTarget={x:tx,y:ty};
    document.getElementById('spawn-coord').textContent=`ç›®æ ‡åæ ‡: (${tx},${ty})`;
  });
  startRainAnim();
}
function getTileXY(c,e){ const r=c.getBoundingClientRect(); return {tx:Math.floor((e.clientX-r.left)/TS),ty:Math.floor((e.clientY-r.top)/TS)}; }

const TFILL={g:'#2d6a18',w:'#1a4a8a',r:'#4a4a4a',f:'#1a4a22',o:'#6b5230'};
const TSTROKE={g:'#245812',w:'#122e62',r:'#383838',f:'#112a18',o:'#573f22'};
const RICONS={w:'ğŸªµ',s:'ğŸª¨',o:'ğŸ’',f:'ğŸ',h:'ğŸŒ¿'};

function renderCanvas(){
  const world=S.world; if(!world) return;
  const c=document.getElementById('world-canvas'); if(!c) return;
  const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  // Tiles
  (world.tiles||[]).forEach(tile=>{
    const px=tile.x*TS,py=tile.y*TS;
    ctx.fillStyle=TFILL[tile.t]||TFILL.g;
    ctx.fillRect(px,py,TS,TS);
    ctx.strokeStyle=TSTROKE[tile.t]||TSTROKE.g;
    ctx.lineWidth=.3; ctx.strokeRect(px+.15,py+.15,TS-.3,TS-.3);
    if(tile.e){ ctx.fillStyle='rgba(245,166,35,.18)'; ctx.fillRect(px,py,TS,TS); ctx.strokeStyle='#f5a62388'; ctx.lineWidth=1.5; ctx.strokeRect(px+.75,py+.75,TS-1.5,TS-1.5); }
    if(tile.r&&tile.q>0){
      const icon=RICONS[tile.r]||'?';
      ctx.font=`${TS*.42}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(icon,px+TS/2,py+TS/2);
      const pct=tile.q/(tile.mq||1);
      ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(px+TS-11,py+2,9,4);
      ctx.fillStyle=pct>.5?'#4caf50':pct>.2?'#ff9800':'#f44336'; ctx.fillRect(px+TS-11,py+2,9*pct,4);
    }
    if(tile.e){ ctx.font=`bold 9px sans-serif`; ctx.fillStyle='#f5a623'; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText('E',px+TS/2,py+TS-1); }
    // Furniture icons
    if(tile.f){
      const fi={bed:'ğŸ›',table:'ğŸªµ',chair:'ğŸª‘'}[tile.f]||'?';
      ctx.font=`${TS*.32}px serif`; ctx.textAlign='right'; ctx.textBaseline='bottom';
      ctx.fillText(fi,px+TS-1,py+TS-1);
    }
  });
  // NPCs
  (world.npcs||[]).forEach(npc=>drawNPC(ctx,npc,world.tick));
  // Player
  if(world.player){ const p=world.player; drawPlayer(ctx,p); }
  // Spawn target highlight
  if(S.spawnTarget){
    ctx.strokeStyle='rgba(245,166,35,.8)'; ctx.lineWidth=2; ctx.setLineDash([3,3]);
    ctx.strokeRect(S.spawnTarget.x*TS+1,S.spawnTarget.y*TS+1,TS-2,TS-2); ctx.setLineDash([]);
  }
}

function drawNPC(ctx,npc,tick){
  const px=npc.x*TS+TS/2,py=npc.y*TS+TS/2,r=TS*.35;
  const ep=npc.energy/100;
  const ec=ep>.6?'#4ecca388':ep>.3?'#f5a62388':'#e9456088';
  // Energy arc
  ctx.beginPath(); ctx.arc(px,py,r+2.5,-Math.PI/2,-Math.PI/2); ctx.strokeStyle='#333355'; ctx.lineWidth=3; ctx.stroke();
  ctx.beginPath(); ctx.arc(px,py,r+2.5,-Math.PI/2,-Math.PI/2+Math.PI*2*ep); ctx.strokeStyle=ep>.6?'#4ecca3':ep>.3?'#f5a623':'#e94560'; ctx.lineWidth=3; ctx.stroke();
  // Circle
  ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2);
  ctx.fillStyle=npc.color||'#888'; ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.lineWidth=1; ctx.stroke();
  // Initial
  ctx.font=`bold ${TS*.3}px sans-serif`; ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText((npc.name||'?')[0].toUpperCase(),px,py);
  // Processing dot
  if(npc.is_processing){
    const t=Date.now()/400;
    ctx.beginPath(); ctx.arc(px+r*.75,py-r*.75,2.5,0,Math.PI*2);
    ctx.fillStyle=`rgba(78,204,163,${.5+.5*Math.sin(t)})`; ctx.fill();
  }
  // Proposal badge
  if(npc.pending_proposals>0){
    ctx.beginPath(); ctx.arc(px-r*.7,py-r*.7,5,0,Math.PI*2);
    ctx.fillStyle='#e94560'; ctx.fill();
    ctx.font='bold 7px sans-serif'; ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(npc.pending_proposals,px-r*.7,py-r*.7);
  }
  // Speech bubble
  if(npc.last_message&&tick-npc.last_message_tick<5){
    drawBubble(ctx,npc.last_message,px,py-r-4,npc.color||'#4ecca3');
  }
}
function drawPlayer(ctx,p){
  const px=p.x*TS+TS/2,py=p.y*TS+TS/2,r=TS*.36;
  ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2);
  ctx.fillStyle='#fff'; ctx.fill(); ctx.strokeStyle='#aaa'; ctx.lineWidth=1.5; ctx.stroke();
  ctx.font=`bold ${TS*.3}px sans-serif`; ctx.fillStyle='#111'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('P',px,py);
}
function drawBubble(ctx,text,bx,by,color){
  ctx.font='11px system-ui';
  const maxW=130,pad=5,lh=14;
  const words=text.split('');
  let line='',lines=[];
  words.forEach(ch=>{ if(ctx.measureText(line+ch).width>maxW-pad*2){lines.push(line);line=ch;}else line+=ch; });
  if(line) lines.push(line);
  lines=lines.slice(-2);
  const bw=Math.min(maxW,lines.reduce((m,l)=>Math.max(m,ctx.measureText(l).width),0)+pad*2+4);
  const bh=lines.length*lh+pad*2;
  const rx=bx-bw/2,ry=by-bh-6;
  ctx.fillStyle='rgba(5,5,20,.85)'; ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(rx,ry,bw,bh,4); else ctx.rect(rx,ry,bw,bh);
  ctx.fill(); ctx.strokeStyle=color; ctx.lineWidth=1; ctx.stroke();
  ctx.fillStyle='#eee'; ctx.textAlign='left'; ctx.textBaseline='top';
  lines.forEach((l,i)=>ctx.fillText(l,rx+pad,ry+pad+i*lh));
}

// Rain animation
function startRainAnim(){
  if(_rAnimRunning) return; _rAnimRunning=true;
  function frame(){
    requestAnimationFrame(frame);
    const w=S.world; if(!w) return;
    const wt=w.weather;
    if(wt!=='rainy'&&wt!=='storm'&&lightningA<=0) return;
    const c=document.getElementById('world-canvas'); if(!c) return;
    const ctx=c.getContext('2d');
    if(wt==='rainy'||wt==='storm'){
      const mul=wt==='storm'?2:1;
      rainDrops.forEach(d=>{
        ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x+2*mul,d.y+d.l*mul);
        ctx.strokeStyle=`rgba(150,200,255,${0.2*mul})`; ctx.lineWidth=.8; ctx.stroke();
        d.y+=d.s*mul; if(d.y>c.height){d.y=-10;d.x=Math.random()*c.width;}
      });
      if(wt==='storm'&&Math.random()<.004) lightningA=.35;
    }
    if(lightningA>0){
      ctx.fillStyle=`rgba(200,220,255,${lightningA})`;
      ctx.fillRect(0,0,c.width,c.height);
      lightningA=Math.max(0,lightningA-.04);
    }
  }
  frame();
}

// â•â•â•â•â•â•â•â• NPC TAB â•â•â•â•â•â•â•â•
function renderNPCs(npcs){
  if(!npcs) return;
  const el=document.getElementById('tab-npc'); el.innerHTML='';
  npcs.forEach(npc=>{
    const prof=npc.profile||{};
    const ep=npc.energy;
    const ec=ep>60?'#4caf50':ep>30?'#f5a623':'#e94560';
    const inv=npc.inventory||{};
    const items=['wood','stone','ore','food','herb','rope','potion','tool','bread','gold'];
    const invHtml=items.map(k=>{ const v=inv[k]||0; const nz=v>0; return `<span class="inv-chip ${nz?'nz':''}">${k.slice(0,3)}: ${typeof v==='number'&&v!==Math.floor(v)?v.toFixed(1):v}</span>`; }).join('');
    const goalHtml=(prof.goals||[]).map(g=>`<li style="font-size:11px">${escH(g)}</li>`).join('');
    const div=document.createElement('div'); div.className='npc-panel-card';
    div.innerHTML=`
      <div class="npc-panel-header">
        <div class="npc-mini-dot" style="background:${npc.color||'#888'}">${(npc.name||'?')[0]}</div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:5px">
            <span class="npc-panel-name">${escH(npc.name||'NPC')}</span>
            ${prof.title?`<span class="npc-title-badge">${escH(prof.title)}</span>`:''}
          </div>
          <div style="font-size:11px;color:var(--muted)">@(${npc.x},${npc.y}) Â· ${npc.last_action||'idle'}</div>
        </div>
        ${npc.pending_proposals>0?`<span class="proposal-badge">ğŸ“¨${npc.pending_proposals}</span>`:''}
      </div>
      <div class="energy-bar-wrap">
        <div class="energy-label">ä½“åŠ› ${npc.energy}/100 ${npc.equipped?`<span style="font-size:10px;color:var(--teal)">âš”${npc.equipped}</span>`:''} <span style="font-size:10px;color:var(--gold)">${npc.inv_count||0}/${npc.inv_max||20}æ ¼</span></div>
        <div class="energy-track"><div class="energy-fill" style="width:${ep}%;background:${ec}"></div></div>
      </div>
      ${npc.last_message?`<div class="last-msg" title="${escH(npc.last_message)}">"${escH(npc.last_message.slice(0,50))}${npc.last_message.length>50?'â€¦':''}"</div>`:''}
      ${npc.thought?`<div style="font-size:10px;color:var(--muted);margin-top:2px">ğŸ’­ ${escH(npc.thought.slice(0,60))}</div>`:''}
      <button class="npc-expand-btn" onclick="toggleExpand(this)">â–¼ å±•å¼€è¯¦æƒ…</button>
      <div class="npc-details">
        ${prof.personality?`<div style="font-size:11px;color:var(--muted);margin-bottom:4px">æ€§æ ¼: ${escH(prof.personality)}</div>`:''}
        ${prof.backstory?`<div style="font-size:11px;margin-bottom:6px">${escH(prof.backstory)}</div>`:''}
        ${goalHtml?`<ul style="padding-left:16px;margin-bottom:6px">${goalHtml}</ul>`:''}
        <div class="inv-chips">${invHtml}</div>
        <button class="btn-ghost" style="font-size:11px;padding:4px 10px" onclick='openEditNPC(${JSON.stringify(npc.id)},${JSON.stringify(npc.profile||{})},${JSON.stringify(npc.color)},${JSON.stringify(npc.name)})'>âœï¸ ç¼–è¾‘æ¡£æ¡ˆ</button>
      </div>
    `;
    el.appendChild(div);
  });
}
function toggleExpand(btn){ const d=btn.nextElementSibling; d.classList.toggle('open'); btn.textContent=d.classList.contains('open')?'â–² æ”¶èµ·':'â–¼ å±•å¼€è¯¦æƒ…'; }

// â•â•â•â•â•â•â•â• ECONOMY TAB â•â•â•â•â•â•â•â•
const INAMES={wood:'æœ¨å¤´',stone:'çŸ³å¤´',ore:'çŸ¿çŸ³',food:'é£Ÿç‰©',herb:'è‰è¯',rope:'ç»³ç´¢',potion:'è¯æ°´',tool:'å·¥å…·',bread:'é¢åŒ…',gold:'é‡‘å¸'};
function updateEconomy(market){
  if(!market) return;
  const tbody=document.getElementById('market-tbody'); tbody.innerHTML='';
  Object.entries(market.prices||{}).forEach(([item,p])=>{
    const tr=document.createElement('tr');
    tr.className=p.trend==='â†‘'?'up':p.trend==='â†“'?'down':'';
    const tc=p.trend==='â†‘'?'trend-up':p.trend==='â†“'?'trend-down':'trend-flat';
    tr.innerHTML=`<td>${INAMES[item]||item}</td><td>${p.current.toFixed(2)}</td><td>${p.base.toFixed(2)}</td><td class="${tc}">${p.trend}</td><td class="${tc}">${p.change_pct>0?'+':''}${p.change_pct}%</td>`;
    tbody.appendChild(tr);
  });
  drawPriceChart();
}
function drawPriceChart(){
  const item=document.getElementById('chart-item-sel')?.value||'wood';
  const canvas=document.getElementById('price-chart-canvas'); if(!canvas) return;
  const ctx=canvas.getContext('2d'); const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h); ctx.fillStyle='#111128'; ctx.fillRect(0,0,w,h);
  const hist=(S.world?.market?.history)||{};
  const data=hist[item];
  if(!data||data.length<2){ ctx.fillStyle='#666'; ctx.font='12px sans-serif'; ctx.textAlign='center'; ctx.fillText('æš‚æ— æ•°æ®',w/2,h/2); return; }
  const pad=22;
  const minV=Math.min(...data)*.95,maxV=Math.max(...data)*1.05;
  const sx=i=>pad+(i/(data.length-1))*(w-pad*2);
  const sy=v=>h-pad-(v-minV)/(maxV-minV+.001)*(h-pad*2);
  // Grid
  ctx.strokeStyle='rgba(42,42,74,.8)'; ctx.lineWidth=1;
  for(let i=0;i<=3;i++){ const y=pad+i*(h-pad*2)/3; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke(); const val=maxV-(maxV-minV)/3*i; ctx.fillStyle='rgba(136,136,170,.6)'; ctx.font='9px sans-serif'; ctx.textAlign='right'; ctx.fillText(val.toFixed(2),pad-2,y+3); }
  // Gradient fill
  const grad=ctx.createLinearGradient(0,pad,0,h-pad);
  grad.addColorStop(0,'rgba(78,204,163,.28)'); grad.addColorStop(1,'rgba(78,204,163,.02)');
  ctx.fillStyle=grad; ctx.beginPath(); ctx.moveTo(sx(0),h-pad);
  data.forEach((v,i)=>ctx.lineTo(sx(i),sy(v)));
  ctx.lineTo(sx(data.length-1),h-pad); ctx.closePath(); ctx.fill();
  // Line
  ctx.strokeStyle='#4ecca3'; ctx.lineWidth=2; ctx.lineJoin='round';
  ctx.beginPath(); data.forEach((v,i)=>{ if(i===0) ctx.moveTo(sx(i),sy(v)); else ctx.lineTo(sx(i),sy(v)); }); ctx.stroke();
  // Endpoints
  [[0,data[0]],[data.length-1,data[data.length-1]]].forEach(([i,v])=>{ ctx.beginPath(); ctx.arc(sx(i),sy(v),3,0,Math.PI*2); ctx.fillStyle='#4ecca3'; ctx.fill(); });
  // Label
  ctx.fillStyle='rgba(136,136,170,.8)'; ctx.font='10px sans-serif'; ctx.textAlign='center'; ctx.fillText(`${INAMES[item]||item} Â· æœ€è¿‘${data.length}æ¬¡`,w/2,h-5);
}

// â•â•â•â•â•â•â•â• CONTROLS TAB â•â•â•â•â•â•â•â•
function updateControls(msg){
  const el=document.getElementById('god-commentary');
  if(msg.god?.commentary) el.textContent=msg.god.commentary;
  document.querySelectorAll('.weather-btn').forEach(b=>{
    const bw=b.dataset.w; b.classList.toggle('active-weather',bw===msg.weather);
  });
  updateSimBtns();
}
function setWeather(w){ sendWS({type:'god_direct',command:'set_weather',value:w}); }
function spawnResource(){
  if(!S.spawnTarget){ alert('è¯·å…ˆåŒå‡»åœ°å›¾é€‰æ‹©ç›®æ ‡åæ ‡'); return; }
  const res=document.getElementById('spawn-res-type').value;
  const qty=parseInt(document.getElementById('spawn-qty').value)||5;
  sendWS({type:'god_direct',command:'spawn_resource',resource_type:res,x:S.spawnTarget.x,y:S.spawnTarget.y,quantity:qty});
  S.spawnTarget=null; document.getElementById('spawn-coord').textContent='åŒå‡»åœ°å›¾é€‰æ‹©ç›®æ ‡åæ ‡';
}

// â•â•â•â•â•â•â•â• SETTINGS TAB â•â•â•â•â•â•â•â•
function syncSettings(s){
  if(!s) return;
  const pairs=[['sl-world-tick','sv-world-tick',s.world_tick_seconds,'s'],['sl-npc-min','sv-npc-min',s.npc_min_think,'s'],['sl-npc-max','sv-npc-max',s.npc_max_think,'s'],['sl-vision','sv-vision',s.npc_vision_radius,''],['sl-hearing','sv-hearing',s.npc_hearing_radius,'']];
  pairs.forEach(([slId,svId,val,unit])=>{ const sl=document.getElementById(slId); if(sl&&!sl.matches(':active')){ sl.value=val||0; document.getElementById(svId).textContent=(val||0)+unit; } });
  const tl=document.getElementById('sl-token'); if(tl&&!tl.matches(':active')){ const lim=s.token_limit||(S.world?.token_usage?.session_limit)||100000; tl.value=lim; document.getElementById('sv-token').textContent=Math.round(lim/1000)+'k'; }
  const tog=document.getElementById('toggle-thoughts'); if(tog) tog.classList.toggle('on',!!s.show_npc_thoughts);
}
function slVal(id,v,unit){ const el=document.getElementById(id); if(el) el.textContent=parseFloat(v).toFixed(unit==='s'?1:0)+unit; }
function setProvider(p){ S.provider=p; document.getElementById('prov-gemini').classList.toggle('active',p==='gemini'); document.getElementById('prov-local').classList.toggle('active',p==='local'); document.getElementById('gemini-fields').style.display=p==='gemini'?'':'none'; document.getElementById('local-fields').style.display=p==='local'?'':'none'; }
function toggleApiVis(){ const inp=document.getElementById('api-key-input'); inp.type=inp.type==='password'?'text':'password'; }
function saveLLMSettings(){
  const data={llm_provider:S.provider};
  if(S.provider==='gemini'){ const k=document.getElementById('api-key-input').value.trim(); if(k) data.api_key=k; const m=document.getElementById('model-name-input').value.trim(); if(m) data.model_name=m; }
  else { data.local_llm_base_url=document.getElementById('local-url-input').value.trim(); data.local_llm_model=document.getElementById('local-model-input').value.trim(); }
  fetch('/api/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(()=>alert('LLMè®¾ç½®å·²ä¿å­˜'));
}
function saveGameSettings(){
  const data={};
  [['sl-world-tick','world_tick_seconds'],['sl-npc-min','npc_min_think'],['sl-npc-max','npc_max_think'],['sl-vision','npc_vision_radius'],['sl-hearing','npc_hearing_radius']].forEach(([slId,key])=>{ const sl=document.getElementById(slId); if(sl) data[key]=parseFloat(sl.value); });
  const tl=document.getElementById('sl-token'); if(tl) data.token_limit=parseInt(tl.value);
  const tog=document.getElementById('toggle-thoughts'); if(tog) data.show_npc_thoughts=tog.classList.contains('on');
  fetch('/api/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(()=>alert('æ¸¸æˆè®¾ç½®å·²ä¿å­˜'));
}
async function deleteAllSaves(){ if(!confirm('ç¡®å®šåˆ é™¤æ‰€æœ‰å­˜æ¡£ï¼Ÿ')) return; await fetch('/api/saves/delete',{method:'POST'}); alert('å­˜æ¡£å·²æ¸…ç©º'); }
async function fetchSaves(){
  const data=await fetch('/api/saves').then(r=>r.json()).catch(()=>[]);
  const el=document.getElementById('save-list');
  if(!data?.length){ el.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">æš‚æ— å­˜æ¡£</div>'; return; }
  el.innerHTML=data.map(s=>`<div class="save-item" style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><div style="font-size:12px"><b>${s.npc_id||'NPC'}</b><br><span style="color:var(--muted)">${s.count||0} æ¡è®°å¿† Â· Tick ${s.latest_tick||0}</span></div><button class="btn-ghost" style="font-size:12px" onclick="closeModal('load-modal')">åŠ è½½</button></div>`).join('');
}

// â•â•â•â•â•â•â•â• PLAYER BAR â•â•â•â•â•â•â•â•
function updatePlayerBar(player){
  const bar=document.getElementById('player-bar');
  if(!player){ bar.classList.remove('visible'); return; }
  bar.classList.add('visible');
  document.getElementById('pname').textContent=player.name||'Player';
  document.getElementById('penergy').textContent=player.energy??100;
  document.getElementById('ppos').textContent=`(${player.x},${player.y})`;
  // Equipped badge
  const eb=document.getElementById('p-equipped-badge');
  if(eb) eb.textContent=player.equipped?`âš” ${player.equipped}`:'âš” ç©º';
  // Inventory badge
  const ib=document.getElementById('p-inv-badge');
  if(ib) ib.textContent=`ğŸ’ ${player.inv_count||0}/${player.inv_max||20}`;
  // Populate talk target dropdown
  const sel=document.getElementById('player-talk-target');
  if(sel&&S.world){
    const prev=sel.value;
    sel.innerHTML='<option value="">å¹¿æ’­</option>'+(S.world.npcs||[]).map(n=>`<option value="${n.id}">${escH(n.name)}</option>`).join('');
    if(prev) sel.value=prev;
  }
  // Dialogue popup
  updateDialogueModal(player.dialogue);
}
function playerMove(dx,dy){ sendWS({type:'player_action',action:'move',dx,dy}); }
function playerTalk(){
  const inp=document.getElementById('player-talk-input');
  const msg=inp.value.trim(); if(!msg) return;
  const target=document.getElementById('player-talk-target')?.value||null;
  sendWS({type:'player_action',action:'talk',message:msg,target_id:target||null});
  inp.value='';
}

// â•â•â•â•â•â•â•â• DIALOGUE MODAL â•â•â•â•â•â•â•â•
let _currentDlgFromId=null;
function updateDialogueModal(dialogue){
  const modal=document.getElementById('dialogue-modal'); if(!modal) return;
  if(!dialogue){ modal.classList.remove('open'); _currentDlgFromId=null; return; }
  _currentDlgFromId=dialogue.from_id;
  modal.classList.add('open');
  document.getElementById('dlg-from').textContent=`ğŸ’¬ ${dialogue.from_name} è¯´:`;
  document.getElementById('dlg-msg').textContent=dialogue.message;
  const optEl=document.getElementById('dlg-options');
  if(dialogue.reply_options&&dialogue.reply_options.length>0){
    const labels=['A','B','C','D'];
    optEl.innerHTML=dialogue.reply_options.map((opt,i)=>`<button class="dialogue-opt" onclick="replyDialogue(${JSON.stringify(opt)})">[${labels[i]||i+1}] ${escH(opt)}</button>`).join('');
  } else {
    optEl.innerHTML='<div class="dialogue-loading">â³ æ­£åœ¨ç”Ÿæˆå›å¤é€‰é¡¹â€¦</div>';
  }
}
function replyDialogue(msg){
  if(!_currentDlgFromId) return;
  sendWS({type:'player_action',action:'dialogue_reply',to_npc_id:_currentDlgFromId,message:msg});
  document.getElementById('dialogue-modal').classList.remove('open');
  _currentDlgFromId=null;
}
function sendDialogueCustom(){
  const inp=document.getElementById('dlg-custom-input');
  const msg=inp.value.trim(); if(!msg) return;
  replyDialogue(msg); inp.value='';
}
function dismissDialogue(){
  document.getElementById('dialogue-modal').classList.remove('open');
  _currentDlgFromId=null;
}

// â•â•â•â•â•â•â•â• PLAYER QUICK ACTIONS â•â•â•â•â•â•â•â•
function showCraftPanel(){
  const inv=S.world?.player?.inventory||{};
  const recipes={rope:{wood:2},potion:{herb:2},tool:{stone:1,wood:1},bread:{food:2}};
  const canCraft=Object.entries(recipes).filter(([item,req])=>Object.entries(req).every(([m,q])=>(inv[m]||0)>=q));
  if(!canCraft.length){ alert('èƒŒåŒ…ä¸­æ²¡æœ‰è¶³å¤Ÿçš„ææ–™åˆ¶é€ ä»»ä½•ç‰©å“'); return; }
  const choice=prompt('é€‰æ‹©åˆ¶é€ ç‰©å“:\n'+canCraft.map(([item,req],i)=>`${i+1}. ${item} (éœ€è¦: ${Object.entries(req).map(([m,q])=>q+m).join('+')})`).join('\n')+'\n\nè¾“å…¥åºå·:');
  const idx=parseInt(choice)-1;
  if(idx>=0&&idx<canCraft.length) sendWS({type:'player_action',action:'craft',craft_item:canCraft[idx][0]});
}
function showEquipPanel(){
  const inv=S.world?.player?.inventory||{};
  const equipped=S.world?.player?.equipped;
  const items=[];
  if((inv.tool||0)>0) items.push(['tool','å·¥å…· (é‡‡é›†Ã—2)']);
  if((inv.rope||0)>0) items.push(['rope','ç»³ç´¢ (ç§»åŠ¨ä½“åŠ›-1)']);
  if(equipped) items.push(['__unequip__',`å¸ä¸‹å½“å‰è£…å¤‡ (${equipped})`]);
  if(!items.length){ alert('æ²¡æœ‰å¯è£…å¤‡çš„ç‰©å“'); return; }
  const choice=prompt('é€‰æ‹©è£…å¤‡:\n'+items.map(([k,v],i)=>`${i+1}. ${v}`).join('\n')+'\n\nè¾“å…¥åºå·:');
  const idx=parseInt(choice)-1;
  if(idx>=0&&idx<items.length){
    const [item]=items[idx];
    if(item==='__unequip__') sendWS({type:'player_action',action:'unequip'});
    else sendWS({type:'player_action',action:'use_item',use_item:item});
  }
}
function showBuildPanel(){
  const inv=S.world?.player?.inventory||{};
  const recipes={bed:{wood:4},table:{wood:3},chair:{wood:2}};
  const effects={bed:'ç¡çœ +80ä½“åŠ›',table:'åˆ¶é€ Ã—2',chair:'ä¼‘æ¯+35ä½“åŠ›'};
  const canBuild=Object.entries(recipes).filter(([f,req])=>Object.entries(req).every(([m,q])=>(inv[m]||0)>=q));
  if(!canBuild.length){ alert(`æ²¡æœ‰è¶³å¤Ÿæœ¨å¤´å»ºé€ å®¶å…·ï¼ˆåºŠéœ€4æœ¨ï¼Œæ¡Œéœ€3æœ¨ï¼Œæ¤…éœ€2æœ¨ï¼‰`); return; }
  const choice=prompt('é€‰æ‹©å»ºé€ :\n'+canBuild.map(([f,req],i)=>`${i+1}. ${f} (éœ€è¦: ${Object.entries(req).map(([m,q])=>q+m).join('+')} â†’ ${effects[f]||''})`).join('\n')+'\n\nè¾“å…¥åºå·:');
  const idx=parseInt(choice)-1;
  if(idx>=0&&idx<canBuild.length) sendWS({type:'player_action',action:'build',build_furniture:canBuild[idx][0]});
}

// â•â•â•â•â•â•â•â• EVENT LOG â•â•â•â•â•â•â•â•
const LOG_CLASSES={npc_spoke:'log-talk',player_spoke:'log-talk',npc_traded:'log-trade',trade_accepted:'log-trade',trade_proposed:'log-trade',npc_gathered:'log-gather',player_gathered:'log-gather',npc_crafted:'log-craft',player_crafted:'log-craft',npc_sold:'log-trade',npc_bought:'log-trade',player_sold:'log-trade',player_bought:'log-trade',npc_equipped:'log-craft',player_equipped:'log-craft',furniture_built:'log-craft',weather_changed:'log-weather',market_updated:'log-market',player_dialogue_replied:'log-talk'};
function processEvents(events){
  events.forEach(ev=>{
    if(!ev.summary) return;
    const cls=LOG_CLASSES[ev.type]||'log-default';
    addLog(ev.summary,cls);
    if(['npc_sold','npc_bought','npc_crafted','trade_accepted','player_sold','player_bought','player_crafted','furniture_built'].includes(ev.type)){
      const tcls=['npc_sold','player_sold'].includes(ev.type)?'tli-sell':['npc_bought','player_bought'].includes(ev.type)?'tli-buy':['npc_crafted','player_crafted','furniture_built'].includes(ev.type)?'tli-craft':'tli-accept';
      S.tradeLog.unshift({txt:ev.summary,cls:tcls});
      if(S.tradeLog.length>30) S.tradeLog.pop();
      if(S.activeTab==='eco') renderTradeLog();
    }
  });
}
function addLog(txt,cls){
  const el=document.getElementById('event-log'); if(!el) return;
  const div=document.createElement('div'); div.className=`log-entry ${cls}`; div.textContent=txt;
  el.appendChild(div);
  if(el.children.length>80) el.removeChild(el.firstChild);
  el.scrollTop=el.scrollHeight;
}
function clearLog(){ const el=document.getElementById('event-log'); if(el) el.innerHTML=''; }
function toggleLog(){ S.logOpen=!S.logOpen; const el=document.getElementById('event-log'); if(el) el.className=S.logOpen?'':'collapsed'; document.getElementById('log-toggle-lbl').textContent=S.logOpen?'â–² æŠ˜å ':'â–¼ å±•å¼€'; }
function renderTradeLog(){ const el=document.getElementById('trade-log'); if(!el) return; el.innerHTML=S.tradeLog.slice(0,12).map(e=>`<div class="trade-log-item ${e.cls}">${escH(e.txt)}</div>`).join(''); }

// â•â•â•â•â•â•â•â• NPC PROFILES â•â•â•â•â•â•â•â•
async function fetchProfiles(){
  const data=await fetch('/api/npc_profiles').then(r=>r.json()).catch(()=>[]);
  const el=document.getElementById('npc-profile-cards'); if(!el) return;
  el.innerHTML='';
  data.forEach(p=>{
    S.profileCache[p.npc_id]=p;
    const div=document.createElement('div'); div.className='npc-card';
    const goals=p.goals||[];
    const goalsHtml=Array.from({length:Math.max(3,goals.length)},(_, i)=>`<input type="text" data-goal="${i}" value="${escH(goals[i]||'')}" placeholder="ç›®æ ‡${i+1}">`).join('');
    div.innerHTML=`
      <div class="npc-card-header">
        <div class="npc-dot" style="background:${p.color||'#888'}">${(p.name||'?')[0]}</div>
        <div><div class="npc-card-name">${escH(p.name||'NPC')}</div><div class="npc-card-title">${escH(p.title||'')}</div></div>
      </div>
      <div class="form-group"><label>èƒŒæ™¯æ•…äº‹</label><textarea data-field="backstory" rows="2">${escH(p.backstory||'')}</textarea></div>
      <div class="form-group"><label>æ€§æ ¼</label><input data-field="personality" value="${escH(p.personality||'')}"></div>
      <div class="form-group"><label>ç›®æ ‡</label><div class="goals-row">${goalsHtml}</div></div>
      <div class="form-group"><label>è¯´è¯é£æ ¼</label><input data-field="speech_style" value="${escH(p.speech_style||'')}"></div>
      <button class="btn-primary" style="width:100%;margin-top:4px" data-npc-id="${p.npc_id}" onclick="saveProfileCard(this)">ğŸ’¾ ä¿å­˜</button>
    `;
    el.appendChild(div);
  });
}
async function saveProfileCard(btn){
  const npcId=btn.dataset.npcId; const card=btn.closest('.npc-card');
  const body={...S.profileCache[npcId]||{},npc_id:npcId};
  card.querySelectorAll('[data-field]').forEach(inp=>body[inp.dataset.field]=inp.value);
  const goals=[]; card.querySelectorAll('[data-goal]').forEach(inp=>{ if(inp.value.trim()) goals.push(inp.value.trim()); }); body.goals=goals;
  await fetch(`/api/npc_profiles/${npcId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  btn.textContent='âœ… å·²ä¿å­˜'; setTimeout(()=>btn.textContent='ğŸ’¾ ä¿å­˜',1500);
}
async function exportProfiles(){
  const data=await fetch('/api/npc_profiles/export').then(r=>r.json()).catch(()=>[]);
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download='npc_profiles.json'; a.click();
}
async function importProfiles(input){
  const file=input.files[0]; if(!file) return;
  const data=JSON.parse(await file.text());
  await fetch('/api/npc_profiles/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  fetchProfiles();
}
function openEditNPC(npcId,prof,color,name){
  document.getElementById('edit-npc-id').value=npcId;
  document.getElementById('edit-name').value=name||prof.name||'';
  document.getElementById('edit-title').value=prof.title||'';
  document.getElementById('edit-color').value=color||'#888888';
  document.getElementById('edit-backstory').value=prof.backstory||'';
  document.getElementById('edit-personality').value=prof.personality||'';
  document.getElementById('edit-goals').value=(prof.goals||[]).join('\n');
  document.getElementById('edit-speech-style').value=prof.speech_style||'';
  document.getElementById('npc-edit-modal').classList.add('open');
}
async function saveNPCEdit(){
  const npcId=document.getElementById('edit-npc-id').value;
  const body={npc_id:npcId,name:document.getElementById('edit-name').value.trim(),title:document.getElementById('edit-title').value.trim(),color:document.getElementById('edit-color').value,backstory:document.getElementById('edit-backstory').value.trim(),personality:document.getElementById('edit-personality').value.trim(),goals:document.getElementById('edit-goals').value.split('\n').map(s=>s.trim()).filter(Boolean),speech_style:document.getElementById('edit-speech-style').value.trim()};
  await fetch(`/api/npc_profiles/${npcId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  closeModal('npc-edit-modal');
}

// â•â•â•â•â•â•â•â• TAB SWITCH â•â•â•â•â•â•â•â•
function switchTab(tab,btn){
  S.activeTab=tab;
  document.querySelectorAll('.side-tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active');
  ['npc','eco','ctrl','settings'].forEach(t=>{ const el=document.getElementById('tab-'+t); if(el) el.style.display=t===tab?'':'none'; });
  if(tab==='eco'&&S.world?.market){ updateEconomy(S.world.market); renderTradeLog(); }
  if(tab==='npc'&&S.world) renderNPCs(S.world.npcs);
  if(tab==='ctrl'&&S.world) updateControls(S.world);
}

// â•â•â•â•â•â•â•â• KEYBOARD â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
  if(!document.getElementById('game-screen').classList.contains('visible')) return;
  const moves={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0],w:[0,-1],s:[0,1],a:[-1,0],d:[1,0]};
  if(moves[e.key]&&S.world?.player){ e.preventDefault(); playerMove(...moves[e.key]); }
  if(e.key==='g') sendWS({type:'player_action',action:'gather'});
  if(e.key==='f') sendWS({type:'player_action',action:'eat'});
  if(e.key==='r') sendWS({type:'player_action',action:'rest'});
  if(e.key==='c') showCraftPanel();
  if(e.key==='e') showEquipPanel();
  if(e.key==='b') showBuildPanel();
  if(e.key===' '){ e.preventDefault(); toggleSim(); }
});

// â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•
function escH(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  initCanvas();
  connectWS();
  fetch('/api/settings').then(r=>r.json()).then(s=>{
    if(s.llm_provider) setProvider(s.llm_provider);
    if(s.model_name) document.getElementById('model-name-input').value=s.model_name;
    if(s.local_llm_base_url) document.getElementById('local-url-input').value=s.local_llm_base_url||'';
    if(s.local_llm_model) document.getElementById('local-model-input').value=s.local_llm_model||'';
    S.simRunning=!!s.simulation_running;
    updateSimBtns();
  }).catch(()=>{});
});
</script>
</body>
</html>
