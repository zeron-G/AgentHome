# AgentHome 游戏机制设计文档

> 本文档定义 AgentHome 的具体游戏机制参数，包括时间系统数值、白天/黑夜玩法区分、NPC行为频率、道具系统规则和结局解锁条件。
>
> 叙事设计见 [narrative-design.md](narrative-design.md)，角色关系见 [character-relationships.md](character-relationships.md)。

---

## 目录

1. [时间系统数值](#1-时间系统数值)
2. [白天/黑夜玩法区分](#2-白天黑夜玩法区分)
3. [NPC行为频率分级](#3-npc行为频率分级)
4. [道具系统机制规则](#4-道具系统机制规则)
5. [结局解锁条件具体化](#5-结局解锁条件具体化)
6. [信任度与叙事阶段](#6-信任度与叙事阶段)

---

## 1. 时间系统数值

### 1.1 基础时间单位

| 参数 | 数值 | 说明 |
|------|------|------|
| **1 tick** | 游戏循环最小单位 | 后端每次循环处理一个 tick |
| **tick 频率** | 约 1 tick/秒（实时） | 可配置，开发阶段可加速 |
| **1 游戏小时** | 60 ticks | — |
| **1 游戏日** | 1440 ticks（24小时） | 日出=360 tick, 日落=1080 tick |
| **1 季** | 28 游戏日 | 约 40,320 ticks |
| **1 年** | 4 季 = 112 游戏日 | 约 161,280 ticks |

### 1.2 日内时间划分

| 时段 | tick 范围 | 持续 | 说明 |
|------|----------|------|------|
| **黎明 (dawn)** | 300-420 | 2小时 | 天色渐亮，NPC开始起床 |
| **白天 (day)** | 420-1020 | 10小时 | 主要活动时间 |
| **黄昏 (dusk)** | 1020-1140 | 2小时 | 过渡时段，NPC行为变化 |
| **夜晚 (night)** | 1140-300(+1d) | 10小时 | 克苏鲁层活跃 |

### 1.3 季节

| 季节 | 游戏日范围 | 对应叙事阶段 | 天气特征 |
|------|-----------|-------------|---------|
| **春（第一季）** | Day 1-28 | secret_stage=0 正常村居 | 多雨、温暖，偶尔阵雨 |
| **夏（第二季）** | Day 29-56 | secret_stage=1 异常浮现 | 炎热，午后闷雷，夜间闷热 |
| **秋（第三季）** | Day 57-84 | secret_stage=2 碎片期 | 凉爽，多风，偶尔浓雾 |
| **冬（第四季）** | Day 85-112 | secret_stage=3 真相期 | 寒冷，红雪，异常天气频发 |

### 1.4 季节特殊天气

| 天气 | 最早出现 | 频率 | 叙事含义 |
|------|---------|------|---------|
| **异常闷热** | Day 29 | 夏季偶发 | 结界能量波动 |
| **红色黄昏** | Day 55 | 夏末开始，秋季增多 | 天灾前兆初现 |
| **无风暴雨** | Day 60 | 秋季偶发 | 结界不稳定 |
| **红雪** | Day 78 | 秋末首次，冬季反复 | 天灾前兆高峰 |
| **地面微震** | Day 40 | 夏季开始，频率递增 | 法阵裂缝扩大 |
| **边缘裂纹光** | Day 85 | 冬季持续 | 结界即将崩溃 |

---

## 2. 白天/黑夜玩法区分

### 2.1 白天：温馨田园模式

**核心玩法**：种田、采矿、社交、交易——标准沙盒模拟经营。

| 系统 | 白天行为 |
|------|---------|
| **种植** | 翻地、播种、浇水、收获。作物按季节生长 |
| **采矿** | 在矿区采集石头、矿石。矿镐影响效率 |
| **社交** | 与NPC对话、送礼、完成请求。建立信任度 |
| **交易** | 在交易所买卖。供需+天气驱动的动态价格 |
| **建造** | 用材料建造家具/工具/建筑。Erik协助锻造 |
| **探索** | 自由探索村子各区域，发现环境叙事 |

**NPC白天行为**：展现正位特质，按 daily_routines.dawn / day 行动。

**氛围**：明亮、安全、温暖。BGM轻快。

### 2.2 黄昏：过渡带

**时间**：1020-1140 tick（日落前后2小时）

| 变化 | 描述 |
|------|------|
| **色调** | 暖黄→橙红→暗紫渐变 |
| **NPC行为** | 按 daily_routines.dusk 行动。情绪更放松/更脆弱 |
| **对话解锁** | 某些深入对话只在黄昏时段可触发 |
| **异常预兆** | stage 1+ 后黄昏偶尔出现轻微异常（远处闪光、微弱低语） |

### 2.3 黑夜：克苏鲁层

**核心玩法**：探索异常、对抗威胁、发现隐藏线索。

| 系统 | 夜晚行为 |
|------|---------|
| **探索** | 法阵组件在月光/灯光下可见。废弃区域出现异常 |
| **异常实体** | 天灾渗透产生的具象化威胁（stage 1+才出现，频率随stage递增） |
| **战斗** | 使用工具/道具对抗异常实体。不是核心玩法，是叙事载体 |
| **线索收集** | 夜间专属线索：老井低语、红雪痕迹、NPC梦话、法阵光纹 |
| **NPC状态** | 大部分NPC在室内。Dave巡逻。Lily偶尔梦游（stage 2+） |

**异常实体类型**：

| 类型 | 出现阶段 | 威胁等级 | 描述 |
|------|---------|---------|------|
| **暗影浮游** | stage 1+ | 低 | 无害的黑色光点，靠近会消散。氛围营造 |
| **裂隙蠕虫** | stage 2+ | 中 | 从结界裂缝渗透的实体，会缓慢侵蚀地面 |
| **红雪精** | stage 3 | 中 | 红雪中浮现的人形轮廓，接触会降低认知清晰度 |
| **深层回声** | stage 3 | 高 | 法阵核心附近的强力实体，守卫着通往恶魔的通道 |

**战斗机制边界**：
- 战斗**不是**游戏核心——它是叙事的服务工具
- 失败不会Game Over，而是被Dave/God救回（消耗守护者力量）
- 战斗工具=日常工具的夜间用途（矿镐可以砸碎裂隙蠕虫，草药可以驱散暗影）
- 特殊道具在战斗中有额外效果（守夜人之灯驱散所有低级实体）

### 2.4 机制边界总结

| 维度 | 白天 | 黄昏 | 黑夜 |
|------|------|------|------|
| **核心玩法** | 经营/社交 | 过渡/深入对话 | 探索/战斗 |
| **NPC状态** | 正位/日常 | 过渡/脆弱 | 逆位/梦境 |
| **威胁等级** | 无 | 无 | 低→高（随stage） |
| **线索类型** | 对话/物品 | 情感/回忆 | 环境/超自然 |
| **God介入** | 旁白/天气 | 旁白变化 | 沉默或紧急干预 |

---

## 3. NPC行为频率分级

### 3.1 分级表

| 级别 | 角色 | 玩家视野内 | 玩家视野外 | think_interval_multiplier |
|------|------|-----------|-----------|--------------------------|
| **主要NPC** | Alice, Bob, Carol, Dave, Erik, Lily | 5-10秒/次 | 30秒/次 | 1.0 |
| **次要NPC** | Marco, 陈婆 | 15-30秒/次 | 90秒/次 | 3.0 |
| **God Agent** | 守护者 | 每tick | 每tick | 不适用（独立循环） |
| **恶魔** | 无名者 | 不适用 | 不适用 | 仅脚本触发 |

### 3.2 视野判定

- 玩家视野范围：以玩家位置为中心的 7x7 格子（可配置）
- NPC在视野内时使用高频思考循环
- NPC离开视野后降频，但**不停止思考**——他们在视野外也有自己的生活
- NPC在视野外积累的状态变化，在玩家重新进入视野时一次性体现

### 3.3 特殊频率规则

| 场景 | 频率调整 | 说明 |
|------|---------|------|
| NPC正在与玩家对话 | 提升到最高频 | 确保对话响应及时 |
| NPC正在执行叙事事件 | 提升到最高频 | 关键剧情不卡顿 |
| 夜间大部分NPC在室内 | 降到最低频 | 他们在睡觉 |
| Dave夜间巡逻 | 维持正常频率 | 他是守夜人 |
| 叙事高潮（stage 3末期） | 所有NPC提升到高频 | 最终抉择需要所有人参与 |

---

## 4. 道具系统机制规则

### 4.1 道具分类

| 分类 | 说明 | 示例 |
|------|------|------|
| **普通道具** | 日常工具/材料/消耗品 | 矿镐、草药、食物、矿石 |
| **特殊道具** | 11件塔罗对应道具，有正用/逆用 | 愚者之囊、守夜人之灯等 |
| **法阵材料** | 法阵修复/重铸专用 | 结界矿石、法阵组件 |
| **线索物品** | 叙事线索的物理载体 | 老照片、工作日志、地图碎片 |

### 4.2 特殊道具规则

**获取**：
- 每件特殊道具有特定的获取条件（时间+信任+探索）
- 部分道具需要完成支线才能获得
- 不是所有道具在所有周目都可获得

**使用限制**：
- 正用和逆用**互斥**——对同一个道具的同一次使用只能选一种
- 每件道具有**使用次数/耐久度**（见下表），不是无限使用
- 部分道具使用后有冷却时间

**Trade-off 实现**：
- 每次使用在系统中记录，trade-off效果立即生效
- trade-off是**不可逆的**——不能通过其他方式消除负面效果
- 这迫使玩家权衡每次使用

### 4.3 特殊道具参数

| 道具 | 获取时间 | 使用次数 | 冷却 | 正用效果值 | 逆用效果值 |
|------|---------|---------|------|-----------|-----------|
| 愚者之囊 | 开局即有 | 正用5次/逆用3次 | 3天 | 信任+5, 线索揭示+1 | 目标NPC信任-10 |
| 无尽之线 | 信任40+拜访陈婆 | 正用3次/逆用2次 | 7天 | 揭示法阵图案 | 目标NPC失去1段记忆 |
| 父亲的矿镐 | 探索废弃矿山 | 正用无限/逆用3次 | 1天 | 采掘结界矿石 | 结界-10%耐久 |
| 守夜人之灯 | 信任70+Dave赠予 | 正用7次/逆用2次 | 1天 | 照亮隐藏线索 | God感知-1区域 |
| 倒悬的怀表 | 探索爷爷小屋 | 正用5次/逆用5次 | 3天 | 查看过去残影 | 加速区域时间 |
| 不灭之灶 | 不可移动/原地使用 | 正用无限/逆用3次 | 1天 | 治愈食物 | 消除公共记忆 |
| 锁链之契 | stage 3法阵核心 | 正用1次/逆用3次 | — | 临时加固结界 | 获得恶魔力量 |
| 不指北的罗盘 | 与Marco深入对话 | 正用5次/逆用1次 | 1天 | 指向结界薄弱点 | 强制觉醒1个NPC |
| 星光蜡笔 | Lily赠予（信任50+） | 正用无限/逆用5次 | — | 预言画 | 临时保护符文 |
| 半张地图 | 信任60+Alice给出 | 正用无限/逆用2次 | — | 月光下显示路径 | 隐藏一个区域 |
| 无名之砧 | 不可移动/原地使用 | 正用无限/逆用1次 | — | 法阵组件效果x2 | 释放结界能量（不可逆） |

### 4.4 道具组合

部分道具可以组合使用产生特殊效果：

| 组合 | 效果 | 条件 |
|------|------|------|
| 半张地图 + 锻造笔记（Erik箱子） | 合成完整地图，精确定位法阵核心 | 两件都获取后自动合成 |
| 守夜人之灯 + 不指北的罗盘 | 同时使用可以看到完整的结界轮廓 | 两件都在背包中，夜间在边界使用 |
| 无尽之线 + 无名之砧 | 在铁砧上用线编织=制作新型法阵组件 | 隐藏结局1路径专用 |
| 愚者之囊 + 倒悬的怀表 | 在法阵核心放置=情感锚点（结局2需要） | 隐藏结局2路径专用 |
| 星光蜡笔 + 半张地图 | Lily在地图上画画=补全缺失的路径 | 两件都获取后，让Lily画 |

---

## 5. 结局解锁条件具体化

### 5.1 正常结局

```python
ENDING_NORMAL = {
    "name": "轮回",
    "conditions": {
        "secret_stage": 3,
        "min_trust": 50,
        "core_clues_found": ["map", "forge", "ritual"],  # 至少3条核心线索
        "has_materials": True,  # 拥有结界矿石+法阵组件
        "final_choice": "reinforce",
    },
    "unlock_requirement": None,  # 首次可达
}
```

**具体步骤**：
1. 获取半张地图 + 找到锻造笔记 → 合成完整地图
2. 用父亲的矿镐或普通工具采集结界矿石
3. Erik在铁砧上锻造新法阵组件
4. Carol准备仪式材料
5. 在法阵核心放置材料 → 触发最终选择 → 选"加固法阵"

### 5.2 隐藏结局1：新交易

```python
ENDING_HIDDEN_1 = {
    "name": "新交易",
    "conditions": {
        "secret_stage": 3,
        "min_trust": 90,
        "all_core_clues": True,           # 全部7条核心线索
        "all_hidden_clues": True,          # 全部5条隐藏线索
        "erik_notes_found": True,          # 找到锻造笔记
        "erik_box_opened": True,           # 打开地下室箱子
        "demon_contract_understood": True,  # 理解契约运作
        "final_choice": "new_path",
    },
    "unlock_requirement": "normal",  # 需要先完成正常结局
}
```

**附加条件**：
- 必须在二周目+
- Erik 必须已经用锻造笔记锻造过至少一件法阵组件
- 必须触碰过锁链之契

### 5.3 隐藏结局2：终结

```python
ENDING_HIDDEN_2 = {
    "name": "终结",
    "conditions": {
        "secret_stage": 3,
        "min_trust": 100,                 # 所有NPC最大信任
        "all_core_clues": True,
        "all_hidden_clues": True,
        "demon_true_name_complete": True,  # 6片真名碎片全部收集
        "demon_weakness_understood": True, # 理解恶魔弱点
        "grandpa_sacrifice_acknowledged": True,  # 明确知道爷爷会消失
        "final_choice": "end_all",
    },
    "unlock_requirement": "hidden_1",  # 需要先完成隐藏结局1
}
```

**真名碎片获取条件**：

| 碎片 | 来源 | 可获取周目 | 获取条件 |
|------|------|-----------|---------|
| 碎片1 | Dave的故事 | 一周目+ | 信任80+，Dave讲述"交易者的名字"故事 |
| 碎片2 | Dave的故事 | 一周目+ | 信任90+，Dave在结局前夜的最后故事 |
| 碎片3 | 陈婆的编织 | 二周目+ | 将无尽之线铺在特定法阵组件上 |
| 碎片4 | 锻造笔记 | 二周目+ | 在笔记最后一页发现隐藏的标记 |
| 碎片5 | 老井回声 | 三周目+ | 深夜在老井旁使用倒悬的怀表 |
| 碎片6 | 怀表内刻字 | 三周目+ | 怀表使用至最后一次时自动显现 |

---

## 6. 信任度与叙事阶段

### 6.1 信任度系统

**全局信任度**：0-100，代表玩家与整个村子的关系深度。

| 行为 | 信任变化 | 说明 |
|------|---------|------|
| 帮助NPC完成请求 | +5 | — |
| 赠送礼物 | +3 | 适合的礼物额外+2 |
| 积极对话 | +2 | — |
| 消极对话 | -3 | — |
| 忽略NPC请求 | -2 | — |
| 探索线索 | +5 | 发现新线索时 |
| 拜访陈婆 | +3 | 每天上限一次 |
| 和Lily玩耍 | +2 | 每天上限一次 |
| 使用道具逆用伤害NPC | -10 | — |
| 连续5天不社交 | -5 | 认知渐染副效果 |

### 6.2 叙事阶段推进条件

| 阶段 | 进入条件 | 最早到达日 |
|------|---------|-----------|
| **stage 0 → 1** | min_day >= 29 OR min_trust >= 15 | Day 29（第二季开始） |
| **stage 1 → 2** | min_day >= 57 AND min_trust >= 30 | Day 57（第三季开始） |
| **stage 2 → 3** | min_day >= 85 AND min_trust >= 70 AND min_clues >= 3 | Day 85（第四季开始） |
| **强制 stage 3** | min_day >= 168（天灾自动临界） | Day 168（第6季） |

### 6.3 核心线索列表

| ID | 名称 | 关联角色 | 类型 |
|----|------|---------|------|
| mine | 废弃矿山 | Bob | 核心 |
| pact | 恶魔契约 | Dave | 核心 |
| isolation | 村子的桎梏 | Marco | 核心 |
| grandpa | 爷爷的身份 | Dave, 陈婆, Bob | 核心 |
| ritual | 守护仪式 | Carol, Dave | 核心 |
| map | 法阵地图 | Alice | 核心 |
| forge | 法阵组件 | Erik, Dave | 核心 |
| forge_notes | 锻造笔记 | Erik | 隐藏 |
| guardian_sight | 守护者的存在 | Lily, 陈婆 | 隐藏 |
| time_warp | 时间扭曲 | Marco | 隐藏 |
| weaving | 法阵图案 | 陈婆 | 隐藏 |
| demon | 恶魔与代价 | Dave | 隐藏 |

---

> 本文档定义游戏机制参数。数值可在 `config_narrative.py` 中调整。叙事内容以 narrative-design.md 为准。
