# 战斗系统设计文档

> 本文档定义 AgentHome 的战斗机制与技能系统。
> 游戏机制数值见 [game-design.md](game-design.md)，叙事设计见 [narrative-design.md](narrative-design.md)。

---

## 目录

1. [设计原则](#1-设计原则)
2. [战斗总体结构](#2-战斗总体结构)
3. [回合顺序与参与者](#3-回合顺序与参与者)
4. [玩家行动系统](#4-玩家行动系统)
5. [特殊道具使用](#5-特殊道具使用)
6. [NPC盟友系统](#6-npc盟友系统)
7. [实体（敌人）系统](#7-实体敌人系统)
8. [God在战斗中的角色](#8-god在战斗中的角色)
9. [技能系统](#9-技能系统)
10. [特殊商人与仪式地点](#10-特殊商人与仪式地点)

---

## 1. 设计原则

**战斗是白天关系建设的兑现时刻。**

白天与 Bob 建立信任，夜晚战斗中他会挡在你前面。白天听 Dave 讲故事，夜晚战斗中那些"听不懂的话"突然变成操作指引。战斗不是独立的挑战系统——它是角色关系的考验场。

**战斗系统服务叙事，不主导叙事。**

失败不会 Game Over，而是付出叙事代价（守护者消耗力量救回，或 NPC 受伤）。战斗的目的是制造紧张感和选择压力，不是反复死亡循环。

**每一个选择都有代价——机制层面也是。**

道具正逆用的取舍、技能购买的扭曲实现、God介入的消耗，都是恶魔哲学在机制层面的体现：没有免费的东西，账单总会来。

---

## 2. 战斗总体结构

### 进入与退出

- **触发条件**：夜晚在特定区域遭遇实体（随叙事阶段出现频率递增）
- **进入战斗**：主世界**立即暂停**——世界时钟停止，所有 NPC 的思考循环暂停
- **退出战斗**：实体被驱散/逃跑/对话结束 → 主世界**恢复运行**
- **失败处理**：玩家 HP 归零 → God 消耗守护力量强制救回（有上限次数），或 NPC 盟友拼死保护（关系代价）

### 为何选择回合制

LLM 推理延迟无法保证实时响应，回合制让每个参与者（尤其是 NPC Agent）都有充足的决策时间，避免本地模型或网络延迟导致体验崩溃。同时，"选择—等待—结果"的回合节奏与"决定—代价—后果"的叙事节奏天然一致。

---

## 3. 回合顺序与参与者

```
每回合：
① 玩家行动
② NPC 盟友行动（LLM 驱动，按信任度排序）
③ 实体行动（规则引擎，无 LLM）
④ God 响应（条件触发：旁白 / 沉默 / 紧急介入）
```

| 参与者 | 决策方式 | 说明 |
|--------|---------|------|
| **玩家** | 玩家输入 | 行动菜单 + 自由输入 |
| **NPC 盟友** | LLM（NPCCombatAction） | 基于人格+信任度+战场状态 |
| **实体** | 规则引擎 | 按叙事阶段和实体类型硬编码 |
| **God** | 条件触发 | 通常沉默；特定条件下旁白或介入 |

---

## 4. 玩家行动系统

每回合玩家从以下行动类型中选择一项：

| 行动 | 说明 |
|------|------|
| **使用道具** | 11 件特殊道具，God 提供选项，见第 5 节 |
| **使用技能** | 从已装备的 4 个技能槽中选择，见第 9 节 |
| **询问实体** | 对特定实体发起对话，可能获得叙事线索 |
| **普通攻击** | 使用手头工具（矿镐/剪刀等），低伤害，无代价 |
| **撤退** | 尝试逃离，不保证成功，可能触发特殊叙事 |

### 询问行动

并非所有实体都响应对话。可对话的实体在对话中可能透露线索，也可能是陷阱。God Agent 在此阶段可以生成"感觉像玩家自己会说的话"的对话选项建议，植入引导——玩家不知道这是 God 在干预。

| 实体类型 | 可对话 | 可能结果 |
|---------|--------|---------|
| 暗影浮游 | 否 | 无响应 |
| 裂隙蠕虫 | 否 | 只会攻击 |
| 红雪精 | 是 | 透露结界受损区域的记忆碎片 |
| 深层回声 | 是 | 可能透露契约片段；也可能是诱骗 |

---

## 5. 特殊道具使用

### 流程

```
1. 玩家选择使用某件特殊道具
2. God 提供 3 个具体意图建议（基于当前战场情境）
3. 玩家选其一 / 或自由输入自己的意图
4. God 评估意图 → 宣告效果描述 + 代价（如有）
5. 玩家确认 → 执行
   玩家取消 → 本回合改选其他行动
```

**关键原则：代价先宣告，玩家再确认。**代价不是惩罚，是交易条款。玩家有权拒绝。

### 示例（使用"不指北的罗盘"）

```
God：罗盘在你手中颤抖。你想用它做什么？

建议①：指向这个实体的弱点核心
建议②：指向最近的法阵节点（可能驱散它）
建议③：指向它来源的方向（获得信息，不造成伤害）
自由输入：_______________

[玩家选择①]

God：可以。它的弱点在左侧。但罗盘指向它的同时，
     它也短暂感知到了你的位置。下回合它优先攻击你。

[确认 / 取消]
```

### God 的平衡原则（写入 God system prompt）

| 意图强度 | 处理方式 |
|---------|---------|
| 普通合理 | 正常生效，轻微随机性，无代价 |
| 偏强但合理 | 效果打折，或加小代价 |
| 极度强力 | 效果变形 + 等价代价宣告（玩家可拒绝） |
| 试图破坏叙事/无解行为 | God 沉默，本回合失效，不解释原因 |

---

## 6. NPC 盟友系统

### 加入条件

玩家在夜晚与 NPC 同处一个区域时，NPC 自动加入战斗。NPC 带入战斗的技能基于他们自己的技能槽（最多 4 个），战前对话中玩家可以建议 NPC 的技能选择。

### NPCCombatAction Schema

```python
class NPCCombatAction(BaseModel):
    action_type: Literal["attack", "protect_player", "use_skill",
                         "speak_to_entity", "retreat"]
    target: str           # 实体 ID 或 "player"（保护时）
    battle_line: str      # 本回合的台词（必填，哪怕只是沉默中的一个动作描述）
    reasoning: str        # 内部思考（不展示给玩家，用于后续决策一致性）
```

`battle_line` 是情感深度的来源。高压下 NPC 的台词会自然流露人格：

```
Bob（低信任度）："……"  [沉默地挡在玩家前面]
Bob（高信任度）："我不允许你碰他。"
Bob（父亲支线完成后）："父亲也是这样站着的吧……"
```

### NPC 人格驱动的战斗倾向

| NPC | 行动倾向 | 特殊触发 |
|-----|---------|---------|
| Bob | 优先保护玩家，沉默行动 | 父亲支线完成后：《父亲的重量》激活时情绪外露 |
| Alice | 先试图用草药"安抚"实体，失败再攻击 | 持有地图碎片后：能识别实体的弱点 |
| Dave | 知道弱点但只会说"你试试那个方向" | 高信任度：直接告知弱点（对他来说已是极限直白） |
| Erik | 攻击力最高，偶尔因愤怒打错目标 | 发现锻造笔记后：工具攻击有法阵加成 |
| Lily | 某些实体见到她会本能退缩 | 她能看见实体真实的"悲伤"——偶尔说出实体的来历 |
| Carol | 不参与直接战斗，提供道具/仪式效果 | — |

---

## 7. 实体（敌人）系统

实体行为完全由规则引擎驱动，**不调用 LLM**，节省 API 开销。

| 实体类型 | 出现阶段 | 威胁 | 行为逻辑 |
|---------|---------|------|---------|
| **暗影浮游** | stage 1+ | 低 | 靠近玩家就消散，无主动攻击；用于氛围 |
| **裂隙蠕虫** | stage 2+ | 中 | 优先攻击地面/建筑，对玩家追踪 |
| **红雪精** | stage 3 | 中 | 接触降低玩家认知清晰度（选项减少一回合） |
| **深层回声** | stage 3 | 高 | 法阵核心守卫；对话可能获得关键信息 |

---

## 8. God 在战斗中的角色

### 默认：沉默

战斗期间 God 通常不发旁白。这是叙事信息——玩家能感受到"爷爷在集中力量维持结界，没有余力说话"。战斗中的沉默比旁白更有重量。

### 紧急介入

**触发条件**：玩家 HP 归零 且 非鲁莽行为导致（God 判断玩家在努力但力不从心）

**效果**：当回合伤害归零，玩家以 1 HP 存活

**代价**：God 守护力量 -1（有总量上限，耗尽后无法再介入）

**旁白随叙事阶段变化**：
```
stage 0: "……小心。"
stage 2: "还不是时候……你还不能就这样。"
stage 3: "孩子——"（之后沉默）
```

### 特殊沉默触发

| 触发条件 | 原因 |
|---------|------|
| 战斗中玩家接近真相性的对话选择 | God 不知道该引导还是阻止 |
| 玩家使用道具逆用伤害 NPC | 无声的失望 |
| 隐藏结局 2 最终战结束 | 他已经不在了 |

---

## 9. 技能系统

### 核心规则

- 每个技能槽**最多装备 4 个技能**，战前选择，战中不可更换
- NPC 盟友也有各自的 4 个技能槽
- 技能从**特殊商人**处购买（见第 10 节），不可自行创造
- 技能效果由商人（恶魔）决定——可以满足你的要求，但以扭曲的方式实现

### 扭曲实现原则

恶魔不拒绝，也不欺骗——他只是字面实现你说的话：

| 玩家请求 | 扭曲实现 | 代价 |
|---------|---------|------|
| "让我无敌一回合" | 那回合无法被伤害，也无法行动。你成为石头。 | 失去一回合 |
| "让我快速移动" | 移动速度提升，但只能向前，无法后退 | 无退路 |
| "让我看穿它的弱点" | 你看见了它的弱点。它也看见了你的。 | 双向暴露 |
| "同时攻击所有方向" | 攻击散布到战场每个角落，包括盟友 | 友伤风险 |
| "造成无限伤害" | 可以。你的心脏会停跳一回合。受任何伤害即死。 | 极大代价 |

**购买流程**（购买时，不在战斗中）：
```
1. 玩家提出请求
2. 商人预览"我能给你的版本"（扭曲后的效果）
3. 商人宣告代价（用什么购买）
4. 玩家确认 → 技能进入技能库
   玩家拒绝 → 取消，无损失
```

### NPC 技能购买

NPC 在叙事里程碑后可以自行前往仪式地点购买技能，玩家可以在此之前"建议方向"：

```
[玩家与 Bob 对话]
玩家：你有没有什么是让你感到最有力量的东西？
Bob：……父亲的矿灯。黑暗里打开它，我知道我不是一个人。

[建议选项]
A. 把这种力量变成保护他人的能力
B. 把这种力量变成突破恐惧的爆发

[Bob 选 A，前往仪式地点，商人给出]
技能：《父亲的矿灯》
效果：本回合替代玩家承受所有伤害
代价：Bob 下一回合无法行动（他撑着膝盖，慢慢站起来）
Bob 购买代价：用"三天的平静入眠"换取（此后 Bob 夜里会做噩梦，关系系统有轻微变化）
```

---

## 10. 特殊商人与仪式地点

### 什么是仪式地点

爷爷与恶魔签订契约的具体位置。白天看起来只是一片荒地，有些风化的石纹，毫无神秘感。

**触发条件（三个条件同时满足）**：
1. 玩家找到爷爷留下的特定遗物或日记碎片
2. Dave 信任度达标后提到过"你爷爷去过一个地方"
3. 玩家**在夜晚**来到该地点

满足前：什么都没有。满足后的那个夜晚：商人坐在石头上，像是等了很久。

### 特殊商人的形象与性格

- 外表普通，不散发任何恶意，显得专业、中立、甚至有些无聊
- 记得爷爷：**"他的孙子。他第一次来的时候，和你站的位置一模一样。"**
- 不解释自己是谁，不主动透露任何信息
- 每次交易后会说："下次你知道在哪找我了。"

### 商人记得每笔交易

第二次访问时，商人会提及上次：

> "上次你用三天的平静换了一个保护技能。你觉得值得吗？"

他不评判，只记录。这种"被追踪"的感觉会让玩家对每次交易更慎重——他在追踪你，就像他追踪了爷爷的每一个选择。

### 购买货币类型

| 货币 | 叙事含义 | 感受 |
|------|---------|------|
| **信任度** | 用与村民的关系换取力量 | 沉重 |
| **记忆碎片** | 牺牲已发现的线索 | 残忍（主动变笨） |
| **时间**（天数加速） | 天灾提前到来 | 紧迫 |
| **God 的守护力量** | 爷爷为你付出代价 | 愧疚 |
| **个人记忆/故事** | 讲述某段往事后永久失去对应的对话选项 | 隐性代价 |

> 用"God 的守护力量"购买技能时，当天 God 的旁白会变得更虚弱、更稀少。他为你付出了代价，但没有说一个字。

---

## 11. 聊天系统（对话暂停机制）

> 相关内容详见 [game-design.md](game-design.md)。

**核心规则**：玩家与 NPC 进入对话时，主世界暂停。退出对话后恢复。

退出对话时显示：**"你们聊了大约 [X] 个小时。"**

这句话让世界保持真实感（时间确实流逝了），但不打断沉浸感（玩家不需要看着时钟跳动）。God 可以在此时发出一句简短旁白——如果他认为这次对话很重要，或者他不希望你和这个人聊太久。

---

> 本文档定义战斗机制的设计方向。具体数值（HP、伤害范围、技能冷却）在实现阶段根据测试调整，不在此预设。
