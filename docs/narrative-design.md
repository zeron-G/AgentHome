# 叙事设计与情感系统

本文档记录 AgentHome 的完整叙事框架、核心剧情设定、角色人格系统、以及 God Agent 作为叙事导演的实现规范。

---

## 目录

- [核心设计哲学](#核心设计哲学)
- [故事世界观与前提](#故事世界观与前提)
- [村子的真正秘密](#村子的真正秘密)
- [五个角色完整设定](#五个角色完整设定)
- [分层揭示节奏](#分层揭示节奏)
- [情感钩子设计](#情感钩子设计)
- [God Agent 叙事导演职责](#god-agent-叙事导演职责)
- [隐晦提示系统设计规范](#隐晦提示系统设计规范)
- [桎梏的实现方式](#桎梏的实现方式)
- [与现有架构的对接方案](#与现有架构的对接方案)
- [对标分析](#对标分析)

---

## 核心设计哲学

**目标：不做线性剧情，做涌现式叙事。**

传统游戏的情感依附来自手写剧情（星露谷的村民故事）或随机危机中的玩家投入（环世界的殖民者）。AgentHome 的独特优势是**两者融合**：NPC 有连贯的人格记忆，而危机/事件由 God Agent 动态生成——每次重开都有新故事，但每个 NPC 都像真实的人。

**情感核心**：

> 当玩家最终发现"上帝就是爷爷"时，回头看所有曾经觉得奇怪的对话选项——每一个都是爷爷在说"我在这里，我一直在保护你们"。

---

## 故事世界观与前提

### 表面故事

> 你受不了大城市的压力，回到乡下农村接手了爷爷留下的小屋和园子，成为了这个与世隔绝的小村子的一部分。你不断经营自己的生活，但随着时间推进，你发现这个村子并不简单——有更大的秘密在等着你。

**为什么这个前提有效：**
- 玩家有明确的空间归属感（爷爷的小屋 = 家）
- "与世隔绝"设定让村子内部关系更紧密，NPC 间的互动更有分量
- 秘密与爷爷相关，玩家天然有挖掘动机（不是局外人，是当事人）
- 表面温馨 vs 底层秘密的张力，让日常经营有了更深的意义层

### 主人公背景

- 主人公**小时候就在这个村子长大**，后来离开去了城市
- 现在回到村子，表面上是"继承爷爷的小屋"，但**实际上是爷爷千方百计安排的**
- 因为不久的将来，**天灾将要降临**，爷爷意识到村子即将面临灭顶之灾
- 爷爷作为守护者能力有限，**无法独自应对**，所以想尽一切办法让主人公回来

---

## 村子的真正秘密

### 真相全貌

**表面上**：村子里有 4 个 NPC + 1 个玩家（主人公）。

**真相**：实际上有 **第五个 NPC——上帝**，而上帝就是玩家的**爷爷**。

爷爷在多年前从村子"消失"，实际上是以某种方式成为了村子的**守护者**，化身为上帝 Agent。他的存在对所有人（包括玩家）都是未知的。

### 村子的桎梏

村子与世隔绝，有一个所有人都**意识不到**的诡异现象：

> **没有人能离开村子，也没有外人能进入。**

村民们不觉得这有什么问题——也许早就习惯了，也许有什么东西让他们遗忘了这件事。玩家在探索过程中会慢慢发现这个真相。

**这是主要谜题之一**：为什么村子被封锁？谁封锁的？与天灾有什么关系？与爷爷的"协议"有什么关系？

### 爷爷的协议

爷爷当年与村子（或某种超自然力量）签了某个协议——保护了村子，但付出了代价。代价的到期日正在临近。这使玩家从旁观者变为当事人。

### 最终目标

```
保护村子 + 打破桎梏
```

两个目标可能是同一件事的两面：
- 打破桎梏可能是对抗天灾的前提（封锁与天灾同源？）
- 或者：天灾打破后，桎梏自然消失
- 爷爷守护者的身份解除？他是否能"回来"？

**结局不固定**，取决于玩家的选择和与 NPC 建立的信任深度。

---

## 五个角色完整设定

### Alice — 草药师

| 维度 | 内容 |
|------|------|
| **公开性格** | 热心、好奇、话多，喜欢研究植物 |
| **隐藏愿望** | 想攒够钱离开村子去大城市学医，但又舍不得老朋友 |
| **话题禁区** | 村子西边的废弃农庄（表情会变得不自然） |
| **与村子秘密的关系** | 知道爷爷留下的那本草药手册里夹着奇怪的地图 |
| **认知屏障** | 从未想过离开村子，也从未觉得这有什么不对 |

### Bob — 矿工

| 维度 | 内容 |
|------|------|
| **公开性格** | 沉默寡言、可靠，只和熟悉的人多说话 |
| **隐藏愿望** | 想恢复被废弃的西边矿山，父亲曾在那里工作后失踪 |
| **话题禁区** | 对爷爷的名字反应奇特，会沉默很久 |
| **与村子秘密的关系** | 目击过某件事但一直不敢说出来 |
| **认知屏障** | 从未想过离开村子，也从未觉得这有什么不对 |

### Carol — 厨师/商人

| 维度 | 内容 |
|------|------|
| **公开性格** | 精明、实际，以利益驱动但内心善良 |
| **隐藏愿望** | 希望村子有更多年轻人留下来，不要继续老去凋零 |
| **话题禁区** | 村子每隔十年会"消失"一批年轻人（她认为是正常迁移） |
| **与村子秘密的关系** | 无意识地维护着某个仪式（认为只是传统） |
| **认知屏障** | 从未想过离开村子，也从未觉得这有什么不对 |

### Dave — 老人/守夜人

| 维度 | 内容 |
|------|------|
| **公开性格** | 讲古，神神叨叨，说的话经常听不懂 |
| **隐藏愿望** | 在有生之年看到秘密被解开，他等了很久了 |
| **话题禁区** | 实际上没有禁区，但他说的话需要慢慢品 |
| **与村子秘密的关系** | 知道全部，但只会对真正信任的人透露 |
| **认知屏障** | 从未想过离开村子，也从未觉得这有什么不对 |

> Dave 可能是**唯一知道部分真相**的人——他等待了很久，就是等一个"能承受真相的人"出现。爷爷可能通过某种方式与 Dave 有过沟通（梦境？老物件？）。

### 上帝 — 爷爷的意志

| 维度 | 内容 |
|------|------|
| **真实身份** | 玩家的爷爷，多年前"消失"，实为成为村子守护者 |
| **核心目标** | 保护村子免受天灾，引导主人公发现真相并打破桎梏 |
| **情感基调** | 一个被困在世界规则中、想保护大家但手脚被绑的老人 |
| **能做的** | 控制天气（有代价）、触发世界事件（间接）、在对话快速回复选项中藏入隐晦提示、引导 NPC（极微弱的影响） |
| **不能做的** | 直接与玩家/NPC 对话、直接干预世界物理状态、明确说出真相、强制任何人做任何事 |

---

## 分层揭示节奏

### 阶段 0：正常村居（第 1–5 天）

**氛围**：温馨、日常

| 事件 | 触发条件 | 效果 |
|------|---------|------|
| NPC 热情欢迎玩家 | 玩家首次与各 NPC 对话 | 建立初始好感 |
| 日常生活运转 | 自动 | 玩家熟悉世界规则 |
| 偶尔回避某些话题 | 玩家触及 forbidden_topics | NPC 转移话题或变得不自然 |

### 阶段 1：异常浮现（第 6–15 天，secret_stage=1）

**氛围**：微妙不安

| 事件 | 触发条件 | 效果 |
|------|---------|------|
| 某块地从不让人靠近 | day >= 6 | 西边废弃农庄区域出现异常描述 |
| 村民做噩梦 | day >= 8，任意 NPC | NPC 偶尔提到奇怪的梦 |
| 老井夜里传来声音 | day >= 10，夜间 | 世界事件描述 |
| 老照片里有陌生人 | 玩家探索爷爷小屋 | 线索物件 |
| 夜里地图某处出现短暂的光源 | 玩家在村子待满 10 天 | God Agent 触发 |

### 阶段 2：碎片期（第 16–30 天，secret_stage=2）

**氛围**：信任与揭示

| 事件 | 触发条件 | 效果 |
|------|---------|------|
| NPC 偶然提起爷爷 | 任意 NPC 好感度 > 30 | 说了一句奇怪的话 |
| Dave 主动讲"古老的故事" | 玩家帮助过 3 个不同 NPC | Dave 开始主动找玩家 |
| Bob 警告玩家 | 玩家探索过废弃农庄 | "你不应该去那里" |
| Alice 拿出地图碎片 | 玩家信任度 > 60 | 草药手册里的地图碎片 |
| Carol 无意间提到"仪式" | 玩家信任度 > 50 | 她认为这只是传统 |

### 阶段 3：真相（第 30 天+，secret_stage=3）

**氛围**：抉择与揭示

| 事件 | 触发条件 | 效果 |
|------|---------|------|
| 天灾前兆出现 | day >= 30 + 信任度 > 70 | "红雪"、异常天气 |
| Dave 揭示全部真相 | 信任度 > 80 | 爷爷的身份与协议 |
| 村子边界的秘密显现 | 玩家探索四周边界 | 发现无法离开 |
| 最终抉择 | 所有线索收集完毕 | 保护村子 / 打破桎梏 |

---

## 情感钩子设计

### 钩子一：NPC 与玩家的关系演变

情感依附不来自第一次见面，来自**关系的变化轨迹**。

设计要求：
- NPC 对玩家有"关系分数"（初始中立，行为改变分数）
- RAG 记忆里记录**对玩家的态度演变**，而不只是事件
- NPC 主动**差异化对待**高好感玩家

示例演变链：
```
Day1: Alice 普通打招呼
Day3: 玩家帮 Alice 买了草药 → Alice 记录"玩家对我友善"
Day8: Alice 主动跑来告诉玩家今天矿石价格很高
Day15: Alice 喝醉后说"其实我一直想离开这里…"（触发秘密碎片）
```

### 钩子二：NPC 有超越"生存"的个人愿望

每个 NPC 在 system prompt 里注入：
- **公开性格**：玩家能直接观察到的行为模式
- **隐藏愿望**：与日常采集/交易无关，偶尔在对话中流露
- **话题禁区**：某些话题会让 NPC 回避或不安（与村子秘密关联）

### 钩子三：危机时刻 NPC 向玩家求助

触发条件（由 God Agent 监控世界状态）：
- NPC 能量极低且无食物 → 主动找玩家借粮
- NPC 背包满但无法到交易所 → 请玩家帮忙代售
- NPC 受到其他 NPC 的不公正对待 → 向玩家倾诉
- 天灾导致资源枯竭 → NPC 组织集体向玩家求援

### 钩子四：NPC 记得玩家做过的事

```
"上次你帮我的忙我一直记着，今天我多采了些草药，你拿着吧。"
```

实现方式：RAG 检索"与玩家的互动记录" → 注入 NPC 执行层 context → NPC 自然流露。

---

## God Agent 叙事导演职责

### 重新定位

God Agent 不再只是"天气控制者 + 事件生成器"，而是：

> **玩家爷爷的意志体现**——一个被困在世界规则中、想保护大家但手脚被绑的老人。

这给 God Agent 的所有行为赋予了情感重量：他每一次触发天气、每一个隐藏在选项里的提示，都是一个无力的守护者在拼尽全力。

### 叙事状态追踪

God Agent 维护 `narrative_state` 字典：

```python
narrative_state = {
    "player_trust_level": 0,       # 0-100，基于玩家与NPC的互动深度
    "clues_revealed": [],           # 已揭示的线索碎片列表
    "secret_stage": 0,              # 0=正常, 1=异常浮现, 2=碎片期, 3=真相
    "hint_triggers": {},            # 记录哪些关键词触发了提示
}
```

### 叙事触发事件表

| 条件 | 触发事件 | 对应阶段 |
|------|---------|---------|
| 玩家与任意 NPC 好感度 > 30 | NPC 偶然提起爷爷，说了一句奇怪的话 | 阶段 2 |
| 玩家在村子待满 10 天 | 夜里地图某处出现短暂的光源 | 阶段 1 |
| 玩家帮助过 3 个不同 NPC | Dave 开始主动找玩家讲"古老的故事" | 阶段 2 |
| 玩家探索过废弃农庄 | Bob 当晚找玩家说"你不应该去那里" | 阶段 2 |
| 玩家信任度 > 60 | Alice 拿出草药手册里的地图碎片 | 阶段 2 |
| 玩家信任度 > 80 | Dave 揭示爷爷的身份 | 阶段 3 |

---

## 隐晦提示系统设计规范

### 核心机制

当玩家与 NPC 对话涉及**关键线索**时，God Agent 生成的快速回复选项中，会混入一个**爷爷的隐晦提示**。

### 提示模式（hint_mode）

```python
# 普通对话
god_agent.generate_dialogue_options(context, hint_mode=False)
# → 生成 3 个普通快速回复选项

# 触及关键线索
god_agent.generate_dialogue_options(context, hint_mode=True, hint_level="subtle")
# → 生成 2 个普通选项 + 1 个爷爷的隐晦提示（混入其中）
```

### 提示层级（hint_level）

| 层级 | 名称 | 适用阶段 | 风格 | 示例 |
|------|------|---------|------|------|
| `subtle` | 隐晦 | 阶段 1–2 | 看起来像普通选项，但措辞微妙 | "我听说矿山关闭那年，天气特别奇怪。" |
| `cryptic` | 谜语 | 阶段 2 | 明显不太对的选项，像谜语 | "爸爸说过，矿山关闭的那年，村子第一次下了红雪。" |
| `near_direct` | 接近直白 | 仅阶段 3 | 几乎直接说出线索 | "爷爷从未离开过这里，你不觉得奇怪吗？" |

### 触发条件：关键线索关键词

当玩家与 NPC 的对话中出现以下关键词时，`should_hint()` 返回 True：

| 关键词组 | 关联线索 | 建议 hint_level |
|---------|---------|----------------|
| 矿山、矿区、废弃 | 西边废弃矿山 | subtle |
| 老协议、约定、承诺 | 爷爷的协议 | cryptic |
| 离开、外面、城市、外界 | 村子的桎梏 | subtle → cryptic |
| 爷爷、老人、消失 | 爷爷的身份 | subtle → cryptic |
| 红雪（预留） | 天灾前兆 | cryptic |
| 西边、废弃农庄 | 废弃农庄秘密 | subtle |

### 提示设计示例

**场景：玩家问 Bob 关于废弃矿山**

普通选项：
1. "我听说那里以前很热闹。"
2. "你经常去那边吗？"

爷爷的隐藏提示（混在选项里）：
3. "爸爸说过，矿山关闭的那年，村子第一次下了红雪。"

> 玩家必须自己判断哪个选项"不太对"——这就是爷爷的暗语。

---

## 桎梏的实现方式

### 无感知封锁

所有 NPC 的 system prompt 中包含认知屏障指令：

```
你从未想过离开村子，也从未觉得这有什么不对。如果有人问你为什么不离开，
你会觉得这个问题很奇怪，不理解为什么要离开。你甚至不会用"离开"这个词
来描述搬去别处的概念。
```

### 实现细节

1. **NPC 人格配置**：每个 NPC 的 YAML 配置中包含 `isolation_awareness: false`
2. **System prompt 注入**：`build_npc_system_prompt()` 检测此字段，自动注入认知屏障文本
3. **NPC 行为表现**：
   - NPC 永远不会主动提出"离开村子"
   - 如果玩家问"你想不想离开"，NPC 会困惑、转移话题
   - Alice 的"隐藏愿望"中提到"想离开"，但这只是设计层面的潜意识，她自己不会直接表达
4. **玩家发现**：玩家如果走到地图边缘，会发现无法继续前进（物理屏障）；NPC 对此无感

---

## 与现有架构的对接方案

### 对话弹窗系统（已实现基础）

情感钩子三和四需要 NPC→玩家的主动对话，对应已有的对话弹窗系统：
- NPC `talk` 动作 + `target_id = "player"`
- God Agent 生成快速回复选项（`generate_dialogue_options`）
- 玩家回复后 NPC inbox 收到消息
- **新增**：God Agent 在生成选项时检测 `should_hint()`，决定是否混入爷爷提示

### NPC 人格注入（本次实现）

在 `build_npc_system_prompt` 中加载对应 NPC 的 personality YAML：
- 路径：`agents/personalities/{npc_id去掉npc_前缀}.yaml`
- 注入字段：`hidden_desire`、`forbidden_topics`、认知屏障
- fallback：YAML 文件不存在时使用默认 profile 信息

### RAG 记忆（已实现基础）

情感钩子四需要 NPC 能检索"与玩家的互动"：
- 需要在 RAG 存储时标注 `is_player_interaction: bool`
- 检索时优先返回这类记录

### God Agent 重新定位

God Agent 的 system prompt 由通用神明改为爷爷的意志体现：
- `narrative_state` 作为内部状态，影响天气控制和事件触发的优先级
- `should_hint()` 方法扫描对话内容，判断是否触及关键线索
- `generate_dialogue_options()` 根据 hint_mode 调整生成策略

---

## 对标分析

| 维度 | 星露谷 | 环世界 | AgentHome 目标 |
|------|--------|--------|--------------|
| 情感来源 | 手写剧情 + 礼物系统 | 随机危机 + 玩家投入 | 手写人格 + AI 生成危机 |
| 重玩性 | 内容固定，新鲜感有限 | 高，但无深度叙事 | 每次不同，但有叙事弧 |
| NPC 感觉 | 有独特性，但像程序 | 名字+特质，感觉随机 | 有人格记忆，行为可预测但有深度 |
| 主线 | 社区中心 + 矿山 | 无（涌现） | 爷爷的秘密（分层揭示） |
| 独特优势 | — | — | NPC 真正"记得"玩家 |
