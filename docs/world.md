# 🌍 世界系统

[← 返回主页](../README.md)

---

## 目录

- [世界地图](#世界地图)
- [地块类型](#地块类型)
- [资源系统](#资源系统)
- [NPC 系统](#npc-系统)
- [食物系统](#食物系统)
- [城镇与交易所](#城镇与交易所)
- [时间与天气](#时间与天气)
- [被动效果（每 Tick）](#被动效果每-tick)
- [世界生成算法](#世界生成算法)

---

## 世界地图

AgentHome 的世界是一个 **20 × 20 格** 的 2D 网格，每个格子称为 **Tile（地块）**。

```
 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19
 ┌──────────────────────────────────────────────────────────┐
0│ .  .  R  R  .  .  .  .  .  .  .  .  .  .  .  .  R  R  . │
1│ .  .  R  R  .  .  .  .  .  .  .  .  .  .  .  .  R  R  . │
2│ .  .  .  .  .  F  .  .  .  .  .  .  .  F  .  .  .  .  . │
3│ .  .  .  .  .  F  .  .  .  .  .  .  .  F  .  .  .  .  . │
4│ .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . │
5│ .  .  .  .  A  .  .  .  .  .  .  .  .  .  B  .  .  .  . │  ← NPC 初始位置
6│ .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . │
7│ .  .  .  .  .  .  F  F  .  .  .  F  F  .  .  .  .  .  . │
8│ .  .  .  .  .  .  F  F  .  .  .  F  F  .  .  .  .  .  . │
9│ .  .  .  .  .  .  .  .  .  T  T  T  .  .  .  .  .  .  . │
10│ .  .  .  .  .  .  .  .  .  T  E  T  .  .  .  .  .  .  . │  ← 交易所 (10,10)
11│ .  .  .  .  .  .  .  .  .  T  T  T  .  .  .  .  .  .  . │
12│ .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . │
13│ .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . │
14│ .  .  .  .  C  .  .  .  .  .  .  .  .  .  D  .  .  .  . │  ← NPC 初始位置
15│ .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . │
17│ .  .  R  R  .  .  .  .  .  .  .  .  .  .  .  .  R  R  . │
18│ .  .  R  R  .  .  .  .  .  .  .  .  .  .  .  .  R  R  . │
19│ .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . │
 └──────────────────────────────────────────────────────────┘

图例：  . 草地   R 岩石区   F 森林   T 城镇   E 交易所
        A/B/C/D = Alice/Bob/Carol/Dave（NPC 初始位置）
```

> 食物灌木丛（约 10 处）随机分布在草地上，每次启动位置略有不同（固定种子 seed=42）。

---

## 地块类型

| 类型 | 代码 | 颜色 | 可通行 | 说明 |
|------|------|------|--------|------|
| 草地 | `g` | `#7ec850`（绿） | ✅ | 最常见地块，可能有食物灌木丛 |
| 岩石 | `r` | `#9e9e9e`（灰） | ❌ | 含石头/矿石资源，阻挡 NPC 移动 |
| 森林 | `f` | `#3a7d44`（深绿） | ✅ | 含木头资源，NPC 可进入采集 |
| 城镇 | `o` | `#c8a87a`（棕） | ✅ | 3×3 中央区域，NPC 聚集交流的场所 |
| 交易所 | `o` + `e:1` | `#d4af37`（金） | ✅ | 城镇中心 `(10,10)`，可执行 exchange/buy_food |

> **岩石区移动限制**：`_do_move` 检查目标格是否为 `TileType.ROCK`，是则移动失败，NPC 原地不动。

---

## 资源系统

每个 Tile 可携带一个 `Resource` 对象：

```python
@dataclass
class Resource:
    resource_type: ResourceType   # 资源类型
    quantity: int                 # 当前数量
    max_quantity: int             # 自然上限
```

### 资源类型

| 类型 | 代码 | 分布位置 | 初始数量 | 上限 |
|------|------|---------|---------|------|
| 木头 `WOOD` | `w` | 森林地块 | 5–8（随机） | 10 |
| 石头 `STONE` | `s` | 岩石区 | 5–10（随机） | 10 |
| 矿石 `ORE` | `o` | 岩石区（较少） | 2–5（随机） | 5 |
| 食物 `FOOD` | `f` | 草地（随机散布） | 3–5（随机） | 5 |

### 采集规则

NPC 执行 `gather` 动作时：
- 必须站在有资源的地块上
- 每次采集 **1 个**资源，加入自身库存
- 消耗 **5 点体力**
- 资源采完后该格 `quantity = 0`，等待自然再生

### 资源再生（被动效果，每 Tick）

| 资源 | 再生时机 | 再生量 |
|------|---------|--------|
| 木头、石头、矿石 | 每 10 tick | 晴天 +1，雨天 +2 |
| 食物 | 每 15 tick | +1（不受天气影响） |

再生上限为 `max_quantity`，不会超出。

---

## NPC 系统

### NPC 基本信息

每个 NPC 拥有：

| 字段 | 类型 | 说明 |
|------|------|------|
| `npc_id` | `str` | 唯一标识，如 `npc_alice` |
| `name` | `str` | 显示名称 |
| `x, y` | `int` | 当前坐标 |
| `color` | `str` | 渲染颜色（16进制） |
| `personality` | `str` | 个性描述（注入提示词，影响行为） |
| `energy` | `int` | 当前体力（0–100） |
| `inventory` | `Inventory` | 库存（wood/stone/ore/food/gold） |
| `memory` | `AgentMemory` | AI 记忆（对话历史、笔记、收件箱） |
| `last_action` | `str` | 上次执行的动作类型 |
| `last_message` | `str` | 上次说的话（用于气泡显示） |
| `is_processing` | `bool` | 是否正在等待 LLM 响应 |

### 四个 NPC 的初始设定

| 名字 | 颜色 | 初始位置 | 个性 |
|------|------|---------|------|
| Alice | `#4CAF50`（绿） | (5, 5) | 好奇、乐于助人、喜欢探索 |
| Bob | `#2196F3`（蓝） | (14, 5) | 务实、以效率为先、善于交易 |
| Carol | `#FF9800`（橙） | (5, 14) | 有创意、乐观、喜欢与人交流 |
| Dave | `#9C27B0`（紫） | (14, 14) | 谨慎、策略性强、喜欢独立思考 |

### NPC 库存（Inventory）

```python
@dataclass
class Inventory:
    wood:  int = 0
    stone: int = 0
    ore:   int = 0
    food:  int = 0
    gold:  int = 0
```

库存无上限。`get(item)` / `set(item, value)` 方法按名称安全读写，最小值为 0（不会出现负数）。

### NPC 记忆（AgentMemory）

```python
@dataclass
class AgentMemory:
    history:        list[dict]  # LLM 对话历史（user/model 轮次）
    inbox:          list[str]   # 收到的事件摘要（每次决策后清空）
    personal_notes: str         # NPC 通过 think 动作写入的个人笔记
```

- `history` 最多保留最近 20 轮对话（避免 context 过长）
- `inbox` 在每次 LLM 调用前注入 context，调用后清空
- `personal_notes` 持久保留（不自动清空），NPC 可记录目标/计划

---

## 食物系统

### 食物获取途径

| 途径 | 动作 | 条件 |
|------|------|------|
| 野外采集 | `gather` | 站在有食物的草地上 |
| 交易所购买 | `buy_food` | 站在交易所 `(10,10)`，消耗 3 金/个 |
| NPC 间交易 | `trade` | 与相邻 NPC 协商，可交换食物 |

### 食物消耗

| 动作 | 效果 | 体力变化 |
|------|------|---------|
| `eat` | 消耗库存 1 个食物 | +30 体力（上限 100） |
| 被动进食 | 体力归零时自动触发（若有食物） | +30 体力 |

### 体力恢复对比

| 方式 | 体力回复 | 消耗 |
|------|---------|------|
| `rest`（休息） | +20 | 无 |
| `eat`（吃食物） | +30 | 库存 1 食物 |
| `sleep`（睡眠） | +50 | 无 |

### 体力消耗（被动，每 Tick）

| 时间段 | 天气 | 体力消耗/Tick |
|--------|------|-------------|
| 白天 | 晴天 | -3 |
| 白天 | 雨天/暴风 | -4 |
| 夜晚 | 任意 | -2 |

**动作消耗（主动）：**
- `move`：消耗 2–3 体力
- `gather`：消耗 5 体力
- 其他动作：无额外体力消耗

---

## 城镇与交易所

### 城镇布局

城镇位于地图中心，占据 3×3 格（x: 9–11，y: 9–11）：

```
(9,9)  (10,9)  (11,9)     ← 普通城镇地块
(9,10) (10,10) (11,10)    ← (10,10) 是交易所
(9,11) (10,11) (11,11)    ← 普通城镇地块
```

城镇地块均可通行，是 NPC 聚集和交流的核心区域。

### 交易所（Exchange）

交易所位于 `(10, 10)`，标记为 `is_exchange=True`。

**卖出资源（`exchange` 动作）：**

| 资源 | 出售价格 |
|------|---------|
| 木头 | 1 金/个 |
| 石头 | 2 金/个 |
| 矿石 | 5 金/个 |

执行条件：NPC 当前坐标必须是交易所地块（`(10,10)`）。

**购买食物（`buy_food` 动作）：**
- 价格：3 金/个食物
- 执行条件：同上，必须站在交易所

### NPC 前往交易所的策略

当前版本 NPC 无自动寻路，需多次执行 `move` 动作逐步靠近交易所。提示词中已告知：
- 交易所坐标为 `(10, 10)`
- 站在交易所时才能进行交换操作
- 金币可用于购买食物

---

## 时间与天气

### 时间系统

世界时间以 **小时** 为单位推进，每个 World Tick 推进一小时（可配置）：

| 时间段 | 小时范围 | 对体力的影响 |
|--------|---------|------------|
| 早晨 `morning` | 6–12 | 正常消耗 |
| 白天 `day` | 12–18 | 正常消耗（最高体力消耗） |
| 黄昏 `evening` | 18–22 | 正常消耗 |
| 夜晚 `night` | 22–6 | 消耗减少 |

每过 24 小时为新的一天，`world.time.day` 自增。

### 天气类型

| 天气 | 效果 |
|------|------|
| `sunny`（晴天）☀️ | 正常，资源再生 +1 |
| `rainy`（雨天）🌧️ | 体力消耗 +1/tick，资源再生 +2 |
| `storm`（暴风雨）⛈️ | 体力消耗 +1/tick，资源再生 +2，前端有更强烈的粒子效果 |

天气由上帝控制（LLM 决策或浏览器直接操作）。

---

## 被动效果（每 Tick）

`WorldManager.apply_passive(world)` 在每个 World Tick 执行：

```
1. 对每个 NPC：
   a. 根据当前时段和天气扣除体力
   b. 如果体力 <= 0 且库存有食物 → 自动吃食物（+30体力）
   c. 体力下限为 0

2. 资源再生（每 10 tick）：
   for tile in world.tiles:
       if tile has wood/stone/ore resource and quantity < max:
           quantity += (2 if rainy/storm else 1)

3. 食物再生（每 15 tick）：
   for tile in world.tiles:
       if tile has food resource and quantity < max:
           quantity += 1
```

---

## 世界生成算法

`create_world(seed=42)` 的生成步骤：

```python
rng = random.Random(seed)   # 固定随机种子，保证可复现

# 1. 初始化 20×20 草地
tiles = [[Tile(x, y, GRASS) for y in range(20)] for x in range(20)]

# 2. 四角岩石簇（各 2×2 格）
corners = [(1,1), (17,1), (1,17), (17,17)]
for (cx, cy) in corners:
    place_cluster(ROCK, cx, cy, radius=2)
    # 在岩石上放置石头/矿石资源

# 3. 八处森林（随机位置，避开城镇中心区域）
for i in range(8):
    fx, fy = rng.randint(2,17), rng.randint(2,17)
    if not near_town(fx, fy):
        place_cluster(FOREST, fx, fy, radius=1)
        # 在森林中放置木头资源

# 4. 中央城镇（3×3）
for x in range(9, 12):
    for y in range(9, 12):
        tiles[x][y] = Tile(x, y, TOWN)
tiles[10][10].is_exchange = True   # 交易所

# 5. 食物灌木丛（10处，随机草地）
for i in range(10):
    fx, fy = rng.randint(0,19), rng.randint(0,19)
    if tiles[fx][fy].tile_type == GRASS:
        tiles[fx][fy].resource = Resource(FOOD, rng.randint(3,5), 5)

# 6. 创建 4 个 NPC
npcs = [
    NPC("npc_alice", "Alice", x=5,  y=5,  color="#4CAF50", ...),
    NPC("npc_bob",   "Bob",   x=14, y=5,  color="#2196F3", ...),
    NPC("npc_carol", "Carol", x=5,  y=14, color="#FF9800", ...),
    NPC("npc_dave",  "Dave",  x=14, y=14, color="#9C27B0", ...),
]
```