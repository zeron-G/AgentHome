# AgentHome 游戏机制设计文档

> 本文档定义 AgentHome 的具体游戏机制参数，包括时间系统数值、白天/黑夜玩法区分、NPC行为频率、道具系统规则和结局解锁条件。
>
> 叙事设计见 [narrative-design.md](narrative-design.md)，角色关系见 [character-relationships.md](character-relationships.md)，战斗系统见 [battle-system.md](battle-system.md)。

---

## 目录

1. [时间系统数值](#1-时间系统数值)
2. [白天/黑夜玩法区分](#2-白天黑夜玩法区分)
3. [NPC行为频率分级](#3-npc行为频率分级)
4. [道具系统机制规则](#4-道具系统机制规则)
5. [结局解锁条件具体化](#5-结局解锁条件具体化)
6. [信任度与叙事阶段](#6-信任度与叙事阶段)
7. [对话暂停机制](#7-对话暂停机制)
8. [主世界暂停规则总览](#8-主世界暂停规则总览)

---

## 1. 时间系统数值

### 1.1 基础时间单位

| 参数 | 数值 | 说明 |
|------|------|------|
| **1 tick** | 游戏循环最小单位 | 后端每次循环处理一个 tick |
| **tick 频率** | 约 1 tick/秒（实时） | 可配置，开发阶段可加速 |
| **1 游戏小时** | 60 ticks | — |
| **1 游戏日** | 1440 ticks（24小时） | 日出=360 tick, 日落=1080 tick |
| **1 季** | 28 游戏日 | 约 40,320 ticks |
| **1 年** | 4 季 = 112 游戏日 | 约 161,280 ticks |

### 1.2 日内时间划分

| 时段 | tick 范围 | 持续 | 说明 |
|------|----------|------|------|
| **黎明 (dawn)** | 300-420 | 2小时 | 天色渐亮，NPC开始起床 |
| **白天 (day)** | 420-1020 | 10小时 | 主要活动时间 |
| **黄昏 (dusk)** | 1020-1140 | 2小时 | 过渡时段，NPC行为变化 |
| **夜晚 (night)** | 1140-300(+1d) | 10小时 | 异常层活跃 |

### 1.3 季节

| 季节 | 游戏日范围 | 对应叙事阶段 | 天气特征 |
|------|-----------|-------------|---------|
| **春·播种** | Day 1-28 | secret_stage=0 温馨田园 | 多雨、温暖，偶尔阵雨 |
| **夏·异变** | Day 29-56 | secret_stage=1 日常裂痕 | 炎热，午后闷雷，夜间闷热 |
| **秋·碎裂** | Day 57-84 | secret_stage=2 真相碎片 | 凉爽，多风，偶尔浓雾 |
| **冬·抉择** | Day 85-112 | secret_stage=3 最终选择 | 寒冷，红雪，异常天气频发 |

### 1.4 季节特殊天气

| 天气 | 最早出现 | 频率 | 叙事含义 |
|------|---------|------|---------|
| **异常闷热** | Day 29 | 夏季偶发 | 结界能量波动 |
| **红色黄昏** | Day 55 | 夏末开始，秋季增多 | 天灾前兆初现 |
| **无风暴雨** | Day 60 | 秋季偶发 | 结界不稳定 |
| **红雪** | Day 78 | 秋末首次，冬季反复 | 天灾前兆高峰 |
| **地面微震** | Day 40 | 夏季开始，频率递增 | 法阵裂缝扩大 |
| **边缘裂纹光** | Day 85 | 冬季持续 | 结界即将崩溃 |

---

## 2. 白天/黑夜玩法区分

### 2.1 白天：温馨田园模式

**核心玩法**：种田、采矿、社交、交易——标准沙盒模拟经营。

| 系统 | 白天行为 |
|------|---------|
| **种植** | 翻地、播种、浇水、收获。作物按季节生长 |
| **采矿** | 在矿区采集石头、矿石。矿镐影响效率 |
| **社交** | 与NPC对话、送礼、完成请求。建立per-NPC信任度 |
| **交易** | 在交易所买卖。供需+天气驱动的动态价格。商人白天以友好商人身份正常交易 |
| **建造** | 用材料建造家具/工具/建筑。木协助修缮 |
| **探索** | 自由探索村子各区域，发现环境叙事 |

**NPC白天行为**：展现正位特质，按 daily_routines.morning / midday 行动。

**氛围**：明亮、安全、温暖。BGM轻快。

### 2.2 黄昏：过渡带

**时间**：1020-1140 tick（日落前后2小时）

| 变化 | 描述 |
|------|------|
| **色调** | 暖黄→橙红→暗紫渐变 |
| **NPC行为** | 按 daily_routines.evening 行动。情绪更放松/更脆弱 |
| **对话解锁** | 某些深入对话只在黄昏时段可触发 |
| **异常预兆** | stage 1+ 后黄昏偶尔出现轻微异常（远处闪光、微弱低语） |

### 2.3 黑夜：异常层

**核心玩法**：探索异常、对抗威胁、发现隐藏线索。

| 系统 | 夜晚行为 |
|------|---------|
| **探索** | 法阵组件在月光/灯光下可见。废弃区域出现异常 |
| **异常实体** | 天灾渗透产生的具象化威胁（stage 1+才出现，频率随stage递增） |
| **战斗** | 使用工具/道具对抗异常实体。不是核心玩法，是叙事载体 |
| **线索收集** | 夜间专属线索：老井低语、红雪痕迹、NPC梦话、法阵光纹 |
| **NPC状态** | 大部分NPC在室内。石夜间巡山。穗偶尔做奇怪的梦。棠失眠在村边徘徊 |
| **商人夜间** | 商人出现在仪式地点，切换为"另一种交易"模式（LLM提示词变更） |

**异常实体类型**：

| 类型 | 出现阶段 | 威胁等级 | 描述 |
|------|---------|---------|------|
| **暗影浮游** | stage 1+ | 低 | 无害的黑色光点，靠近会消散。氛围营造 |
| **裂隙蠕虫** | stage 2+ | 中 | 从结界裂缝渗透的实体，会缓慢侵蚀地面 |
| **红雪精** | stage 3 | 中 | 红雪中浮现的人形轮廓，接触会降低认知清晰度 |
| **深层回声** | stage 3 | 高 | 法阵核心附近的强力实体，守卫着通往恶魔的通道 |

**战斗机制边界**：
- 战斗**不是**游戏核心——它是叙事的服务工具
- 失败不会Game Over，而是被石/God救回（消耗守护者力量）
- 战斗工具=日常工具的夜间用途（矿镐可以砸碎裂隙蠕虫，草药可以驱散暗影）
- 特殊道具在战斗中有额外效果（月亮牌驱散所有低级实体）

### 2.4 机制边界总结

| 维度 | 白天 | 黄昏 | 黑夜 |
|------|------|------|------|
| **核心玩法** | 经营/社交 | 过渡/深入对话 | 探索/战斗 |
| **NPC状态** | 正位/日常 | 过渡/脆弱 | 逆位/梦境 |
| **威胁等级** | 无 | 无 | 低→高（随stage） |
| **线索类型** | 对话/物品 | 情感/回忆 | 环境/超自然 |
| **God介入** | 旁白/天气 | 旁白变化 | 沉默或紧急干预 |
| **商人状态** | 友好商人 | 收摊观察 | 仪式地点·替代交易 |

---

## 3. NPC行为频率分级

### 3.1 分级表（三层体系）

| 级别 | 角色 | 塔罗 | 玩家视野内 | 玩家视野外 | think_interval_multiplier |
|------|------|------|-----------|-----------|--------------------------|
| **核心NPC** | 禾、穗、山、棠 | 皇后/太阳/隐者/倒吊人 | 5-10秒/次 | 30秒/次 | 1.0 |
| **日常NPC** | 旷、木、岚婆、石 | 力量/教皇/女祭司/恋人 | 15-30秒/次 | 90秒/次 | 3.0 |
| **特殊NPC** | 商人 | 恶魔 | 15秒/次 | 60秒/次 | LLM双模式 |
| **God Agent** | 爷爷（守护者） | 皇帝 | 每tick | 每tick | 独立循环 |

### 3.2 视野判定

- 玩家视野范围：以玩家位置为中心的 7x7 格子（可配置）
- NPC在视野内时使用高频思考循环
- NPC离开视野后降频，但**不停止思考**——他们在视野外也有自己的生活
- NPC在视野外积累的状态变化，在玩家重新进入视野时一次性体现

### 3.3 特殊频率规则

| 场景 | 频率调整 | 说明 |
|------|---------|------|
| NPC正在与玩家对话 | 提升到最高频 | 确保对话响应及时 |
| NPC正在执行叙事事件 | 提升到最高频 | 关键剧情不卡顿 |
| 夜间大部分NPC在室内 | 降到最低频 | 他们在睡觉 |
| 石夜间巡山 | 维持正常频率 | 他是猎人 |
| 棠夜间失眠 | 维持正常频率 | 契约的折磨 |
| 商人夜间在仪式地点 | 维持正常频率 | 等待"另一种交易" |
| 叙事高潮（stage 3末期） | 所有NPC提升到高频 | 最终抉择需要所有人参与 |

---

## 4. 道具系统机制规则

### 4.1 道具分类

| 分类 | 说明 | 示例 |
|------|------|------|
| **普通道具** | 日常工具/材料/消耗品 | 矿镐、草药、食物、矿石 |
| **塔罗道具** | 11件塔罗对应道具，有正用/逆用/代价 | 愚者之囊、月亮牌等 |
| **法阵材料** | 法阵修复/重铸专用 | 结界矿石、法阵组件 |
| **线索物品** | 叙事线索的物理载体 | 老照片、工作日志、地图碎片 |

### 4.2 塔罗道具规则

**11件塔罗道具** — 每件对应一个角色的tarot_item：

| 道具 | 塔罗牌 | 持有角色 | 正用 | 逆用 | 代价 |
|------|--------|---------|------|------|------|
| **愚者之囊** | 0 愚者 | 主角 | 打开：获得随机线索 | 倒出：扰乱NPC记忆 | 每次使用让持有者失去一段近期记忆 |
| **魔术师之杖** | I 魔术师 | 石 | 幻术：创造虚像迷惑实体 | 欺术：对NPC使用让对方相信谎言 | 使用者自身也开始分不清真假 |
| **月亮牌** | XVIII 月亮 | 岚婆 | 照见：驱散暗影，显示隐藏线索 | 遮蔽：让区域陷入迷雾 | 使用者直觉暂时失灵（3天） |
| **星星瓶** | XVII 星星 | 禾 | 治愈：恢复体力和创伤 | 希望幻觉：让NPC看见虚假的美好未来 | 瓶内光芒每次使用减弱 |
| **节制天秤** | XIV 节制 | 木 | 平衡：法阵组件精度翻倍 | 失衡：让木的修缮出错（破坏法阵） | 天秤倾斜后需要7天才能恢复 |
| **战车旗** | VII 战车 | 旷 | 冲锋：暂时无视疲劳全力行动 | 蛮力：强行打开封锁的区域 | 使用后精疲力竭（体力归零） |
| **审判号角** | XX 审判 | 穗 | 唤醒：暂时削弱周围NPC的认知屏障 | 审判：让NPC直面自己的forbidden_topic | 使用者承受所有NPC被唤醒时的痛苦 |
| **命运之轮** | X 命运之轮 | 山 | 回溯：查看本轮回的某个过去场景 | 快进：预见即将发生的事件 | 每次使用消耗守护者力量 |
| **塔** | XVI 塔 | 棠 | 崩塌：摧毁一处结界节点 | 重建：用自身为代价修复结界 | 棠的"吊在两界之间"的代价生效 |
| **正义之剑** | XI 正义 | 商人 | 契约：与恶魔建立新契约（条款清晰） | 裁决：强制终止一个已有契约 | 所有契约都是自愿的——代价由恶魔决定执行方式 |
| **死神之镰** | XIII 死神 | 爷爷(God) | 终结：彻底解除结界（爷爷消散） | 转化：将结界能量转化为其他形式 | 不可逆——使用即是爷爷的最终选择 |

### 4.3 塔罗道具获取条件

获取条件基于 per-NPC 信任度 + 叙事阶段 + 特定事件：

| 道具 | 获取条件 | 最早可得 |
|------|---------|---------|
| 愚者之囊 | 开局即有 | Day 1 |
| 魔术师之杖 | 石信任60+，他在山里"偶然找到"交给你 | Day 29+ |
| 月亮牌 | 岚婆信任50+，一次"真正的通灵"后赠予 | Day 29+ |
| 星星瓶 | 禾信任70+，讲述丈夫死因后交出 | Day 57+ |
| 节制天秤 | 木信任60+，看到工具上的符号发光后给你 | Day 57+ |
| 战车旗 | 旷信任40+，一次冒险探索后他"发现的" | Day 29+ |
| 审判号角 | 穗信任70+，她画的画变成实物 | Day 57+ |
| 命运之轮 | 山信任90+，stage 3开始后山主动交出 | Day 85+ |
| 塔 | 棠信任80+，棠自我暴露契约后交出 | Day 85+ |
| 正义之剑 | 与商人夜间完成3次交易后商人"赠予" | Day 57+ |
| 死神之镰 | 触发觉醒结局条件后自动出现 | Day 85+ |

### 4.4 道具组合

部分道具可以组合使用产生特殊效果：

| 组合 | 效果 | 条件 |
|------|------|------|
| 月亮牌 + 命运之轮 | 看到完整的轮回历史 | 同时使用在法阵核心 |
| 审判号角 + 塔 | 强制觉醒所有NPC同时摧毁一处结界 | 觉醒结局路径 |
| 正义之剑 + 死神之镰 | 终结契约+终结结界=真结局路径 | 真结局专用 |
| 愚者之囊 + 星星瓶 | 治愈线索碎片=完整记忆恢复 | 任意NPC的记忆恢复 |
| 节制天秤 + 魔术师之杖 | 幻术精确化=创造完美法阵幻像 | 推翻结局辅助 |

---

## 5. 结局解锁条件具体化

### 5.1 结局1：失败

**触发**：冬季结束（Day 112）时条件不满足任何其他结局。

| 条件 | 值 |
|------|---|
| secret_stage | 未达到 3 |
| 或 clues_revealed | < 3 |
| 或 average_trust | < 30 |

**结果**：结界崩溃，天灾降临，村子消失。爷爷的力量用尽。

### 5.2 结局2：巩固

| 条件 | 值 |
|------|---|
| secret_stage | >= 3 |
| 核心NPC平均信任 | >= 50 |
| clues_revealed | >= 3 条核心线索 |
| 拥有法阵材料 | True |
| 最终选择 | "加固法阵" |

**结果**：主角接受爷爷的逻辑，加固结界。村子继续被封锁，但安全了。轮回重复。

### 5.3 结局3：推翻

| 条件 | 值 |
|------|---|
| secret_stage | >= 3 |
| 核心NPC平均信任 | >= 60 |
| clues_revealed | >= 5 条线索 |
| 理解结界本质 | True |
| 最终选择 | "打破结界" |

**结果**：主角打破爷爷的结界，拥抱危险的自由。爷爷灵魂解放。

### 5.4 结局4A：替代（新守护者）

**前置**：必须先完成巩固或推翻结局。

| 条件 | 值 |
|------|---|
| secret_stage | >= 3 |
| 所有NPC信任 | >= 70 |
| 全部核心线索 | True |
| 理解契约机制 | True |
| 正义之剑获取 | True |
| 最终选择 | "签订新契约" |

**结果**：主角签了和爷爷一样的契约，成为新的守护者。轮回重复，但守护者换了人。

### 5.5 结局4B：扭曲的自由

**前置**：必须先完成巩固或推翻结局。

| 条件 | 值 |
|------|---|
| secret_stage | >= 3 |
| 所有NPC信任 | >= 70 |
| 全部核心线索 | True |
| 理解恶魔代价 | True |
| 最终选择 | "以代价换自由" |

**结果**：获得了自由，但代价是失去感受爱的能力。没有旁白——只有风声。

### 5.6 结局5：觉醒

| 条件 | 值 |
|------|---|
| secret_stage | >= 3 |
| 所有NPC信任 | >= 80 |
| 全部线索（核心+隐藏） | True |
| 命运之轮获取 | True |
| 发现轮回存在 | True |
| 最终选择 | "看见轮回" |

**结果**：主角发现了命运之轮，意识到轮回的存在。获得"存档意识"——下一轮带着记忆回来。

### 5.7 真结局：世界

**前置**：必须先完成所有其他6个结局。

| 条件 | 值 |
|------|---|
| endings_unlocked | 包含前6个结局 |
| 全部线索 | True |
| 全部塔罗道具 | 至少使用过9件 |
| 最终选择 | "打破第四面墙" |

**结果**：所有角色觉醒为游戏角色。第四面墙碎裂。所有人以新的愚者身份重新开始。

---

## 6. 信任度与叙事阶段

### 6.1 Per-NPC信任度系统

每个NPC拥有独立的信任度（0-100），初始值50。

| 行为 | 信任变化 | 说明 |
|------|---------|------|
| 帮助NPC完成请求 | +5（对应NPC） | — |
| 赠送合适礼物 | +3~+5（对应NPC） | 因NPC而异 |
| 积极对话 | +2（对应NPC） | — |
| 消极对话 | -3（对应NPC） | — |
| 忽略NPC请求 | -2（对应NPC） | — |
| 发现新线索 | +3（相关NPC） | — |
| 使用道具逆用伤害NPC | -10（对应NPC），-3（其他NPC） | 连带效应 |
| 连续5天不与某NPC互动 | -2（该NPC） | 关系淡化 |

**NPC特殊信任事件**：

| NPC | 特殊事件 | 信任变化 |
|-----|---------|---------|
| 禾 | 帮照顾穗 | +5 |
| 穗 | 一起画画/玩耍 | +3 |
| 山 | 耐心听他的谜语 | +5 |
| 棠 | 不追问他的秘密 | +3 |
| 旷 | 一起冒险探索 | +5 |
| 木 | 帮忙搬运重物 | +3 |
| 岚婆 | 认真对待她的占卜 | +3 |
| 石 | 帮他修理猎具 | +3 |
| 商人 | 完成夜间交易 | +5（但可能有隐性代价） |

### 6.2 叙事阶段推进条件

| 阶段 | 进入条件 | 最早到达日 |
|------|---------|-----------|
| **stage 0 → 1** | min_day >= 29 OR 任意核心NPC信任 >= 60 | Day 29（夏·异变开始） |
| **stage 1 → 2** | min_day >= 57 AND 核心NPC平均信任 >= 40 | Day 57（秋·碎裂开始） |
| **stage 2 → 3** | min_day >= 85 AND 核心NPC平均信任 >= 70 AND clues >= 5 | Day 85（冬·抉择开始） |
| **强制 stage 3** | min_day >= 168（天灾自动临界） | Day 168（第6季） |

### 6.3 线索列表

| ID | 名称 | 关联角色 | 类型 |
|----|------|---------|------|
| barrier_edge | 结界边缘 | 棠、石 | 核心 |
| soul_contract | 灵魂契约 | 山、商人 | 核心 |
| grandpa_trace | 爷爷的痕迹 | 山、穗 | 核心 |
| cognitive_fog | 认知迷雾 | 禾、木 | 核心 |
| array_maintenance | 法阵维护 | 木、山 | 核心 |
| ritual_truth | 仪式真相 | 岚婆、木 | 核心 |
| sui_perception | 穗的感知 | 穗 | 隐藏 |
| tang_deal | 棠的交易 | 棠、商人 | 隐藏 |
| lan_intuition | 岚婆的直觉 | 岚婆 | 隐藏 |
| merchant_identity | 商人身份 | 商人、山 | 隐藏 |
| he_husband_death | 禾丈夫之死 | 禾、山 | 隐藏 |
| reincarnation | 轮回 | 山 | 轮回线索 |

---

## 7. 对话暂停机制

### 核心规则

玩家与任意 NPC 开始对话时，主世界**立即暂停**：

- 世界时钟停止计时
- 所有其他 NPC 的思考循环暂停
- 市场价格、天气变化、事件触发全部冻结
- 对话期间只有当前 NPC 的 Agent 处于活跃状态

退出对话后，主世界**恢复运行**，同时显示：

> **"你们聊了大约 [X] 个小时。"**

### God 对对话时长的反应

| 情境 | God 旁白方式 |
|------|------------|
| 普通对话 | 通常沉默，偶尔一句轻描淡写 |
| 与山长谈 | 复杂——山知道一切，God不确定该引导还是阻止 |
| 与棠深入聊天（stage 2+） | **紧张**——棠可能暴露他与恶魔的交易 |
| 与穗玩耍 | 温柔，偶尔流露出一种说不清的惆怅——穗能感觉到他 |
| 与商人夜间交易 | **沉默**——God无法干预契约 |
| 与岚婆占卜 | 不安——她的直觉有时绕过结界 |

### 对话时长的叙事意义

对话中流逝的时间记入世界时钟。长时间聊天意味着：
- 今天的田地来不及浇水
- 夜晚来得更快（如果接近日落时段）
- 其他 NPC 在这段时间里独自完成了自己的日常（世界不等人）

---

## 8. 主世界暂停规则总览

三种游戏模式会触发主世界暂停，形成统一的"脱离主世界"体验：

| 触发 | 模式 | 主世界 | 说明 |
|------|------|--------|------|
| 与 NPC 开始对话 | **对话模式** | ⏸ 暂停 | 只有当前 NPC Agent 活跃 |
| 遭遇夜间实体 | **战斗模式** | ⏸ 暂停 | 见 [battle-system.md](battle-system.md) |
| 与商人夜间交易 | **交易模式** | ⏸ 暂停 | 商人的时间与世界无关 |

退出任意模式后，世界恢复运行，显示已流逝时间。

---

> 本文档定义游戏机制参数。数值可在 `config_narrative.py` 中调整。叙事内容以 narrative-design.md 为准。战斗机制以 battle-system.md 为准。
